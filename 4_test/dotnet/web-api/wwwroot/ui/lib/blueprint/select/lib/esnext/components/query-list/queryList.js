import*as React from"react";import{AbstractComponent2,DISPLAYNAME_PREFIX,Keys,Menu,Utils}from"@blueprintjs/core";import{executeItemsEqual,getActiveItem,getCreateNewItem,isCreateNewItem,renderFilteredItems}from"../../common";export class QueryList extends AbstractComponent2{constructor(e,t){super(e,t),this.refHandlers={itemsParent:e=>this.itemsParentRef=e},this.shouldCheckActiveItemInViewport=!1,this.expectedNextActiveItem=null,this.isEnterKeyPressed=!1,this.renderItemList=e=>{const{initialContent:t,noResults:s}=this.props,i=e.renderCreateItem(),r=renderFilteredItems(e,null!=i?null:s,t);if(null==r&&null==i)return null;const n=this.isCreateItemFirst();return React.createElement(Menu,{ulRef:e.itemsParentRef},n&&i,r,!n&&i)},this.renderItem=(e,t)=>{if(!0!==this.props.disabled){const{activeItem:s,query:i}=this.state,r=this.state.filteredItems.indexOf(e)>=0,n={active:executeItemsEqual(this.props.itemsEqual,getActiveItem(s),e),disabled:isItemDisabled(e,t,this.props.itemDisabled),matchesPredicate:r};return this.props.itemRenderer(e,{handleClick:t=>this.handleItemSelect(e,t),index:t,modifiers:n,query:i})}return null},this.renderCreateItemMenuItem=()=>{if(this.isCreateItemRendered()){const{activeItem:e,query:t}=this.state,s=t.trim(),i=e=>{this.handleItemCreate(s,e)},r=isCreateNewItem(e);return this.props.createNewItemRenderer(s,r,i)}return null},this.handleItemCreate=(e,t)=>{const s=this.props.createNewItemFromQuery?.(e);null!=s&&(this.props.onItemSelect?.(s,t),this.maybeResetQuery())},this.handleItemSelect=(e,t)=>{this.setActiveItem(e),this.props.onItemSelect?.(e,t),this.maybeResetQuery()},this.handlePaste=e=>{const{createNewItemFromQuery:t,onItemsPaste:s}=this.props;let i;const r=[],n=[];for(const s of e){const e=getMatchingItem(s,this.props);if(void 0!==e)i=e,n.push(e);else if(this.canCreateItems()){const e=t?.(s);void 0!==e&&n.push(e)}else r.push(s)}this.setQuery(r.join(", "),!1),void 0!==i&&this.setActiveItem(i),s?.(n)},this.handleKeyDown=e=>{const{keyCode:t}=e;if(t===Keys.ARROW_UP||t===Keys.ARROW_DOWN){e.preventDefault();const s=this.getNextActiveItem(t===Keys.ARROW_UP?-1:1);null!=s&&this.setActiveItem(s)}else t===Keys.ENTER&&(this.isEnterKeyPressed=!0);this.props.onKeyDown?.(e)},this.handleKeyUp=e=>{const{onKeyUp:t}=this.props,{activeItem:s}=this.state;e.keyCode===Keys.ENTER&&this.isEnterKeyPressed&&(e.preventDefault(),null==s||isCreateNewItem(s)?this.handleItemCreate(this.state.query,e):this.handleItemSelect(s,e),this.isEnterKeyPressed=!1),t?.(e)},this.handleInputQueryChange=e=>{const t=null==e?"":e.target.value;this.setQuery(t),this.props.onQueryChange?.(t,e)};const{query:s=""}=e,i=e.createNewItemFromQuery?.(s),r=getFilteredItems(s,e);this.state={activeItem:void 0!==e.activeItem?e.activeItem:e.initialActiveItem??getFirstEnabledItem(r,e.itemDisabled),createNewItem:i,filteredItems:r,query:s}}static ofType(){return QueryList}render(){const{className:e,items:t,renderer:s,itemListRenderer:i=this.renderItemList}=this.props,{createNewItem:r,...n}=this.state;return s({...n,className:e,handleItemSelect:this.handleItemSelect,handleKeyDown:this.handleKeyDown,handleKeyUp:this.handleKeyUp,handlePaste:this.handlePaste,handleQueryChange:this.handleInputQueryChange,itemList:i({...n,items:t,itemsParentRef:this.refHandlers.itemsParent,renderCreateItem:this.renderCreateItemMenuItem,renderItem:this.renderItem})})}componentDidUpdate(e){void 0!==this.props.activeItem&&this.props.activeItem!==this.state.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:this.props.activeItem})),null!=this.props.query&&this.props.query!==e.query?this.setQuery(this.props.query,this.props.resetOnQuery,this.props):Utils.shallowCompareKeys(this.props,e,{include:["items","itemListPredicate","itemPredicate"]})||this.setQuery(this.state.query),this.shouldCheckActiveItemInViewport&&(this.requestAnimationFrame((()=>this.scrollActiveItemIntoView())),this.shouldCheckActiveItemInViewport=!1)}scrollActiveItemIntoView(){const e=!1!==this.props.scrollToActiveItem,t=!executeItemsEqual(this.props.itemsEqual,getActiveItem(this.expectedNextActiveItem),getActiveItem(this.props.activeItem));if(this.expectedNextActiveItem=null,!e&&t)return;const s=this.getActiveElement();if(null!=this.itemsParentRef&&null!=s){const{offsetTop:e,offsetHeight:t}=s,{offsetTop:i,scrollTop:r,clientHeight:n}=this.itemsParentRef,{paddingTop:m,paddingBottom:a}=this.getItemsParentPadding(),h=e+t+a-i,l=e-m-i;h>=r+n?this.itemsParentRef.scrollTop=h+t-n:l<=r&&(this.itemsParentRef.scrollTop=l-t)}}setQuery(e,t=this.props.resetOnQuery,s=this.props){const{createNewItemFromQuery:i}=s;this.shouldCheckActiveItemInViewport=!0,e!==this.state.query&&s.onQueryChange?.(e);const r=e.trim(),n=getFilteredItems(r,s),m=null!=i&&""!==r?i(r):void 0;this.setState({createNewItem:m,filteredItems:n,query:e});const a=this.getActiveIndex(n);(t||a<0||isItemDisabled(getActiveItem(this.state.activeItem),a,s.itemDisabled))&&(this.isCreateItemRendered()&&this.isCreateItemFirst()?this.setActiveItem(getCreateNewItem()):this.setActiveItem(getFirstEnabledItem(n,s.itemDisabled)))}setActiveItem(e){this.expectedNextActiveItem=e,void 0===this.props.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:e})),isCreateNewItem(e)?this.props.onActiveItemChange?.(null,!0):this.props.onActiveItemChange?.(e,!1)}getActiveElement(){const{activeItem:e}=this.state;if(null!=this.itemsParentRef){if(isCreateNewItem(e)){const e=this.isCreateItemFirst()?0:this.state.filteredItems.length;return this.itemsParentRef.children.item(e)}{const e=this.getActiveIndex();return this.itemsParentRef.children.item(e)}}}getActiveIndex(e=this.state.filteredItems){const{activeItem:t}=this.state;if(null==t||isCreateNewItem(t))return-1;for(let s=0;s<e.length;++s)if(executeItemsEqual(this.props.itemsEqual,e[s],t))return s;return-1}getItemsParentPadding(){const{paddingTop:e,paddingBottom:t}=getComputedStyle(this.itemsParentRef);return{paddingBottom:pxToNumber(t),paddingTop:pxToNumber(e)}}getNextActiveItem(e,t=this.getActiveIndex()){return this.isCreateItemRendered()&&(0===t&&-1===e||t===this.state.filteredItems.length-1&&1===e)?getCreateNewItem():getFirstEnabledItem(this.state.filteredItems,this.props.itemDisabled,e,t)}isCreateItemRendered(){return this.canCreateItems()&&""!==this.state.query&&!this.wouldCreatedItemMatchSomeExistingItem()}isCreateItemFirst(){return"first"===this.props.createNewItemPosition}canCreateItems(){return null!=this.props.createNewItemFromQuery&&null!=this.props.createNewItemRenderer}wouldCreatedItemMatchSomeExistingItem(){return this.state.filteredItems.some((e=>executeItemsEqual(this.props.itemsEqual,e,this.state.createNewItem)))}maybeResetQuery(){this.props.resetOnSelect&&this.setQuery("",!0)}}function pxToNumber(e){return null==e?0:parseInt(e.slice(0,-2),10)}function getMatchingItem(e,{items:t,itemPredicate:s}){if(Utils.isFunction(s))for(let i=0;i<t.length;i++){const r=t[i];if(s(e,r,i,!0))return r}}function getFilteredItems(e,{items:t,itemPredicate:s,itemListPredicate:i}){return Utils.isFunction(i)?i(e,t):Utils.isFunction(s)?t.filter(((t,i)=>s(e,t,i))):t}function wrapNumber(e,t,s){return e<t?s:e>s?t:e}function isItemDisabled(e,t,s){return null!=s&&null!=e&&(Utils.isFunction(s)?s(e,t):!!e[s])}QueryList.displayName=`${DISPLAYNAME_PREFIX}.QueryList`,QueryList.defaultProps={disabled:!1,resetOnQuery:!0};export function getFirstEnabledItem(e,t,s=1,i=e.length-1){if(0===e.length)return null;let r=i;const n=e.length-1;do{if(r=wrapNumber(r+s,0,n),!isItemDisabled(e[r],r,t))return e[r]}while(r!==i&&-1!==i);return null}