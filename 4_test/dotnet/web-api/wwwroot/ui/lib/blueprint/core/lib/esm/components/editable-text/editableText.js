import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,Classes,Keys}from"../../common";import{DISPLAYNAME_PREFIX}from"../../common/props";import{clamp}from"../../common/utils";import{Browser}from"../../compatibility";var BUFFER_WIDTH_DEFAULT=5,BUFFER_WIDTH_IE=30,EditableText=function(t){function e(e,i){var n=t.call(this,e,i)||this;n.inputElement=null,n.valueElement=null,n.refHandlers={content:function(t){n.valueElement=t},input:function(t){if(null!=t&&(n.inputElement=t,n.props.alwaysRenderInput||n.inputElement.focus(),null!=n.state&&n.state.isEditing)){var e=inputSupportsSelection(t);if(e){var i=t.value.length;t.setSelectionRange(n.props.selectAllOnFocus?0:i,i)}e&&n.props.selectAllOnFocus||(t.scrollLeft=t.scrollWidth)}}},n.cancelEditing=function(){var t,e,i,s,l=n.state,a=l.lastValue,r=l.value;n.setState({isEditing:!1,value:a}),r!==a&&(null===(e=(t=n.props).onChange)||void 0===e||e.call(t,a)),null===(s=(i=n.props).onCancel)||void 0===s||s.call(i,a)},n.toggleEditing=function(){var t,e;if(n.state.isEditing){var i=n.state.value;n.setState({isEditing:!1,lastValue:i}),null===(e=(t=n.props).onConfirm)||void 0===e||e.call(t,i)}else n.props.disabled||n.setState({isEditing:!0})},n.handleFocus=function(){var t=n.props,e=t.alwaysRenderInput,i=t.disabled,s=t.selectAllOnFocus;if(i||n.setState({isEditing:!0}),e&&s&&null!=n.inputElement){var l=n.inputElement.value.length;n.inputElement.setSelectionRange(0,l)}},n.handleTextChange=function(t){var e,i,s=t.target.value;null==n.props.value&&n.setState({value:s}),null===(i=(e=n.props).onChange)||void 0===i||i.call(e,s)},n.handleKeyEvent=function(t){var e=t.altKey,i=t.ctrlKey,s=t.metaKey,l=t.shiftKey,a=t.which;if(a!==Keys.ESCAPE){var r=e||i||s||l;a===Keys.ENTER&&((e||l)&&t.preventDefault(),n.props.confirmOnEnterKey&&n.props.multiline?null!=t.target&&r?(insertAtCaret(t.target,"\n"),n.handleTextChange(t)):n.toggleEditing():n.props.multiline&&!r||n.toggleEditing())}else n.cancelEditing()};var s=null==e.value?e.defaultValue:e.value;return n.state={inputHeight:0,inputWidth:0,isEditing:!0===e.isEditing&&!1===e.disabled,lastValue:s,value:s},n}return __extends(e,t),e.prototype.render=function(){var t,e,i,n=this.props,s=n.alwaysRenderInput,l=n.disabled,a=n.multiline,r=n.contentId,o=null!==(e=this.props.value)&&void 0!==e?e:this.state.value,p=null!=o&&""!==o,u=classNames(Classes.EDITABLE_TEXT,Classes.intentClass(this.props.intent),((t={})[Classes.DISABLED]=l,t[Classes.EDITABLE_TEXT_EDITING]=this.state.isEditing,t[Classes.EDITABLE_TEXT_PLACEHOLDER]=!p,t[Classes.MULTILINE]=a,t),this.props.className);i=a?{height:this.state.isEditing?void 0:this.state.inputHeight}:{height:this.state.inputHeight,lineHeight:null!=this.state.inputHeight?this.state.inputHeight+"px":void 0,minWidth:this.props.minWidth};var d=s||this.state.isEditing||l?void 0:0,h=s&&!this.state.isEditing,c=null!=r?{id:r}:{};return React.createElement("div",{className:u,onFocus:this.handleFocus,tabIndex:d},s||this.state.isEditing?this.renderInput(o):void 0,h?void 0:React.createElement("span",__assign({},c,{className:Classes.EDITABLE_TEXT_CONTENT,ref:this.refHandlers.content,style:i}),p?o:this.props.placeholder))},e.prototype.componentDidMount=function(){this.updateInputDimensions()},e.prototype.componentDidUpdate=function(t,e){var i,n,s={};this.props.value===t.value||null==t.value&&null==this.props.value||(s.value=this.props.value),null!=this.props.isEditing&&this.props.isEditing!==t.isEditing&&(s.isEditing=this.props.isEditing),(this.props.disabled||null==this.props.disabled&&t.disabled)&&(s.isEditing=!1),this.setState(s),this.state.isEditing&&!e.isEditing&&(null===(n=(i=this.props).onEdit)||void 0===n||n.call(i,this.state.value)),this.state.value===e.value&&this.props.alwaysRenderInput===t.alwaysRenderInput&&this.props.maxLines===t.maxLines&&this.props.minLines===t.minLines&&this.props.minWidth===t.minWidth&&this.props.multiline===t.multiline||this.updateInputDimensions()},e.prototype.renderInput=function(t){var e=this.props,i=e.disabled,n=e.maxLength,s=e.multiline,l=e.type,a=e.placeholder,r={className:Classes.EDITABLE_TEXT_INPUT,disabled:i,maxLength:n,onBlur:this.toggleEditing,onChange:this.handleTextChange,onKeyDown:this.handleKeyEvent,placeholder:a,value:t},o=this.state,p=o.inputHeight,u=o.inputWidth;return 0!==p&&0!==u&&(r.style={height:p,lineHeight:s||null==p?void 0:p+"px",width:s?"100%":u}),s?React.createElement("textarea",__assign({ref:this.refHandlers.input},r)):React.createElement("input",__assign({ref:this.refHandlers.input,type:l},r))},e.prototype.updateInputDimensions=function(){if(null!=this.valueElement){var t=this.props,e=t.maxLines,i=t.minLines,n=t.minWidth,s=t.multiline,l=this.valueElement,a=l.parentElement,r=l.textContent,o=this.valueElement,p=o.scrollHeight,u=o.scrollWidth,d=getLineHeight(this.valueElement);s&&this.state.isEditing&&/\n$/.test(null!=r?r:"")&&(p+=d),d>0&&(p=clamp(p,i*d,e*d)),p=Math.max(p,getFontSize(this.valueElement)+1,getLineHeight(a)),u+=Browser.isInternetExplorer()?BUFFER_WIDTH_IE:BUFFER_WIDTH_DEFAULT,this.setState({inputHeight:p,inputWidth:Math.max(u,n)}),s&&this.state.isEditing&&this.setTimeout((function(){return a.style.height=p+"px"}))}},e.displayName=DISPLAYNAME_PREFIX+".EditableText",e.defaultProps={alwaysRenderInput:!1,confirmOnEnterKey:!1,defaultValue:"",disabled:!1,maxLines:1/0,minLines:1,minWidth:80,multiline:!1,placeholder:"Click to Edit",type:"text"},__decorate([polyfill],e)}(AbstractPureComponent2);export{EditableText};function getFontSize(t){var e=getComputedStyle(t).fontSize;return""===e?0:parseInt(e.slice(0,-2),10)}function getLineHeight(t){var e=parseInt(getComputedStyle(t).lineHeight.slice(0,-2),10);if(isNaN(e)){var i=document.createElement("span");i.innerHTML="<br>",t.appendChild(i);var n=t.offsetHeight;i.innerHTML="<br><br>";var s=t.offsetHeight;t.removeChild(i),e=s-n}return e}function insertAtCaret(t,e){var i=t.selectionEnd,n=t.selectionStart,s=t.value;if(n>=0){var l=s.substring(0,n),a=s.substring(i,s.length),r=e.length;t.value=""+l+e+a,t.selectionStart=n+r,t.selectionEnd=n+r}}function inputSupportsSelection(t){switch(t.type){case"textarea":case"text":case"search":case"tel":case"url":case"password":return!0;default:return!1}}