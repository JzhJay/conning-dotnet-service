import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,Classes,DISPLAYNAME_PREFIX,Intent,Keys,Position,refHandler,removeNonHTMLProps,setRef,Utils}from"../../common";import*as Errors from"../../common/errors";import{ButtonGroup}from"../button/buttonGroup";import{Button}from"../button/buttons";import{ControlGroup}from"./controlGroup";import{InputGroup}from"./inputGroup";import{clampValue,getValueOrEmptyValue,isValidNumericKeyboardEvent,isValueNumeric,parseStringToStringNumber,sanitizeNumericInput,toLocaleString,toMaxPrecision}from"./numericInputUtils";var IncrementDirection;!function(e){e[e.DOWN=-1]="DOWN",e[e.UP=1]="UP"}(IncrementDirection||(IncrementDirection={}));var NON_HTML_PROPS=["allowNumericCharactersOnly","buttonPosition","clampValueOnBlur","className","defaultValue","majorStepSize","minorStepSize","onButtonClick","onValueChange","selectAllOnFocus","selectAllOnIncrement","stepSize"],NumericInput=function(e){function t(){var t,o=e.apply(this,arguments)||this;return o.state={currentImeInputInvalid:!1,shouldSelectAfterUpdate:!1,stepMaxPrecision:n.getStepMaxPrecision(o.props),value:getValueOrEmptyValue(null!==(t=o.props.value)&&void 0!==t?t:o.props.defaultValue)},o.didPasteEventJustOccur=!1,o.delta=0,o.inputElement=null,o.inputRef=refHandler(o,"inputElement",o.props.inputRef),o.incrementButtonHandlers=o.getButtonEventHandlers(IncrementDirection.UP),o.decrementButtonHandlers=o.getButtonEventHandlers(IncrementDirection.DOWN),o.handleButtonClick=function(e,t){var n,r,a=o.updateDelta(t,e),i=o.incrementValue(a);null===(r=(n=o.props).onButtonClick)||void 0===r||r.call(n,Number(parseStringToStringNumber(i,o.props.locale)),i)},o.stopContinuousChange=function(){o.delta=0,o.clearTimeouts(),clearInterval(o.intervalId),document.removeEventListener("mouseup",o.stopContinuousChange)},o.handleContinuousChange=function(){var e,t,n,r;if(void 0!==o.props.min||void 0!==o.props.max){var a=null!==(e=o.props.min)&&void 0!==e?e:-1/0,i=null!==(t=o.props.max)&&void 0!==t?t:1/0,l=Number(parseStringToStringNumber(o.state.value,o.props.locale));if(l<=a||l>=i)return void o.stopContinuousChange()}var s=o.incrementValue(o.delta);null===(r=(n=o.props).onButtonClick)||void 0===r||r.call(n,Number(parseStringToStringNumber(s,o.props.locale)),s)},o.handleInputFocus=function(e){var t,n;o.setState({shouldSelectAfterUpdate:o.props.selectAllOnFocus}),null===(n=(t=o.props).onFocus)||void 0===n||n.call(t,e)},o.handleInputBlur=function(e){var t,n;if(o.setState({shouldSelectAfterUpdate:!1}),o.props.clampValueOnBlur){var r=e.target.value;o.handleNextValue(o.roundAndClampValue(r))}null===(n=(t=o.props).onBlur)||void 0===n||n.call(t,e)},o.handleInputKeyDown=function(e){var t,n;if(!o.props.disabled&&!o.props.readOnly){var r,a=e.keyCode;if(a===Keys.ARROW_UP?r=IncrementDirection.UP:a===Keys.ARROW_DOWN&&(r=IncrementDirection.DOWN),void 0!==r){e.preventDefault();var i=o.updateDelta(r,e);o.incrementValue(i)}null===(n=(t=o.props).onKeyDown)||void 0===n||n.call(t,e)}},o.handleCompositionEnd=function(e){o.props.allowNumericCharactersOnly&&(o.handleNextValue(sanitizeNumericInput(e.data,o.props.locale)),o.setState({currentImeInputInvalid:!1}))},o.handleCompositionUpdate=function(e){if(o.props.allowNumericCharactersOnly){var t=e.data;0===sanitizeNumericInput(t,o.props.locale).length&&t.length>0?o.setState({currentImeInputInvalid:!0}):o.setState({currentImeInputInvalid:!1})}},o.handleInputKeyPress=function(e){var t,n;o.props.allowNumericCharactersOnly&&!isValidNumericKeyboardEvent(e,o.props.locale)&&e.preventDefault(),null===(n=(t=o.props).onKeyPress)||void 0===n||n.call(t,e)},o.handleInputPaste=function(e){var t,n;o.didPasteEventJustOccur=!0,null===(n=(t=o.props).onPaste)||void 0===n||n.call(t,e)},o.handleInputChange=function(e){var t=e.target.value,n=t;o.props.allowNumericCharactersOnly&&o.didPasteEventJustOccur&&(o.didPasteEventJustOccur=!1,n=sanitizeNumericInput(t,o.props.locale)),o.handleNextValue(n),o.setState({shouldSelectAfterUpdate:!1})},o}var n;return __extends(t,e),n=t,t.getDerivedStateFromProps=function(e,t){var o,r,a={prevMaxProp:e.max,prevMinProp:e.min},i=e.min!==t.prevMinProp,l=e.max!==t.prevMaxProp,s=i||l,u=null!==(r=null===(o=e.value)||void 0===o?void 0:o.toString())&&void 0!==r?r:t.value,p=n.getStepMaxPrecision(e),c=u!==n.VALUE_EMPTY?n.roundAndClampValue(u,p,e.min,e.max,0,e.locale):n.VALUE_EMPTY;return s&&c!==t.value?__assign(__assign({},a),{stepMaxPrecision:p,value:c}):__assign(__assign({},a),{stepMaxPrecision:p,value:u})},t.getStepMaxPrecision=function(e){return null!=e.minorStepSize?Utils.countDecimalPlaces(e.minorStepSize):Utils.countDecimalPlaces(e.stepSize)},t.roundAndClampValue=function(e,t,o,r,a,i){if(void 0===a&&(a=0),!isValueNumeric(e,i))return n.VALUE_EMPTY;var l=parseStringToStringNumber(e,i),s=toMaxPrecision(Number(l)+a,t),u=clampValue(s,o,r);return toLocaleString(u,i)},t.prototype.render=function(){var e,t=this.props,n=t.buttonPosition,o=t.className,r=t.fill,a=t.large,i=classNames(Classes.NUMERIC_INPUT,((e={})[Classes.LARGE]=a,e),o),l=this.renderButtons();return React.createElement(ControlGroup,{className:i,fill:r},n===Position.LEFT&&l,this.renderInput(),n===Position.RIGHT&&l)},t.prototype.componentDidUpdate=function(t,o){var r,a,i;e.prototype.componentDidUpdate.call(this,t,o),t.inputRef!==this.props.inputRef&&(setRef(t.inputRef,null),this.inputRef=refHandler(this,"inputElement",this.props.inputRef),setRef(this.props.inputRef,this.inputElement)),this.state.shouldSelectAfterUpdate&&(null===(r=this.inputElement)||void 0===r||r.setSelectionRange(0,this.state.value.length));var l=this.props.min!==t.min,s=this.props.max!==t.max,u=l||s,p=this.props.locale!==t.locale,c=this.state.value!==o.value;if(u&&c||p&&o.value!==n.VALUE_EMPTY){var m=p?o.value:this.state.value,d=parseStringToStringNumber(m,t.locale),h=toLocaleString(+d,this.props.locale);null===(i=(a=this.props).onValueChange)||void 0===i||i.call(a,+d,h,this.inputElement)}},t.prototype.validateProps=function(e){var t=e.majorStepSize,o=e.max,r=e.min,a=e.minorStepSize,i=e.stepSize,l=e.value;if(null!=r&&null!=o&&r>o&&console.error(Errors.NUMERIC_INPUT_MIN_MAX),i<=0&&console.error(Errors.NUMERIC_INPUT_STEP_SIZE_NON_POSITIVE),a&&a<=0&&console.error(Errors.NUMERIC_INPUT_MINOR_STEP_SIZE_NON_POSITIVE),t&&t<=0&&console.error(Errors.NUMERIC_INPUT_MAJOR_STEP_SIZE_NON_POSITIVE),a&&a>i&&console.error(Errors.NUMERIC_INPUT_MINOR_STEP_SIZE_BOUND),t&&t<i&&console.error(Errors.NUMERIC_INPUT_MAJOR_STEP_SIZE_BOUND),null!=l){var s=n.getStepMaxPrecision(e),u=n.roundAndClampValue(l.toString(),s,r,o,0,this.props.locale),p=u!==l.toString(),c=toLocaleString(Number(parseStringToStringNumber(l,this.props.locale)),this.props.locale);p&&u!==c&&console.warn(Errors.NUMERIC_INPUT_CONTROLLED_VALUE_INVALID)}},t.prototype.renderButtons=function(){var e=this.props,t=e.intent,n=e.max,o=e.min,r=e.locale,a=parseStringToStringNumber(this.state.value,r),i=this.props.disabled||this.props.readOnly,l=void 0!==n&&""!==a&&+a>=n,s=void 0!==o&&""!==a&&+a<=o;return React.createElement(ButtonGroup,{className:Classes.FIXED,key:"button-group",vertical:!0},React.createElement(Button,__assign({"aria-label":"increment",disabled:i||l,icon:"chevron-up",intent:t},this.incrementButtonHandlers)),React.createElement(Button,__assign({"aria-label":"decrement",disabled:i||s,icon:"chevron-down",intent:t},this.decrementButtonHandlers)))},t.prototype.renderInput=function(){var e=removeNonHTMLProps(this.props,NON_HTML_PROPS,!0);return React.createElement(InputGroup,__assign({asyncControl:this.props.asyncControl,autoComplete:"off"},e,{intent:this.state.currentImeInputInvalid?Intent.DANGER:this.props.intent,inputRef:this.inputRef,large:this.props.large,leftIcon:this.props.leftIcon,onFocus:this.handleInputFocus,onBlur:this.handleInputBlur,onChange:this.handleInputChange,onCompositionEnd:this.handleCompositionEnd,onCompositionUpdate:this.handleCompositionUpdate,onKeyDown:this.handleInputKeyDown,onKeyPress:this.handleInputKeyPress,onPaste:this.handleInputPaste,rightElement:this.props.rightElement,value:this.state.value}))},t.prototype.getButtonEventHandlers=function(e){var t=this;return{onKeyDown:function(n){!t.props.disabled&&Keys.isKeyboardClick(n.keyCode)&&t.handleButtonClick(n,e)},onMouseDown:function(n){t.props.disabled||(t.handleButtonClick(n,e),t.startContinuousChange())}}},t.prototype.startContinuousChange=function(){var e=this;document.addEventListener("mouseup",this.stopContinuousChange),this.setTimeout((function(){e.intervalId=window.setInterval(e.handleContinuousChange,n.CONTINUOUS_CHANGE_INTERVAL)}),n.CONTINUOUS_CHANGE_DELAY)},t.prototype.handleNextValue=function(e){var t,n;null==this.props.value&&this.setState({value:e}),null===(n=(t=this.props).onValueChange)||void 0===n||n.call(t,Number(parseStringToStringNumber(e,this.props.locale)),e,this.inputElement)},t.prototype.incrementValue=function(e){var t=this.state.value===n.VALUE_EMPTY?n.VALUE_ZERO:this.state.value,o=this.roundAndClampValue(t,e);return o!==this.state.value&&(this.handleNextValue(o),this.setState({shouldSelectAfterUpdate:this.props.selectAllOnIncrement})),o},t.prototype.getIncrementDelta=function(e,t,n){var o=this.props,r=o.majorStepSize,a=o.minorStepSize,i=o.stepSize;return t&&null!=r?e*r:n&&null!=a?e*a:e*i},t.prototype.roundAndClampValue=function(e,t){return void 0===t&&(t=0),n.roundAndClampValue(e,this.state.stepMaxPrecision,this.props.min,this.props.max,t,this.props.locale)},t.prototype.updateDelta=function(e,t){return this.delta=this.getIncrementDelta(e,t.shiftKey,t.altKey),this.delta},t.displayName=DISPLAYNAME_PREFIX+".NumericInput",t.VALUE_EMPTY="",t.VALUE_ZERO="0",t.defaultProps={allowNumericCharactersOnly:!0,buttonPosition:Position.RIGHT,clampValueOnBlur:!1,defaultValue:n.VALUE_EMPTY,large:!1,majorStepSize:10,minorStepSize:.1,selectAllOnFocus:!1,selectAllOnIncrement:!1,stepSize:1},t.CONTINUOUS_CHANGE_DELAY=300,t.CONTINUOUS_CHANGE_INTERVAL=100,n=__decorate([polyfill],t)}(AbstractPureComponent2);export{NumericInput};