import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{Manager,Popper,Reference}from"react-popper";import{AbstractPureComponent2,Classes,refHandler,setRef}from"../../common";import*as Errors from"../../common/errors";import{DISPLAYNAME_PREFIX}from"../../common/props";import*as Utils from"../../common/utils";import{Overlay}from"../overlay/overlay";import{ResizeSensor}from"../resize-sensor/resizeSensor";import{Tooltip}from"../tooltip/tooltip";import{PopoverArrow}from"./popoverArrow";import{positionToPlacement}from"./popoverMigrationUtils";import{arrowOffsetModifier,getTransformOrigin}from"./popperUtils";export var PopoverInteractionKind={CLICK:"click",CLICK_TARGET_ONLY:"click-target",HOVER:"hover",HOVER_TARGET_ONLY:"hover-target"};var Popover=function(e){function o(){var o=null!==e&&e.apply(this,arguments)||this;return o.popoverRef=Utils.createReactRef(),o.popoverElement=null,o.targetElement=null,o.state={hasDarkParent:!1,isOpen:o.getIsOpen(o.props),transformOrigin:""},o.isMouseInTargetOrPopover=!1,o.lostFocusOnSamePage=!0,o.handlePopoverRef=refHandler(o,"popoverElement",o.props.popoverRef),o.handleTargetRef=function(e){return o.targetElement=e},o.reposition=function(){var e;return null===(e=o.popperScheduleUpdate)||void 0===e?void 0:e.call(o)},o.renderPopover=function(e){var r,t=o.props,s=t.interactionKind,n=t.usePortal,a=o.state.transformOrigin;o.popperScheduleUpdate=e.scheduleUpdate;var i={onClick:o.handlePopoverClick};(s===PopoverInteractionKind.HOVER||!n&&s===PopoverInteractionKind.HOVER_TARGET_ONLY)&&(i.onMouseEnter=o.handleMouseEnter,i.onMouseLeave=o.handleMouseLeave);var p=classNames(Classes.POPOVER,((r={})[Classes.DARK]=o.props.inheritDarkTheme&&o.state.hasDarkParent,r[Classes.MINIMAL]=o.props.minimal,r[Classes.POPOVER_CAPTURING_DISMISS]=o.props.captureDismiss,r[Classes.POPOVER_OUT_OF_BOUNDARIES]=!0===e.outOfBoundaries,r),o.props.popoverClassName);return React.createElement("div",{className:Classes.TRANSITION_CONTAINER,ref:e.ref,style:e.style},React.createElement(ResizeSensor,{onResize:o.reposition},React.createElement("div",__assign({className:p,style:{transformOrigin:a},ref:o.popoverRef},i),o.isArrowEnabled()&&React.createElement(PopoverArrow,{arrowProps:e.arrowProps,placement:e.placement}),React.createElement("div",{className:Classes.POPOVER_CONTENT},o.understandChildren().content))))},o.renderTarget=function(e){var r,t,s=o.props,n=s.fill,a=s.openOnTargetFocus,i=s.targetClassName,p=s.targetProps,l=void 0===p?{}:p,c=o.state.isOpen,d=o.isControlled(),u=o.isHoverInteractionKind(),O=o.props.targetTagName;n&&(O="div");var v=u?{onBlur:o.handleTargetBlur,onFocus:o.handleTargetFocus,onMouseEnter:o.handleMouseEnter,onMouseLeave:o.handleMouseLeave}:{onClick:o.handleTargetClick};v["aria-haspopup"]="true",v.className=classNames(Classes.POPOVER_TARGET,((r={})[Classes.POPOVER_OPEN]=c,r),l.className,i),v.ref=e.ref;var m=Utils.ensureElement(o.understandChildren().target);if(void 0===m)return null;var P=m.props.tabIndex,h=null==P&&a&&u?0:P,E=React.cloneElement(m,{className:classNames(m.props.className,(t={},t[Classes.ACTIVE]=c&&!d&&!u,t)),disabled:!(!c||!Utils.isElementOfType(m,Tooltip))||m.props.disabled,tabIndex:h}),f=React.createElement(O,__assign(__assign({},l),v),E);return React.createElement(ResizeSensor,{onResize:o.reposition},f)},o.isControlled=function(){return void 0!==o.props.isOpen},o.handleTargetFocus=function(e){var r,t;if(o.props.openOnTargetFocus&&o.isHoverInteractionKind()){if(null==e.relatedTarget&&!o.lostFocusOnSamePage)return;o.handleMouseEnter(e)}null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onFocus)||void 0===t||t.call(r,e)},o.handleTargetBlur=function(e){var r,t;o.props.openOnTargetFocus&&o.isHoverInteractionKind()&&(null==e.relatedTarget||o.isElementInPopover(e.relatedTarget)||o.handleMouseLeave(e)),o.lostFocusOnSamePage=null!=e.relatedTarget,null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onBlur)||void 0===t||t.call(r,e)},o.handleMouseEnter=function(e){var r,t;o.isMouseInTargetOrPopover=!0,o.props.usePortal||!o.isElementInPopover(e.target)||o.props.interactionKind!==PopoverInteractionKind.HOVER_TARGET_ONLY||o.props.openOnTargetFocus?o.props.disabled||o.setOpenState(!0,e,o.props.hoverOpenDelay):o.handleMouseLeave(e),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onMouseEnter)||void 0===t||t.call(r,e)},o.handleMouseLeave=function(e){var r,t;o.isMouseInTargetOrPopover=!1,o.setTimeout((function(){o.isMouseInTargetOrPopover||o.setOpenState(!1,e,o.props.hoverCloseDelay)})),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onMouseLeave)||void 0===t||t.call(r,e)},o.handlePopoverClick=function(e){var r=e.target,t=r.closest("."+Classes.POPOVER),s=t===o.popoverRef.current,n=null==t?void 0:t.classList.contains(Classes.POPOVER_CAPTURING_DISMISS),a=r.closest("."+Classes.POPOVER_DISMISS+", ."+Classes.POPOVER_DISMISS_OVERRIDE),i=null!=a&&a.classList.contains(Classes.POPOVER_DISMISS),p=null!=r.closest(":disabled, ."+Classes.DISABLED);!i||p||n&&!s||o.setOpenState(!1,e)},o.handleOverlayClose=function(e){if(null!==o.targetElement&&void 0!==e){var r=e.target;(!Utils.elementIsOrContains(o.targetElement,r)||e.nativeEvent instanceof KeyboardEvent)&&o.setOpenState(!1,e)}},o.handleTargetClick=function(e){var r,t;o.props.disabled||o.isElementInPopover(e.target)||(null==o.props.isOpen?o.setState((function(e){return{isOpen:!e.isOpen}})):o.setOpenState(!o.props.isOpen,e)),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onClick)||void 0===t||t.call(r,e)},o.updatePopoverState=function(e){return o.setState({transformOrigin:getTransformOrigin(e)}),e},o}return __extends(o,e),o.prototype.render=function(){var e,o,r=this.props,t=r.className,s=r.disabled,n=r.fill,a=r.placement,i=r.position,p=void 0===i?"auto":i,l=r.shouldReturnFocusOnClose,c=this.state.isOpen,d=this.props.wrapperTagName;n&&(d="div");var u=null==Utils.ensureElement(this.understandChildren().content);!u||s||!1===c||Utils.isNodeEnv("production")||console.warn(Errors.POPOVER_WARN_EMPTY_CONTENT);var O=classNames(Classes.POPOVER_WRAPPER,t,((e={})[Classes.FILL]=n,e)),v=!this.isHoverInteractionKind()&&void 0,m=React.createElement(d,{className:O},React.createElement(Reference,{innerRef:this.handleTargetRef},this.renderTarget),React.createElement(Overlay,{autoFocus:null!==(o=this.props.autoFocus)&&void 0!==o?o:v,backdropClassName:Classes.POPOVER_BACKDROP,backdropProps:this.props.backdropProps,canEscapeKeyClose:this.props.canEscapeKeyClose,canOutsideClickClose:this.props.interactionKind===PopoverInteractionKind.CLICK,className:this.props.portalClassName,enforceFocus:this.props.enforceFocus,hasBackdrop:this.props.hasBackdrop,isOpen:c&&!u,onClose:this.handleOverlayClose,onClosed:this.props.onClosed,onClosing:this.props.onClosing,onOpened:this.props.onOpened,onOpening:this.props.onOpening,transitionDuration:this.props.transitionDuration,transitionName:Classes.POPOVER,usePortal:this.props.usePortal,portalContainer:this.props.portalContainer,shouldReturnFocusOnClose:!this.isHoverInteractionKind()&&l},React.createElement(Popper,{innerRef:this.handlePopoverRef,placement:null!=a?a:positionToPlacement(p),modifiers:this.getPopperModifiers()},this.renderPopover)));return React.createElement(Manager,null,m)},o.prototype.componentDidMount=function(){this.updateDarkParent()},o.prototype.componentDidUpdate=function(o,r){e.prototype.componentDidUpdate.call(this,o,r),o.popoverRef!==this.props.popoverRef&&(setRef(o.popoverRef,null),this.handlePopoverRef=refHandler(this,"popoverElement",this.props.popoverRef),setRef(this.props.popoverRef,this.popoverElement)),this.updateDarkParent();var t=this.getIsOpen(this.props);null!=this.props.isOpen&&t!==this.state.isOpen?(this.setOpenState(t),this.setState({isOpen:t})):this.props.disabled&&this.state.isOpen&&null==this.props.isOpen&&this.setOpenState(!1)},o.prototype.validateProps=function(e){null==e.isOpen&&null!=e.onInteraction&&console.warn(Errors.POPOVER_WARN_UNCONTROLLED_ONINTERACTION),e.hasBackdrop&&!e.usePortal&&console.warn(Errors.POPOVER_WARN_HAS_BACKDROP_INLINE),e.hasBackdrop&&e.interactionKind!==PopoverInteractionKind.CLICK&&console.error(Errors.POPOVER_HAS_BACKDROP_INTERACTION),void 0!==e.placement&&void 0!==e.position&&console.warn(Errors.POPOVER_WARN_PLACEMENT_AND_POSITION_MUTEX);var o=React.Children.count(e.children),r=void 0!==e.content,t=void 0!==e.target;0!==o||t||console.error(Errors.POPOVER_REQUIRES_TARGET),o>2&&console.warn(Errors.POPOVER_WARN_TOO_MANY_CHILDREN),o>0&&t&&console.warn(Errors.POPOVER_WARN_DOUBLE_TARGET),2===o&&r&&console.warn(Errors.POPOVER_WARN_DOUBLE_CONTENT)},o.prototype.updateDarkParent=function(){if(this.props.usePortal&&this.state.isOpen){var e=null!=this.targetElement&&null!=this.targetElement.closest("."+Classes.DARK);this.setState({hasDarkParent:e})}},o.prototype.understandChildren=function(){var e=this.props,o=e.children,r=e.content,t=e.target,s=React.Children.toArray(o),n=s[0],a=s[1];return{content:null==a?r:a,target:null==n?t:n}},o.prototype.getIsOpen=function(e){return!e.disabled&&(null!=e.isOpen?e.isOpen:e.defaultIsOpen)},o.prototype.getPopperModifiers=function(){var e=this.props,o=e.boundary,r=e.modifiers,t=r,s=t.flip,n=void 0===s?{}:s,a=t.preventOverflow,i=void 0===a?{}:a;return __assign(__assign({},r),{arrowOffset:{enabled:this.isArrowEnabled(),fn:arrowOffsetModifier,order:510},flip:__assign({boundariesElement:o},n),preventOverflow:__assign({boundariesElement:o},i),updatePopoverState:{enabled:!0,fn:this.updatePopoverState,order:900}})},o.prototype.setOpenState=function(e,o,r){var t,s,n,a,i,p=this;null===(t=this.cancelOpenTimeout)||void 0===t||t.call(this),void 0!==r&&r>0?this.cancelOpenTimeout=this.setTimeout((function(){return p.setOpenState(e,o)}),r):(null==this.props.isOpen?this.setState({isOpen:e}):null===(n=(s=this.props).onInteraction)||void 0===n||n.call(s,e,o),e||null===(i=(a=this.props).onClose)||void 0===i||i.call(a,o))},o.prototype.isArrowEnabled=function(){var e=this.props,o=e.minimal,r=e.modifiers;return!o&&(null==(null==r?void 0:r.arrow)||r.arrow.enabled)},o.prototype.isElementInPopover=function(e){var o;return null===(o=this.popoverElement)||void 0===o?void 0:o.contains(e)},o.prototype.isHoverInteractionKind=function(){return this.props.interactionKind===PopoverInteractionKind.HOVER||this.props.interactionKind===PopoverInteractionKind.HOVER_TARGET_ONLY},o.displayName=DISPLAYNAME_PREFIX+".Popover",o.defaultProps={boundary:"scrollParent",captureDismiss:!1,defaultIsOpen:!1,disabled:!1,fill:!1,hasBackdrop:!1,hoverCloseDelay:300,hoverOpenDelay:150,inheritDarkTheme:!0,interactionKind:PopoverInteractionKind.CLICK,minimal:!1,modifiers:{},openOnTargetFocus:!0,shouldReturnFocusOnClose:!1,targetTagName:"span",transitionDuration:300,usePortal:!0,wrapperTagName:"span"},__decorate([polyfill],o)}(AbstractPureComponent2);export{Popover};