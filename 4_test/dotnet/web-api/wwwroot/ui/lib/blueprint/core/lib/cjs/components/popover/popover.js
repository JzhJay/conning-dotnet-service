"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Popover=exports.PopoverInteractionKind=void 0;var tslib_1=require("tslib"),classnames_1=tslib_1.__importDefault(require("classnames")),React=tslib_1.__importStar(require("react")),react_lifecycles_compat_1=require("react-lifecycles-compat"),react_popper_1=require("react-popper"),common_1=require("../../common"),Errors=tslib_1.__importStar(require("../../common/errors")),props_1=require("../../common/props"),Utils=tslib_1.__importStar(require("../../common/utils")),overlay_1=require("../overlay/overlay"),resizeSensor_1=require("../resize-sensor/resizeSensor"),tooltip_1=require("../tooltip/tooltip"),popoverArrow_1=require("./popoverArrow"),popoverMigrationUtils_1=require("./popoverMigrationUtils"),popperUtils_1=require("./popperUtils");exports.PopoverInteractionKind={CLICK:"click",CLICK_TARGET_ONLY:"click-target",HOVER:"hover",HOVER_TARGET_ONLY:"hover-target"};var Popover=function(e){function o(){var o=null!==e&&e.apply(this,arguments)||this;return o.popoverRef=Utils.createReactRef(),o.popoverElement=null,o.targetElement=null,o.state={hasDarkParent:!1,isOpen:o.getIsOpen(o.props),transformOrigin:""},o.isMouseInTargetOrPopover=!1,o.lostFocusOnSamePage=!0,o.handlePopoverRef=common_1.refHandler(o,"popoverElement",o.props.popoverRef),o.handleTargetRef=function(e){return o.targetElement=e},o.reposition=function(){var e;return null===(e=o.popperScheduleUpdate)||void 0===e?void 0:e.call(o)},o.renderPopover=function(e){var r,t=o.props,s=t.interactionKind,n=t.usePortal,a=o.state.transformOrigin;o.popperScheduleUpdate=e.scheduleUpdate;var i={onClick:o.handlePopoverClick};(s===exports.PopoverInteractionKind.HOVER||!n&&s===exports.PopoverInteractionKind.HOVER_TARGET_ONLY)&&(i.onMouseEnter=o.handleMouseEnter,i.onMouseLeave=o.handleMouseLeave);var p=classnames_1.default(common_1.Classes.POPOVER,((r={})[common_1.Classes.DARK]=o.props.inheritDarkTheme&&o.state.hasDarkParent,r[common_1.Classes.MINIMAL]=o.props.minimal,r[common_1.Classes.POPOVER_CAPTURING_DISMISS]=o.props.captureDismiss,r[common_1.Classes.POPOVER_OUT_OF_BOUNDARIES]=!0===e.outOfBoundaries,r),o.props.popoverClassName);return React.createElement("div",{className:common_1.Classes.TRANSITION_CONTAINER,ref:e.ref,style:e.style},React.createElement(resizeSensor_1.ResizeSensor,{onResize:o.reposition},React.createElement("div",tslib_1.__assign({className:p,style:{transformOrigin:a},ref:o.popoverRef},i),o.isArrowEnabled()&&React.createElement(popoverArrow_1.PopoverArrow,{arrowProps:e.arrowProps,placement:e.placement}),React.createElement("div",{className:common_1.Classes.POPOVER_CONTENT},o.understandChildren().content))))},o.renderTarget=function(e){var r,t,s=o.props,n=s.fill,a=s.openOnTargetFocus,i=s.targetClassName,p=s.targetProps,l=void 0===p?{}:p,c=o.state.isOpen,u=o.isControlled(),d=o.isHoverInteractionKind(),m=o.props.targetTagName;n&&(m="div");var v=d?{onBlur:o.handleTargetBlur,onFocus:o.handleTargetFocus,onMouseEnter:o.handleMouseEnter,onMouseLeave:o.handleMouseLeave}:{onClick:o.handleTargetClick};v["aria-haspopup"]="true",v.className=classnames_1.default(common_1.Classes.POPOVER_TARGET,((r={})[common_1.Classes.POPOVER_OPEN]=c,r),l.className,i),v.ref=e.ref;var _=Utils.ensureElement(o.understandChildren().target);if(void 0===_)return null;var O=_.props.tabIndex,P=null==O&&a&&d?0:O,h=React.cloneElement(_,{className:classnames_1.default(_.props.className,(t={},t[common_1.Classes.ACTIVE]=c&&!u&&!d,t)),disabled:!(!c||!Utils.isElementOfType(_,tooltip_1.Tooltip))||_.props.disabled,tabIndex:P}),E=React.createElement(m,tslib_1.__assign(tslib_1.__assign({},l),v),h);return React.createElement(resizeSensor_1.ResizeSensor,{onResize:o.reposition},E)},o.isControlled=function(){return void 0!==o.props.isOpen},o.handleTargetFocus=function(e){var r,t;if(o.props.openOnTargetFocus&&o.isHoverInteractionKind()){if(null==e.relatedTarget&&!o.lostFocusOnSamePage)return;o.handleMouseEnter(e)}null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onFocus)||void 0===t||t.call(r,e)},o.handleTargetBlur=function(e){var r,t;o.props.openOnTargetFocus&&o.isHoverInteractionKind()&&(null==e.relatedTarget||o.isElementInPopover(e.relatedTarget)||o.handleMouseLeave(e)),o.lostFocusOnSamePage=null!=e.relatedTarget,null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onBlur)||void 0===t||t.call(r,e)},o.handleMouseEnter=function(e){var r,t;o.isMouseInTargetOrPopover=!0,o.props.usePortal||!o.isElementInPopover(e.target)||o.props.interactionKind!==exports.PopoverInteractionKind.HOVER_TARGET_ONLY||o.props.openOnTargetFocus?o.props.disabled||o.setOpenState(!0,e,o.props.hoverOpenDelay):o.handleMouseLeave(e),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onMouseEnter)||void 0===t||t.call(r,e)},o.handleMouseLeave=function(e){var r,t;o.isMouseInTargetOrPopover=!1,o.setTimeout((function(){o.isMouseInTargetOrPopover||o.setOpenState(!1,e,o.props.hoverCloseDelay)})),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onMouseLeave)||void 0===t||t.call(r,e)},o.handlePopoverClick=function(e){var r=e.target,t=r.closest("."+common_1.Classes.POPOVER),s=t===o.popoverRef.current,n=null==t?void 0:t.classList.contains(common_1.Classes.POPOVER_CAPTURING_DISMISS),a=r.closest("."+common_1.Classes.POPOVER_DISMISS+", ."+common_1.Classes.POPOVER_DISMISS_OVERRIDE),i=null!=a&&a.classList.contains(common_1.Classes.POPOVER_DISMISS),p=null!=r.closest(":disabled, ."+common_1.Classes.DISABLED);!i||p||n&&!s||o.setOpenState(!1,e)},o.handleOverlayClose=function(e){if(null!==o.targetElement&&void 0!==e){var r=e.target;(!Utils.elementIsOrContains(o.targetElement,r)||e.nativeEvent instanceof KeyboardEvent)&&o.setOpenState(!1,e)}},o.handleTargetClick=function(e){var r,t;o.props.disabled||o.isElementInPopover(e.target)||(null==o.props.isOpen?o.setState((function(e){return{isOpen:!e.isOpen}})):o.setOpenState(!o.props.isOpen,e)),null===(t=null===(r=o.props.targetProps)||void 0===r?void 0:r.onClick)||void 0===t||t.call(r,e)},o.updatePopoverState=function(e){return o.setState({transformOrigin:popperUtils_1.getTransformOrigin(e)}),e},o}return tslib_1.__extends(o,e),o.prototype.render=function(){var e,o,r=this.props,t=r.className,s=r.disabled,n=r.fill,a=r.placement,i=r.position,p=void 0===i?"auto":i,l=r.shouldReturnFocusOnClose,c=this.state.isOpen,u=this.props.wrapperTagName;n&&(u="div");var d=null==Utils.ensureElement(this.understandChildren().content);!d||s||!1===c||Utils.isNodeEnv("production")||console.warn(Errors.POPOVER_WARN_EMPTY_CONTENT);var m=classnames_1.default(common_1.Classes.POPOVER_WRAPPER,t,((e={})[common_1.Classes.FILL]=n,e)),v=!this.isHoverInteractionKind()&&void 0,_=React.createElement(u,{className:m},React.createElement(react_popper_1.Reference,{innerRef:this.handleTargetRef},this.renderTarget),React.createElement(overlay_1.Overlay,{autoFocus:null!==(o=this.props.autoFocus)&&void 0!==o?o:v,backdropClassName:common_1.Classes.POPOVER_BACKDROP,backdropProps:this.props.backdropProps,canEscapeKeyClose:this.props.canEscapeKeyClose,canOutsideClickClose:this.props.interactionKind===exports.PopoverInteractionKind.CLICK,className:this.props.portalClassName,enforceFocus:this.props.enforceFocus,hasBackdrop:this.props.hasBackdrop,isOpen:c&&!d,onClose:this.handleOverlayClose,onClosed:this.props.onClosed,onClosing:this.props.onClosing,onOpened:this.props.onOpened,onOpening:this.props.onOpening,transitionDuration:this.props.transitionDuration,transitionName:common_1.Classes.POPOVER,usePortal:this.props.usePortal,portalContainer:this.props.portalContainer,shouldReturnFocusOnClose:!this.isHoverInteractionKind()&&l},React.createElement(react_popper_1.Popper,{innerRef:this.handlePopoverRef,placement:null!=a?a:popoverMigrationUtils_1.positionToPlacement(p),modifiers:this.getPopperModifiers()},this.renderPopover)));return React.createElement(react_popper_1.Manager,null,_)},o.prototype.componentDidMount=function(){this.updateDarkParent()},o.prototype.componentDidUpdate=function(o,r){e.prototype.componentDidUpdate.call(this,o,r),o.popoverRef!==this.props.popoverRef&&(common_1.setRef(o.popoverRef,null),this.handlePopoverRef=common_1.refHandler(this,"popoverElement",this.props.popoverRef),common_1.setRef(this.props.popoverRef,this.popoverElement)),this.updateDarkParent();var t=this.getIsOpen(this.props);null!=this.props.isOpen&&t!==this.state.isOpen?(this.setOpenState(t),this.setState({isOpen:t})):this.props.disabled&&this.state.isOpen&&null==this.props.isOpen&&this.setOpenState(!1)},o.prototype.validateProps=function(e){null==e.isOpen&&null!=e.onInteraction&&console.warn(Errors.POPOVER_WARN_UNCONTROLLED_ONINTERACTION),e.hasBackdrop&&!e.usePortal&&console.warn(Errors.POPOVER_WARN_HAS_BACKDROP_INLINE),e.hasBackdrop&&e.interactionKind!==exports.PopoverInteractionKind.CLICK&&console.error(Errors.POPOVER_HAS_BACKDROP_INTERACTION),void 0!==e.placement&&void 0!==e.position&&console.warn(Errors.POPOVER_WARN_PLACEMENT_AND_POSITION_MUTEX);var o=React.Children.count(e.children),r=void 0!==e.content,t=void 0!==e.target;0!==o||t||console.error(Errors.POPOVER_REQUIRES_TARGET),o>2&&console.warn(Errors.POPOVER_WARN_TOO_MANY_CHILDREN),o>0&&t&&console.warn(Errors.POPOVER_WARN_DOUBLE_TARGET),2===o&&r&&console.warn(Errors.POPOVER_WARN_DOUBLE_CONTENT)},o.prototype.updateDarkParent=function(){if(this.props.usePortal&&this.state.isOpen){var e=null!=this.targetElement&&null!=this.targetElement.closest("."+common_1.Classes.DARK);this.setState({hasDarkParent:e})}},o.prototype.understandChildren=function(){var e=this.props,o=e.children,r=e.content,t=e.target,s=React.Children.toArray(o),n=s[0],a=s[1];return{content:null==a?r:a,target:null==n?t:n}},o.prototype.getIsOpen=function(e){return!e.disabled&&(null!=e.isOpen?e.isOpen:e.defaultIsOpen)},o.prototype.getPopperModifiers=function(){var e=this.props,o=e.boundary,r=e.modifiers,t=r,s=t.flip,n=void 0===s?{}:s,a=t.preventOverflow,i=void 0===a?{}:a;return tslib_1.__assign(tslib_1.__assign({},r),{arrowOffset:{enabled:this.isArrowEnabled(),fn:popperUtils_1.arrowOffsetModifier,order:510},flip:tslib_1.__assign({boundariesElement:o},n),preventOverflow:tslib_1.__assign({boundariesElement:o},i),updatePopoverState:{enabled:!0,fn:this.updatePopoverState,order:900}})},o.prototype.setOpenState=function(e,o,r){var t,s,n,a,i,p=this;null===(t=this.cancelOpenTimeout)||void 0===t||t.call(this),void 0!==r&&r>0?this.cancelOpenTimeout=this.setTimeout((function(){return p.setOpenState(e,o)}),r):(null==this.props.isOpen?this.setState({isOpen:e}):null===(n=(s=this.props).onInteraction)||void 0===n||n.call(s,e,o),e||null===(i=(a=this.props).onClose)||void 0===i||i.call(a,o))},o.prototype.isArrowEnabled=function(){var e=this.props,o=e.minimal,r=e.modifiers;return!o&&(null==(null==r?void 0:r.arrow)||r.arrow.enabled)},o.prototype.isElementInPopover=function(e){var o;return null===(o=this.popoverElement)||void 0===o?void 0:o.contains(e)},o.prototype.isHoverInteractionKind=function(){return this.props.interactionKind===exports.PopoverInteractionKind.HOVER||this.props.interactionKind===exports.PopoverInteractionKind.HOVER_TARGET_ONLY},o.displayName=props_1.DISPLAYNAME_PREFIX+".Popover",o.defaultProps={boundary:"scrollParent",captureDismiss:!1,defaultIsOpen:!1,disabled:!1,fill:!1,hasBackdrop:!1,hoverCloseDelay:300,hoverOpenDelay:150,inheritDarkTheme:!0,interactionKind:exports.PopoverInteractionKind.CLICK,minimal:!1,modifiers:{},openOnTargetFocus:!0,shouldReturnFocusOnClose:!1,targetTagName:"span",transitionDuration:300,usePortal:!0,wrapperTagName:"span"},tslib_1.__decorate([react_lifecycles_compat_1.polyfill],o)}(common_1.AbstractPureComponent2);exports.Popover=Popover;