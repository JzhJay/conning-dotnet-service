"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EditableText=void 0;var tslib_1=require("tslib"),classnames_1=tslib_1.__importDefault(require("classnames")),React=tslib_1.__importStar(require("react")),react_lifecycles_compat_1=require("react-lifecycles-compat"),common_1=require("../../common"),props_1=require("../../common/props"),utils_1=require("../../common/utils"),compatibility_1=require("../../compatibility"),BUFFER_WIDTH_DEFAULT=5,BUFFER_WIDTH_IE=30,EditableText=function(t){function e(e,i){var n=t.call(this,e,i)||this;n.inputElement=null,n.valueElement=null,n.refHandlers={content:function(t){n.valueElement=t},input:function(t){if(null!=t&&(n.inputElement=t,n.props.alwaysRenderInput||n.inputElement.focus(),null!=n.state&&n.state.isEditing)){var e=inputSupportsSelection(t);if(e){var i=t.value.length;t.setSelectionRange(n.props.selectAllOnFocus?0:i,i)}e&&n.props.selectAllOnFocus||(t.scrollLeft=t.scrollWidth)}}},n.cancelEditing=function(){var t,e,i,s,l=n.state,a=l.lastValue,o=l.value;n.setState({isEditing:!1,value:a}),o!==a&&(null===(e=(t=n.props).onChange)||void 0===e||e.call(t,a)),null===(s=(i=n.props).onCancel)||void 0===s||s.call(i,a)},n.toggleEditing=function(){var t,e;if(n.state.isEditing){var i=n.state.value;n.setState({isEditing:!1,lastValue:i}),null===(e=(t=n.props).onConfirm)||void 0===e||e.call(t,i)}else n.props.disabled||n.setState({isEditing:!0})},n.handleFocus=function(){var t=n.props,e=t.alwaysRenderInput,i=t.disabled,s=t.selectAllOnFocus;if(i||n.setState({isEditing:!0}),e&&s&&null!=n.inputElement){var l=n.inputElement.value.length;n.inputElement.setSelectionRange(0,l)}},n.handleTextChange=function(t){var e,i,s=t.target.value;null==n.props.value&&n.setState({value:s}),null===(i=(e=n.props).onChange)||void 0===i||i.call(e,s)},n.handleKeyEvent=function(t){var e=t.altKey,i=t.ctrlKey,s=t.metaKey,l=t.shiftKey,a=t.which;if(a!==common_1.Keys.ESCAPE){var o=e||i||s||l;a===common_1.Keys.ENTER&&((e||l)&&t.preventDefault(),n.props.confirmOnEnterKey&&n.props.multiline?null!=t.target&&o?(insertAtCaret(t.target,"\n"),n.handleTextChange(t)):n.toggleEditing():n.props.multiline&&!o||n.toggleEditing())}else n.cancelEditing()};var s=null==e.value?e.defaultValue:e.value;return n.state={inputHeight:0,inputWidth:0,isEditing:!0===e.isEditing&&!1===e.disabled,lastValue:s,value:s},n}return tslib_1.__extends(e,t),e.prototype.render=function(){var t,e,i,n=this.props,s=n.alwaysRenderInput,l=n.disabled,a=n.multiline,o=n.contentId,r=null!==(e=this.props.value)&&void 0!==e?e:this.state.value,u=null!=r&&""!==r,p=classnames_1.default(common_1.Classes.EDITABLE_TEXT,common_1.Classes.intentClass(this.props.intent),((t={})[common_1.Classes.DISABLED]=l,t[common_1.Classes.EDITABLE_TEXT_EDITING]=this.state.isEditing,t[common_1.Classes.EDITABLE_TEXT_PLACEHOLDER]=!u,t[common_1.Classes.MULTILINE]=a,t),this.props.className);i=a?{height:this.state.isEditing?void 0:this.state.inputHeight}:{height:this.state.inputHeight,lineHeight:null!=this.state.inputHeight?this.state.inputHeight+"px":void 0,minWidth:this.props.minWidth};var d=s||this.state.isEditing||l?void 0:0,c=s&&!this.state.isEditing,h=null!=o?{id:o}:{};return React.createElement("div",{className:p,onFocus:this.handleFocus,tabIndex:d},s||this.state.isEditing?this.renderInput(r):void 0,c?void 0:React.createElement("span",tslib_1.__assign({},h,{className:common_1.Classes.EDITABLE_TEXT_CONTENT,ref:this.refHandlers.content,style:i}),u?r:this.props.placeholder))},e.prototype.componentDidMount=function(){this.updateInputDimensions()},e.prototype.componentDidUpdate=function(t,e){var i,n,s={};this.props.value===t.value||null==t.value&&null==this.props.value||(s.value=this.props.value),null!=this.props.isEditing&&this.props.isEditing!==t.isEditing&&(s.isEditing=this.props.isEditing),(this.props.disabled||null==this.props.disabled&&t.disabled)&&(s.isEditing=!1),this.setState(s),this.state.isEditing&&!e.isEditing&&(null===(n=(i=this.props).onEdit)||void 0===n||n.call(i,this.state.value)),this.state.value===e.value&&this.props.alwaysRenderInput===t.alwaysRenderInput&&this.props.maxLines===t.maxLines&&this.props.minLines===t.minLines&&this.props.minWidth===t.minWidth&&this.props.multiline===t.multiline||this.updateInputDimensions()},e.prototype.renderInput=function(t){var e=this.props,i=e.disabled,n=e.maxLength,s=e.multiline,l=e.type,a=e.placeholder,o={className:common_1.Classes.EDITABLE_TEXT_INPUT,disabled:i,maxLength:n,onBlur:this.toggleEditing,onChange:this.handleTextChange,onKeyDown:this.handleKeyEvent,placeholder:a,value:t},r=this.state,u=r.inputHeight,p=r.inputWidth;return 0!==u&&0!==p&&(o.style={height:u,lineHeight:s||null==u?void 0:u+"px",width:s?"100%":p}),s?React.createElement("textarea",tslib_1.__assign({ref:this.refHandlers.input},o)):React.createElement("input",tslib_1.__assign({ref:this.refHandlers.input,type:l},o))},e.prototype.updateInputDimensions=function(){if(null!=this.valueElement){var t=this.props,e=t.maxLines,i=t.minLines,n=t.minWidth,s=t.multiline,l=this.valueElement,a=l.parentElement,o=l.textContent,r=this.valueElement,u=r.scrollHeight,p=r.scrollWidth,d=getLineHeight(this.valueElement);s&&this.state.isEditing&&/\n$/.test(null!=o?o:"")&&(u+=d),d>0&&(u=utils_1.clamp(u,i*d,e*d)),u=Math.max(u,getFontSize(this.valueElement)+1,getLineHeight(a)),p+=compatibility_1.Browser.isInternetExplorer()?BUFFER_WIDTH_IE:BUFFER_WIDTH_DEFAULT,this.setState({inputHeight:u,inputWidth:Math.max(p,n)}),s&&this.state.isEditing&&this.setTimeout((function(){return a.style.height=u+"px"}))}},e.displayName=props_1.DISPLAYNAME_PREFIX+".EditableText",e.defaultProps={alwaysRenderInput:!1,confirmOnEnterKey:!1,defaultValue:"",disabled:!1,maxLines:1/0,minLines:1,minWidth:80,multiline:!1,placeholder:"Click to Edit",type:"text"},tslib_1.__decorate([react_lifecycles_compat_1.polyfill],e)}(common_1.AbstractPureComponent2);function getFontSize(t){var e=getComputedStyle(t).fontSize;return""===e?0:parseInt(e.slice(0,-2),10)}function getLineHeight(t){var e=parseInt(getComputedStyle(t).lineHeight.slice(0,-2),10);if(isNaN(e)){var i=document.createElement("span");i.innerHTML="<br>",t.appendChild(i);var n=t.offsetHeight;i.innerHTML="<br><br>";var s=t.offsetHeight;t.removeChild(i),e=s-n}return e}function insertAtCaret(t,e){var i=t.selectionEnd,n=t.selectionStart,s=t.value;if(n>=0){var l=s.substring(0,n),a=s.substring(i,s.length),o=e.length;t.value=""+l+e+a,t.selectionStart=n+o,t.selectionEnd=n+o}}function inputSupportsSelection(t){switch(t.type){case"textarea":case"text":case"search":case"tel":case"url":case"password":return!0;default:return!1}}exports.EditableText=EditableText;