import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,DISPLAYNAME_PREFIX,InputGroup,Intent,Keys,Popover,refHandler,setRef}from"@blueprintjs/core";import*as Classes from"./common/classes";import{isDateValid,isDayInRange}from"./common/dateUtils";import{getFormattedDateString}from"./dateFormat";import{DatePicker}from"./datePicker";import{getDefaultMaxDate,getDefaultMinDate}from"./datePickerCore";var DateInput=function(e){function t(){var t,n=e.apply(this,arguments)||this;return n.state={isInputFocused:!1,isOpen:!1,value:void 0!==n.props.value?n.props.value:n.props.defaultValue,valueString:null},n.inputElement=null,n.popoverContentElement=null,n.handleInputRef=refHandler(n,"inputElement",null===(t=n.props.inputProps)||void 0===t?void 0:t.inputRef),n.handlePopoverContentRef=refHandler(n,"popoverContentElement"),n.handleClosePopover=function(e){var t,o=n.props.popoverProps,a=void 0===o?{}:o;null===(t=a.onClose)||void 0===t||t.call(a,e),n.setState({isOpen:!1})},n.handleDateChange=function(e,t,o){var a,s;void 0===o&&(o=!1);var l=n.state.value,i=!t||!n.props.closeOnSelection||null!=l&&(n.hasMonthChanged(l,e)||n.hasTimeChanged(l,e)),r=!!o;if(void 0===n.props.value){var p=getFormattedDateString(e,n.props);n.setState({isInputFocused:r,isOpen:i,value:e,valueString:p})}else n.setState({isInputFocused:r,isOpen:i});null===(s=(a=n.props).onChange)||void 0===s||s.call(a,e,t)},n.handleInputFocus=function(e){var t=null==n.state.value?"":n.formatDate(n.state.value);n.setState({isInputFocused:!0,isOpen:!0,valueString:t}),n.safeInvokeInputProp("onFocus",e)},n.handleInputClick=function(e){e.stopPropagation(),n.safeInvokeInputProp("onClick",e)},n.handleInputChange=function(e){var t,o,a,s,l=e.target.value,i=n.parseDate(l);isDateValid(i)&&n.isDateInRange(i)?(void 0===n.props.value?n.setState({value:i,valueString:l}):n.setState({valueString:l}),null===(o=(t=n.props).onChange)||void 0===o||o.call(t,i,!0)):(0===l.length&&(null===(s=(a=n.props).onChange)||void 0===s||s.call(a,null,!0)),n.setState({valueString:l})),n.safeInvokeInputProp("onChange",e)},n.handleInputBlur=function(e){var t,o,a,s,l,i,r=n.state.valueString,p=n.parseDate(r);!(r.length>0&&r!==getFormattedDateString(n.state.value,n.props))||isDateValid(p)&&n.isDateInRange(p)?0===r.length?n.setState({isInputFocused:!1,value:null,valueString:null}):n.setState({isInputFocused:!1}):(void 0===n.props.value?n.setState({isInputFocused:!1,value:p,valueString:null}):n.setState({isInputFocused:!1}),isNaN(p.valueOf())?null===(o=(t=n.props).onError)||void 0===o||o.call(t,new Date(void 0)):n.isDateInRange(p)?null===(i=(l=n.props).onChange)||void 0===i||i.call(l,p,!0):null===(s=(a=n.props).onError)||void 0===s||s.call(a,p)),n.safeInvokeInputProp("onBlur",e)},n.handleInputKeyDown=function(e){var t,o;if(e.which===Keys.ENTER){var a=n.parseDate(n.state.valueString);n.handleDateChange(a,!0,!0)}else e.which===Keys.TAB&&e.shiftKey?n.handleClosePopover():e.which===Keys.TAB&&n.state.isOpen?(null===(t=n.getKeyboardFocusableElements().shift())||void 0===t||t.focus(),e.preventDefault()):e.which===Keys.ESCAPE&&(n.setState({isOpen:!1}),null===(o=n.inputElement)||void 0===o||o.blur());n.safeInvokeInputProp("onKeyDown",e)},n.getKeyboardFocusableElements=function(){var e,t=Array.from(null===(e=n.popoverContentElement)||void 0===e?void 0:e.querySelectorAll("button:not([disabled]),input,[tabindex]:not([tabindex='-1'])"));return t.pop(),t.shift(),t},n.handleStartFocusBoundaryFocusIn=function(e){var t,o;n.popoverContentElement.contains(n.getRelatedTarget(e))?null===(t=n.inputElement)||void 0===t||t.focus():null===(o=n.getKeyboardFocusableElements().shift())||void 0===o||o.focus()},n.handleEndFocusBoundaryFocusIn=function(e){var t,o;n.popoverContentElement.contains(n.getRelatedTarget(e))?(null===(t=n.inputElement)||void 0===t||t.focus(),n.handleClosePopover()):null===(o=n.getKeyboardFocusableElements().pop())||void 0===o||o.focus()},n.handleShortcutChange=function(e,t){n.setState({selectedShortcutIndex:t})},n}return __extends(t,e),t.prototype.render=function(){var e=this,t=this.state,n=t.value,o=t.valueString,a=this.state.isInputFocused?o:getFormattedDateString(n,this.props),s=isDateValid(n)?n:null,l=__assign(__assign({},this.props.dayPickerProps),{onDayKeyDown:function(t,n,o){var a,s;null===(s=(a=e.props.dayPickerProps).onDayKeyDown)||void 0===s||s.call(a,t,n,o)},onMonthChange:function(t){var n,o;null===(o=(n=e.props.dayPickerProps).onMonthChange)||void 0===o||o.call(n,t)}}),i=React.createElement("div",{ref:this.handlePopoverContentRef},React.createElement("div",{onFocus:this.handleStartFocusBoundaryFocusIn,tabIndex:0}),React.createElement(DatePicker,__assign({},this.props,{dayPickerProps:l,onChange:this.handleDateChange,value:s,onShortcutChange:this.handleShortcutChange,selectedShortcutIndex:this.state.selectedShortcutIndex})),React.createElement("div",{onFocus:this.handleEndFocusBoundaryFocusIn,tabIndex:0})),r=this.props,p=r.inputProps,u=void 0===p?{}:p,d=r.popoverProps,c=void 0===d?{}:d,h=!(null==n||isDateValid(n)&&this.isDateInRange(n));return React.createElement(Popover,__assign({isOpen:this.state.isOpen&&!this.props.disabled,fill:this.props.fill},c,{autoFocus:!1,className:classNames(c.className,this.props.className),content:i,enforceFocus:!1,onClose:this.handleClosePopover,popoverClassName:classNames(Classes.DATEINPUT_POPOVER,c.popoverClassName)}),React.createElement(InputGroup,__assign({autoComplete:"off",intent:h?Intent.DANGER:Intent.NONE,placeholder:this.props.placeholder,rightElement:this.props.rightElement,type:"text"},u,{disabled:this.props.disabled,inputRef:this.handleInputRef,onBlur:this.handleInputBlur,onChange:this.handleInputChange,onClick:this.handleInputClick,onFocus:this.handleInputFocus,onKeyDown:this.handleInputKeyDown,value:a})))},t.prototype.componentDidUpdate=function(t,n){var o,a,s,l,i;e.prototype.componentDidUpdate.call(this,t,n),(null===(o=t.inputProps)||void 0===o?void 0:o.inputRef)!==(null===(a=this.props.inputProps)||void 0===a?void 0:a.inputRef)&&(setRef(null===(s=t.inputProps)||void 0===s?void 0:s.inputRef,null),this.handleInputRef=refHandler(this,"inputElement",null===(l=this.props.inputProps)||void 0===l?void 0:l.inputRef),setRef(null===(i=this.props.inputProps)||void 0===i?void 0:i.inputRef,this.inputElement)),t.value!==this.props.value&&this.setState({value:this.props.value})},t.prototype.isDateInRange=function(e){return isDayInRange(e,[this.props.minDate,this.props.maxDate])},t.prototype.hasMonthChanged=function(e,t){return null==e!=(null==t)||t.getMonth()!==e.getMonth()},t.prototype.hasTimeChanged=function(e,t){return null!=this.props.timePrecision&&(null==e!=(null==t)||t.getHours()!==e.getHours()||t.getMinutes()!==e.getMinutes()||t.getSeconds()!==e.getSeconds()||t.getMilliseconds()!==e.getMilliseconds())},t.prototype.getRelatedTarget=function(e){var t;return null!==(t=e.relatedTarget)&&void 0!==t?t:document.activeElement},t.prototype.safeInvokeInputProp=function(e,t){var n,o=this.props.inputProps,a=void 0===o?{}:o;null===(n=a[e])||void 0===n||n.call(a,t)},t.prototype.parseDate=function(e){if(e===this.props.outOfRangeMessage||e===this.props.invalidDateMessage)return null;var t=this.props,n=t.locale,o=(0,t.parseDate)(e,n);return!1===o?new Date(void 0):o},t.prototype.formatDate=function(e){if(!isDateValid(e)||!this.isDateInRange(e))return"";var t=this.props,n=t.locale;return(0,t.formatDate)(e,n)},t.displayName=DISPLAYNAME_PREFIX+".DateInput",t.defaultProps={closeOnSelection:!0,dayPickerProps:{},disabled:!1,invalidDateMessage:"Invalid date",maxDate:getDefaultMaxDate(),minDate:getDefaultMinDate(),outOfRangeMessage:"Out of range",reverseMonthAndYearMenus:!1},__decorate([polyfill],t)}(AbstractPureComponent2);export{DateInput};