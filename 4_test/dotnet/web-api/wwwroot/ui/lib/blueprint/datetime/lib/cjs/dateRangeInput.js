"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DateRangeInput=void 0;var tslib_1=require("tslib"),classnames_1=tslib_1.__importDefault(require("classnames")),React=tslib_1.__importStar(require("react")),react_day_picker_1=tslib_1.__importDefault(require("react-day-picker")),react_lifecycles_compat_1=require("react-lifecycles-compat"),core_1=require("@blueprintjs/core"),dateUtils_1=require("./common/dateUtils"),Errors=tslib_1.__importStar(require("./common/errors")),dateFormat_1=require("./dateFormat"),datePickerCore_1=require("./datePickerCore"),dateRangePicker_1=require("./dateRangePicker"),DateRangeInput=function(e){function t(t,n){var a,r,s=e.call(this,t,n)||this;return s.startInputElement=null,s.endInputElement=null,s.handleStartInputRef=core_1.refHandler(s,"startInputElement",null===(a=s.props.startInputProps)||void 0===a?void 0:a.inputRef),s.handleEndInputRef=core_1.refHandler(s,"endInputElement",null===(r=s.props.endInputProps)||void 0===r?void 0:r.inputRef),s.renderInputGroup=function(e){var t=s.getInputProps(e),n=e===core_1.Boundary.START?s.handleStartInputEvent:s.handleEndInputEvent;return React.createElement(core_1.InputGroup,tslib_1.__assign({autoComplete:"off",disabled:t.disabled||s.props.disabled},t,{intent:s.isInputInErrorState(e)?core_1.Intent.DANGER:t.intent,inputRef:s.getInputRef(e),onBlur:n,onChange:n,onClick:n,onFocus:n,onKeyDown:n,onMouseDown:n,placeholder:s.getInputPlaceholderString(e),value:s.getInputDisplayString(e)}))},s.handleDateRangePickerChange=function(e,t){var n,a;if(void 0===t&&(t=!1),s.state.isOpen){var r,o,i,l,u,d=e[0],p=e[1],c=!0;null==d?(null==s.props.timePrecision?(r=!0,o=!1):(r=!1,o=!1,u=core_1.Boundary.START),i=null):null==p?(null==s.props.timePrecision?(r=!1,o=!0):(r=!1,o=!1,u=core_1.Boundary.END),l=null):s.props.closeOnSelection?(c=s.getIsOpenValueWhenDateChanges(d,p),r=!1,null==s.props.timePrecision&&t?o=!0:(o=!1,u=core_1.Boundary.END)):s.state.lastFocusedField===core_1.Boundary.START?null==s.props.timePrecision?(r=!0,o=!1):(r=!1,o=!1,u=core_1.Boundary.START):null==s.props.timePrecision?(r=!1,o=!0):(r=!1,o=!1,u=core_1.Boundary.END);var g={boundaryToModify:u,endHoverString:l,endInputString:s.formatDate(p),isEndInputFocused:o,isOpen:c,isStartInputFocused:r,startHoverString:i,startInputString:s.formatDate(d),wasLastFocusChangeDueToHover:!1};s.isControlled()?s.setState(g):s.setState(tslib_1.__assign(tslib_1.__assign({},g),{selectedEnd:p,selectedStart:d})),null===(a=(n=s.props).onChange)||void 0===a||a.call(n,e)}},s.handleShortcutChange=function(e,t){s.setState({selectedShortcutIndex:t})},s.handleDateRangePickerHoverChange=function(e,t,n){if(s.state.isOpen)if(null==e){var a=s.state.boundaryToModify===core_1.Boundary.END;s.setState({endHoverString:null,isEndInputFocused:a,isStartInputFocused:!a,lastFocusedField:s.state.boundaryToModify,startHoverString:null})}else{var r=e[0],o=e[1],i=null!=n?n===core_1.Boundary.START:s.state.isStartInputFocused;a=null!=n?n===core_1.Boundary.END:s.state.isEndInputFocused,s.setState({endHoverString:s.formatDate(o),isEndInputFocused:a,isStartInputFocused:i,lastFocusedField:i?core_1.Boundary.START:core_1.Boundary.END,shouldSelectAfterUpdate:s.props.selectAllOnFocus,startHoverString:s.formatDate(r),wasLastFocusChangeDueToHover:!0})}},s.handleStartInputEvent=function(e){s.handleInputEvent(e,core_1.Boundary.START)},s.handleEndInputEvent=function(e){s.handleInputEvent(e,core_1.Boundary.END)},s.handleInputEvent=function(e,t){var n,a,r,o,i,l,u=s.getInputProps(t);switch(e.type){case"blur":s.handleInputBlur(e,t),null===(n=u.onBlur)||void 0===n||n.call(u,e);break;case"change":s.handleInputChange(e,t),null===(a=u.onChange)||void 0===a||a.call(u,e);break;case"click":s.handleInputClick(e),null===(r=u.onClick)||void 0===r||r.call(u,e);break;case"focus":s.handleInputFocus(e,t),null===(o=u.onFocus)||void 0===o||o.call(u,e);break;case"keydown":s.handleInputKeyDown(e),null===(i=u.onKeyDown)||void 0===i||i.call(u,e);break;case"mousedown":s.handleInputMouseDown(),null===(l=u.onMouseDown)||void 0===l||l.call(u,e)}},s.handleInputKeyDown=function(e){var t=e.which===core_1.Keys.TAB,n=e.which===core_1.Keys.ENTER,a=e.shiftKey,r=s.state,o=r.selectedStart,i=r.selectedEnd,l=s.state.lastFocusedField===core_1.Boundary.START,u=s.state.lastFocusedField===core_1.Boundary.END;if(t){var d=void 0,p=void 0,c=!0;l&&!a?(p=!1,d=!0,e.preventDefault()):u&&a?(p=!0,d=!1,e.preventDefault()):(p=!1,d=!1,c=!1),s.setState({isEndInputFocused:d,isOpen:c,isStartInputFocused:p,wasLastFocusChangeDueToHover:!1})}else if(l&&n){var g=s.parseDate(s.state.startInputString);s.handleDateRangePickerChange([g,i],!0)}else{if(!u||!n)return;var _=s.parseDate(s.state.endInputString);s.handleDateRangePickerChange([o,_],!0)}},s.handleInputMouseDown=function(){s.setState({wasLastFocusChangeDueToHover:!1})},s.handleInputClick=function(e){e.stopPropagation()},s.handleInputFocus=function(e,t){var n,a=s.getStateKeysAndValuesForBoundary(t),r=a.keys,o=a.values,i=dateFormat_1.getFormattedDateString(o.selectedValue,s.props,!0),l=s.state.wasLastFocusChangeDueToHover?s.state.boundaryToModify:t;s.setState(((n={})[r.inputString]=i,n[r.isInputFocused]=!0,n.boundaryToModify=l,n.isOpen=!0,n.lastFocusedField=t,n.shouldSelectAfterUpdate=s.props.selectAllOnFocus,n.wasLastFocusChangeDueToHover=!1,n))},s.handleInputBlur=function(e,t){var n,a,r,o,i,l,u=s.getStateKeysAndValuesForBoundary(t),d=u.keys,p=u.values,c=s.parseDate(p.inputString),g=s.isControlled(),_=((n={})[d.isInputFocused]=!1,n.shouldSelectAfterUpdate=!1,n);s.isInputEmpty(p.inputString)?_=g?tslib_1.__assign(tslib_1.__assign({},_),((a={})[d.inputString]=dateFormat_1.getFormattedDateString(p.controlledValue,s.props),a)):tslib_1.__assign(tslib_1.__assign({},_),((r={})[d.inputString]=null,r[d.selectedValue]=null,r)):s.isNextDateRangeValid(c,t)||(g||(_=tslib_1.__assign(tslib_1.__assign({},_),((o={})[d.inputString]=null,o[d.selectedValue]=c,o))),null===(l=(i=s.props).onError)||void 0===l||l.call(i,s.getDateRangeForCallback(c,t))),s.setState(_)},s.handleInputChange=function(e,t){var n,a,r,o,i,l,u,d,p,c=e.target.value,g=s.getStateKeysAndValuesForBoundary(t).keys,_=s.parseDate(c),v=s.isControlled(),h={shouldSelectAfterUpdate:!1};if(0===c.length){var S=tslib_1.__assign(tslib_1.__assign({},h),((n={})[g.inputString]="",n));h=v?S:tslib_1.__assign(tslib_1.__assign({},S),((a={})[g.selectedValue]=null,a)),null===(u=(l=s.props).onChange)||void 0===u||u.call(l,s.getDateRangeForCallback(null,t))}else s.isDateValidAndInRange(_)?(S=tslib_1.__assign(tslib_1.__assign({},h),((r={})[g.hoverString]=null,r[g.inputString]=c,r)),h=v?S:tslib_1.__assign(tslib_1.__assign({},S),((o={})[g.selectedValue]=_,o)),s.isNextDateRangeValid(_,t)&&(null===(p=(d=s.props).onChange)||void 0===p||p.call(d,s.getDateRangeForCallback(_,t)))):h=tslib_1.__assign(tslib_1.__assign({},h),((i={})[g.inputString]=c,i[g.hoverString]=null,i));s.setState(h)},s.handlePopoverClose=function(e){var t,n;s.setState({isOpen:!1}),null===(n=(t=s.props.popoverProps).onClose)||void 0===n||n.call(t,e)},s.getIsOpenValueWhenDateChanges=function(e,t){if(s.props.closeOnSelection){if(null==s.props.timePrecision)return!1;var n=new Date((new Date).setHours(0,0,0,0)),a=s.getSelectedRange([n,n]),r=a[0],o=a[1];return!0!==dateUtils_1.areSameTime(r,e)||!0!==dateUtils_1.areSameTime(o,t)}return!0},s.getInitialRange=function(e){void 0===e&&(e=s.props);var t=e.defaultValue,n=e.value;return null!=n?n:null!=t?t:[null,null]},s.getSelectedRange=function(e){var t,n,a;return s.isControlled()?(n=(t=s.props.value)[0],a=t[1]):(n=s.state.selectedStart,a=s.state.selectedEnd),[n,s.doBoundaryDatesOverlap(n,core_1.Boundary.START)?void 0:a].map((function(t,n){var a=null!=e?e[n]:void 0;return s.isDateValidAndInRange(t)?t:a}))},s.getInputDisplayString=function(e){var t=s.getStateKeysAndValuesForBoundary(e).values,n=t.isInputFocused,a=t.inputString,r=t.selectedValue,o=t.hoverString;return null!=o?o:n?null==a?"":a:null==r?"":s.doesEndBoundaryOverlapStartBoundary(r,e)?s.props.overlappingDatesMessage:dateFormat_1.getFormattedDateString(r,s.props)},s.getInputPlaceholderString=function(e){var t=e===core_1.Boundary.START,n=e===core_1.Boundary.END,a=s.getInputProps(e),r=s.getStateKeysAndValuesForBoundary(e).values.isInputFocused;return null!=a.placeholder?a.placeholder:t?r?s.state.formattedMinDateString:"Start date":n?r?s.state.formattedMaxDateString:"End date":""},s.getInputProps=function(e){return e===core_1.Boundary.START?s.props.startInputProps:s.props.endInputProps},s.getInputRef=function(e){return e===core_1.Boundary.START?s.handleStartInputRef:s.handleEndInputRef},s.getStateKeysAndValuesForBoundary=function(e){var t=s.props.value;return e===core_1.Boundary.START?{keys:{hoverString:"startHoverString",inputString:"startInputString",isInputFocused:"isStartInputFocused",selectedValue:"selectedStart"},values:{controlledValue:null!=t?t[0]:void 0,hoverString:s.state.startHoverString,inputString:s.state.startInputString,isInputFocused:s.state.isStartInputFocused,selectedValue:s.state.selectedStart}}:{keys:{hoverString:"endHoverString",inputString:"endInputString",isInputFocused:"isEndInputFocused",selectedValue:"selectedEnd"},values:{controlledValue:null!=t?t[1]:void 0,hoverString:s.state.endHoverString,inputString:s.state.endInputString,isInputFocused:s.state.isEndInputFocused,selectedValue:s.state.selectedEnd}}},s.getDateRangeForCallback=function(e,t){var n=s.getOtherBoundary(t),a=s.getStateKeysAndValuesForBoundary(n).values.selectedValue;return t===core_1.Boundary.START?[e,a]:[a,e]},s.getOtherBoundary=function(e){return e===core_1.Boundary.START?core_1.Boundary.END:core_1.Boundary.START},s.doBoundaryDatesOverlap=function(e,t){var n=s.props.allowSingleDayRange,a=s.getOtherBoundary(t),r=s.getStateKeysAndValuesForBoundary(a).values.selectedValue;return null!=e&&null!=r&&(t===core_1.Boundary.START?e>r||!n&&react_day_picker_1.default.DateUtils.isSameDay(e,r):e<r||!n&&react_day_picker_1.default.DateUtils.isSameDay(e,r))},s.doesEndBoundaryOverlapStartBoundary=function(e,t){return t!==core_1.Boundary.START&&s.doBoundaryDatesOverlap(e,t)},s.isControlled=function(){return void 0!==s.props.value},s.isInputEmpty=function(e){return null==e||0===e.length},s.isInputInErrorState=function(e){var t=s.getStateKeysAndValuesForBoundary(e).values,n=t.isInputFocused,a=t.hoverString,r=t.inputString,o=t.selectedValue;if(null!=a||s.isInputEmpty(r))return!1;var i=n?s.parseDate(r):o;return null!=i&&(!s.isDateValidAndInRange(i)||s.doesEndBoundaryOverlapStartBoundary(i,e))},s.isDateValidAndInRange=function(e){return dateUtils_1.isDateValid(e)&&dateUtils_1.isDayInRange(e,[s.props.minDate,s.props.maxDate])},s.reset(t),s}var n;return tslib_1.__extends(t,e),n=t,t.prototype.reset=function(e){void 0===e&&(e=this.props);var t=this.getInitialRange(),n=t[0],a=t[1];this.state={formattedMaxDateString:this.getFormattedMinMaxDateString(e,"maxDate"),formattedMinDateString:this.getFormattedMinMaxDateString(e,"minDate"),isOpen:!1,selectedEnd:a,selectedShortcutIndex:-1,selectedStart:n}},t.prototype.componentDidUpdate=function(t,n){var a,r,s,o,i,l,u,d,p,c,g,_,v,h;e.prototype.componentDidUpdate.call(this,t,n);var S=this.state,f=S.isStartInputFocused,I=S.isEndInputFocused,D=S.shouldSelectAfterUpdate;(null===(a=t.startInputProps)||void 0===a?void 0:a.inputRef)!==(null===(r=this.props.startInputProps)||void 0===r?void 0:r.inputRef)&&(core_1.setRef(null===(s=t.startInputProps)||void 0===s?void 0:s.inputRef,null),this.handleStartInputRef=core_1.refHandler(this,"startInputElement",null===(o=this.props.startInputProps)||void 0===o?void 0:o.inputRef),core_1.setRef(null===(i=this.props.startInputProps)||void 0===i?void 0:i.inputRef,this.startInputElement)),(null===(l=t.endInputProps)||void 0===l?void 0:l.inputRef)!==(null===(u=this.props.endInputProps)||void 0===u?void 0:u.inputRef)&&(core_1.setRef(null===(d=t.endInputProps)||void 0===d?void 0:d.inputRef,null),this.handleEndInputRef=core_1.refHandler(this,"endInputElement",null===(p=this.props.endInputProps)||void 0===p?void 0:p.inputRef),core_1.setRef(null===(c=this.props.endInputProps)||void 0===c?void 0:c.inputRef,this.endInputElement));var y=this.shouldFocusInputRef(f,this.startInputElement),m=this.shouldFocusInputRef(I,this.endInputElement);y?null===(g=this.startInputElement)||void 0===g||g.focus():m&&(null===(_=this.endInputElement)||void 0===_||_.focus()),f&&D?null===(v=this.startInputElement)||void 0===v||v.select():I&&D&&(null===(h=this.endInputElement)||void 0===h||h.select());var R={};if(this.props.value!==t.value){var F=this.getInitialRange(this.props),E=F[0],P=F[1];R=tslib_1.__assign(tslib_1.__assign({},R),{selectedStart:E,selectedEnd:P})}if(this.props.minDate!==t.minDate){var T=this.getFormattedMinMaxDateString(this.props,"minDate");R=tslib_1.__assign(tslib_1.__assign({},R),{formattedMinDateString:T})}if(this.props.maxDate!==t.maxDate){var b=this.getFormattedMinMaxDateString(this.props,"maxDate");R=tslib_1.__assign(tslib_1.__assign({},R),{formattedMaxDateString:b})}this.setState(R)},t.prototype.render=function(){var e=this.state.selectedShortcutIndex,t=this.props.popoverProps,n=void 0===t?{}:t,a=React.createElement(dateRangePicker_1.DateRangePicker,tslib_1.__assign({},this.props,{selectedShortcutIndex:e,boundaryToModify:this.state.boundaryToModify,onChange:this.handleDateRangePickerChange,onShortcutChange:this.handleShortcutChange,onHoverChange:this.handleDateRangePickerHoverChange,value:this.getSelectedRange()})),r=classnames_1.default(n.className,this.props.className);return React.createElement(core_1.Popover,tslib_1.__assign({isOpen:this.state.isOpen,position:core_1.Position.BOTTOM_LEFT},this.props.popoverProps,{autoFocus:!1,className:r,content:a,enforceFocus:!1,onClose:this.handlePopoverClose}),React.createElement("div",{className:core_1.Classes.CONTROL_GROUP},this.renderInputGroup(core_1.Boundary.START),this.renderInputGroup(core_1.Boundary.END)))},t.prototype.validateProps=function(e){if(null===e.value)throw new Error(Errors.DATERANGEINPUT_NULL_VALUE)},t.prototype.shouldFocusInputRef=function(e,t){return e&&void 0!==t&&document.activeElement!==t},t.prototype.isNextDateRangeValid=function(e,t){return this.isDateValidAndInRange(e)&&!this.doBoundaryDatesOverlap(e,t)},t.prototype.getFormattedMinMaxDateString=function(e,t){var a=e[t],r=n.defaultProps[t];return dateFormat_1.getFormattedDateString(void 0===a?r:a,this.props)},t.prototype.parseDate=function(e){if(e===this.props.outOfRangeMessage||e===this.props.invalidDateMessage)return null;var t=this.props,n=t.locale,a=(0,t.parseDate)(e,n);return!1===a?new Date(void 0):a},t.prototype.formatDate=function(e){if(!this.isDateValidAndInRange(e))return"";var t=this.props,n=t.locale;return(0,t.formatDate)(e,n)},t.defaultProps={allowSingleDayRange:!1,closeOnSelection:!0,contiguousCalendarMonths:!0,dayPickerProps:{},disabled:!1,endInputProps:{},invalidDateMessage:"Invalid date",maxDate:datePickerCore_1.getDefaultMaxDate(),minDate:datePickerCore_1.getDefaultMinDate(),outOfRangeMessage:"Out of range",overlappingDatesMessage:"Overlapping dates",popoverProps:{},selectAllOnFocus:!1,shortcuts:!0,singleMonthOnly:!1,startInputProps:{}},t.displayName=core_1.DISPLAYNAME_PREFIX+".DateRangeInput",n=tslib_1.__decorate([react_lifecycles_compat_1.polyfill],t)}(core_1.AbstractPureComponent2);exports.DateRangeInput=DateRangeInput;