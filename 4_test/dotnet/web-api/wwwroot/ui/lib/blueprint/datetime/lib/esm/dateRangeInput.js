import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import DayPicker from"react-day-picker";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,Boundary,Classes,DISPLAYNAME_PREFIX,InputGroup,Intent,Keys,Popover,Position,refHandler,setRef}from"@blueprintjs/core";import{areSameTime,isDateValid,isDayInRange}from"./common/dateUtils";import*as Errors from"./common/errors";import{getFormattedDateString}from"./dateFormat";import{getDefaultMaxDate,getDefaultMinDate}from"./datePickerCore";import{DateRangePicker}from"./dateRangePicker";var DateRangeInput=function(e){function t(t,n){var a,r,s=e.call(this,t,n)||this;return s.startInputElement=null,s.endInputElement=null,s.handleStartInputRef=refHandler(s,"startInputElement",null===(a=s.props.startInputProps)||void 0===a?void 0:a.inputRef),s.handleEndInputRef=refHandler(s,"endInputElement",null===(r=s.props.endInputProps)||void 0===r?void 0:r.inputRef),s.renderInputGroup=function(e){var t=s.getInputProps(e),n=e===Boundary.START?s.handleStartInputEvent:s.handleEndInputEvent;return React.createElement(InputGroup,__assign({autoComplete:"off",disabled:t.disabled||s.props.disabled},t,{intent:s.isInputInErrorState(e)?Intent.DANGER:t.intent,inputRef:s.getInputRef(e),onBlur:n,onChange:n,onClick:n,onFocus:n,onKeyDown:n,onMouseDown:n,placeholder:s.getInputPlaceholderString(e),value:s.getInputDisplayString(e)}))},s.handleDateRangePickerChange=function(e,t){var n,a;if(void 0===t&&(t=!1),s.state.isOpen){var r,o,u,i,l,d=e[0],p=e[1],c=!0;null==d?(null==s.props.timePrecision?(r=!0,o=!1):(r=!1,o=!1,l=Boundary.START),u=null):null==p?(null==s.props.timePrecision?(r=!1,o=!0):(r=!1,o=!1,l=Boundary.END),i=null):s.props.closeOnSelection?(c=s.getIsOpenValueWhenDateChanges(d,p),r=!1,null==s.props.timePrecision&&t?o=!0:(o=!1,l=Boundary.END)):s.state.lastFocusedField===Boundary.START?null==s.props.timePrecision?(r=!0,o=!1):(r=!1,o=!1,l=Boundary.START):null==s.props.timePrecision?(r=!1,o=!0):(r=!1,o=!1,l=Boundary.END);var g={boundaryToModify:l,endHoverString:i,endInputString:s.formatDate(p),isEndInputFocused:o,isOpen:c,isStartInputFocused:r,startHoverString:u,startInputString:s.formatDate(d),wasLastFocusChangeDueToHover:!1};s.isControlled()?s.setState(g):s.setState(__assign(__assign({},g),{selectedEnd:p,selectedStart:d})),null===(a=(n=s.props).onChange)||void 0===a||a.call(n,e)}},s.handleShortcutChange=function(e,t){s.setState({selectedShortcutIndex:t})},s.handleDateRangePickerHoverChange=function(e,t,n){if(s.state.isOpen)if(null==e){var a=s.state.boundaryToModify===Boundary.END;s.setState({endHoverString:null,isEndInputFocused:a,isStartInputFocused:!a,lastFocusedField:s.state.boundaryToModify,startHoverString:null})}else{var r=e[0],o=e[1],u=null!=n?n===Boundary.START:s.state.isStartInputFocused;a=null!=n?n===Boundary.END:s.state.isEndInputFocused,s.setState({endHoverString:s.formatDate(o),isEndInputFocused:a,isStartInputFocused:u,lastFocusedField:u?Boundary.START:Boundary.END,shouldSelectAfterUpdate:s.props.selectAllOnFocus,startHoverString:s.formatDate(r),wasLastFocusChangeDueToHover:!0})}},s.handleStartInputEvent=function(e){s.handleInputEvent(e,Boundary.START)},s.handleEndInputEvent=function(e){s.handleInputEvent(e,Boundary.END)},s.handleInputEvent=function(e,t){var n,a,r,o,u,i,l=s.getInputProps(t);switch(e.type){case"blur":s.handleInputBlur(e,t),null===(n=l.onBlur)||void 0===n||n.call(l,e);break;case"change":s.handleInputChange(e,t),null===(a=l.onChange)||void 0===a||a.call(l,e);break;case"click":s.handleInputClick(e),null===(r=l.onClick)||void 0===r||r.call(l,e);break;case"focus":s.handleInputFocus(e,t),null===(o=l.onFocus)||void 0===o||o.call(l,e);break;case"keydown":s.handleInputKeyDown(e),null===(u=l.onKeyDown)||void 0===u||u.call(l,e);break;case"mousedown":s.handleInputMouseDown(),null===(i=l.onMouseDown)||void 0===i||i.call(l,e)}},s.handleInputKeyDown=function(e){var t=e.which===Keys.TAB,n=e.which===Keys.ENTER,a=e.shiftKey,r=s.state,o=r.selectedStart,u=r.selectedEnd,i=s.state.lastFocusedField===Boundary.START,l=s.state.lastFocusedField===Boundary.END;if(t){var d=void 0,p=void 0,c=!0;i&&!a?(p=!1,d=!0,e.preventDefault()):l&&a?(p=!0,d=!1,e.preventDefault()):(p=!1,d=!1,c=!1),s.setState({isEndInputFocused:d,isOpen:c,isStartInputFocused:p,wasLastFocusChangeDueToHover:!1})}else if(i&&n){var g=s.parseDate(s.state.startInputString);s.handleDateRangePickerChange([g,u],!0)}else{if(!l||!n)return;var v=s.parseDate(s.state.endInputString);s.handleDateRangePickerChange([o,v],!0)}},s.handleInputMouseDown=function(){s.setState({wasLastFocusChangeDueToHover:!1})},s.handleInputClick=function(e){e.stopPropagation()},s.handleInputFocus=function(e,t){var n,a=s.getStateKeysAndValuesForBoundary(t),r=a.keys,o=a.values,u=getFormattedDateString(o.selectedValue,s.props,!0),i=s.state.wasLastFocusChangeDueToHover?s.state.boundaryToModify:t;s.setState(((n={})[r.inputString]=u,n[r.isInputFocused]=!0,n.boundaryToModify=i,n.isOpen=!0,n.lastFocusedField=t,n.shouldSelectAfterUpdate=s.props.selectAllOnFocus,n.wasLastFocusChangeDueToHover=!1,n))},s.handleInputBlur=function(e,t){var n,a,r,o,u,i,l=s.getStateKeysAndValuesForBoundary(t),d=l.keys,p=l.values,c=s.parseDate(p.inputString),g=s.isControlled(),v=((n={})[d.isInputFocused]=!1,n.shouldSelectAfterUpdate=!1,n);s.isInputEmpty(p.inputString)?v=__assign(__assign({},v),g?((a={})[d.inputString]=getFormattedDateString(p.controlledValue,s.props),a):((r={})[d.inputString]=null,r[d.selectedValue]=null,r)):s.isNextDateRangeValid(c,t)||(g||(v=__assign(__assign({},v),((o={})[d.inputString]=null,o[d.selectedValue]=c,o))),null===(i=(u=s.props).onError)||void 0===i||i.call(u,s.getDateRangeForCallback(c,t))),s.setState(v)},s.handleInputChange=function(e,t){var n,a,r,o,u,i,l,d,p,c=e.target.value,g=s.getStateKeysAndValuesForBoundary(t).keys,v=s.parseDate(c),h=s.isControlled(),S={shouldSelectAfterUpdate:!1};if(0===c.length){var f=__assign(__assign({},S),((n={})[g.inputString]="",n));S=h?f:__assign(__assign({},f),((a={})[g.selectedValue]=null,a)),null===(l=(i=s.props).onChange)||void 0===l||l.call(i,s.getDateRangeForCallback(null,t))}else s.isDateValidAndInRange(v)?(f=__assign(__assign({},S),((r={})[g.hoverString]=null,r[g.inputString]=c,r)),S=h?f:__assign(__assign({},f),((o={})[g.selectedValue]=v,o)),s.isNextDateRangeValid(v,t)&&(null===(p=(d=s.props).onChange)||void 0===p||p.call(d,s.getDateRangeForCallback(v,t)))):S=__assign(__assign({},S),((u={})[g.inputString]=c,u[g.hoverString]=null,u));s.setState(S)},s.handlePopoverClose=function(e){var t,n;s.setState({isOpen:!1}),null===(n=(t=s.props.popoverProps).onClose)||void 0===n||n.call(t,e)},s.getIsOpenValueWhenDateChanges=function(e,t){if(s.props.closeOnSelection){if(null==s.props.timePrecision)return!1;var n=new Date((new Date).setHours(0,0,0,0)),a=s.getSelectedRange([n,n]),r=a[0],o=a[1];return!0!==areSameTime(r,e)||!0!==areSameTime(o,t)}return!0},s.getInitialRange=function(e){void 0===e&&(e=s.props);var t=e.defaultValue,n=e.value;return null!=n?n:null!=t?t:[null,null]},s.getSelectedRange=function(e){var t,n,a;return s.isControlled()?(n=(t=s.props.value)[0],a=t[1]):(n=s.state.selectedStart,a=s.state.selectedEnd),[n,s.doBoundaryDatesOverlap(n,Boundary.START)?void 0:a].map((function(t,n){var a=null!=e?e[n]:void 0;return s.isDateValidAndInRange(t)?t:a}))},s.getInputDisplayString=function(e){var t=s.getStateKeysAndValuesForBoundary(e).values,n=t.isInputFocused,a=t.inputString,r=t.selectedValue,o=t.hoverString;return null!=o?o:n?null==a?"":a:null==r?"":s.doesEndBoundaryOverlapStartBoundary(r,e)?s.props.overlappingDatesMessage:getFormattedDateString(r,s.props)},s.getInputPlaceholderString=function(e){var t=e===Boundary.START,n=e===Boundary.END,a=s.getInputProps(e),r=s.getStateKeysAndValuesForBoundary(e).values.isInputFocused;return null!=a.placeholder?a.placeholder:t?r?s.state.formattedMinDateString:"Start date":n?r?s.state.formattedMaxDateString:"End date":""},s.getInputProps=function(e){return e===Boundary.START?s.props.startInputProps:s.props.endInputProps},s.getInputRef=function(e){return e===Boundary.START?s.handleStartInputRef:s.handleEndInputRef},s.getStateKeysAndValuesForBoundary=function(e){var t=s.props.value;return e===Boundary.START?{keys:{hoverString:"startHoverString",inputString:"startInputString",isInputFocused:"isStartInputFocused",selectedValue:"selectedStart"},values:{controlledValue:null!=t?t[0]:void 0,hoverString:s.state.startHoverString,inputString:s.state.startInputString,isInputFocused:s.state.isStartInputFocused,selectedValue:s.state.selectedStart}}:{keys:{hoverString:"endHoverString",inputString:"endInputString",isInputFocused:"isEndInputFocused",selectedValue:"selectedEnd"},values:{controlledValue:null!=t?t[1]:void 0,hoverString:s.state.endHoverString,inputString:s.state.endInputString,isInputFocused:s.state.isEndInputFocused,selectedValue:s.state.selectedEnd}}},s.getDateRangeForCallback=function(e,t){var n=s.getOtherBoundary(t),a=s.getStateKeysAndValuesForBoundary(n).values.selectedValue;return t===Boundary.START?[e,a]:[a,e]},s.getOtherBoundary=function(e){return e===Boundary.START?Boundary.END:Boundary.START},s.doBoundaryDatesOverlap=function(e,t){var n=s.props.allowSingleDayRange,a=s.getOtherBoundary(t),r=s.getStateKeysAndValuesForBoundary(a).values.selectedValue;return null!=e&&null!=r&&(t===Boundary.START?e>r||!n&&DayPicker.DateUtils.isSameDay(e,r):e<r||!n&&DayPicker.DateUtils.isSameDay(e,r))},s.doesEndBoundaryOverlapStartBoundary=function(e,t){return t!==Boundary.START&&s.doBoundaryDatesOverlap(e,t)},s.isControlled=function(){return void 0!==s.props.value},s.isInputEmpty=function(e){return null==e||0===e.length},s.isInputInErrorState=function(e){var t=s.getStateKeysAndValuesForBoundary(e).values,n=t.isInputFocused,a=t.hoverString,r=t.inputString,o=t.selectedValue;if(null!=a||s.isInputEmpty(r))return!1;var u=n?s.parseDate(r):o;return null!=u&&(!s.isDateValidAndInRange(u)||s.doesEndBoundaryOverlapStartBoundary(u,e))},s.isDateValidAndInRange=function(e){return isDateValid(e)&&isDayInRange(e,[s.props.minDate,s.props.maxDate])},s.reset(t),s}var n;return __extends(t,e),n=t,t.prototype.reset=function(e){void 0===e&&(e=this.props);var t=this.getInitialRange(),n=t[0],a=t[1];this.state={formattedMaxDateString:this.getFormattedMinMaxDateString(e,"maxDate"),formattedMinDateString:this.getFormattedMinMaxDateString(e,"minDate"),isOpen:!1,selectedEnd:a,selectedShortcutIndex:-1,selectedStart:n}},t.prototype.componentDidUpdate=function(t,n){var a,r,s,o,u,i,l,d,p,c,g,v,h,S;e.prototype.componentDidUpdate.call(this,t,n);var f=this.state,I=f.isStartInputFocused,D=f.isEndInputFocused,y=f.shouldSelectAfterUpdate;(null===(a=t.startInputProps)||void 0===a?void 0:a.inputRef)!==(null===(r=this.props.startInputProps)||void 0===r?void 0:r.inputRef)&&(setRef(null===(s=t.startInputProps)||void 0===s?void 0:s.inputRef,null),this.handleStartInputRef=refHandler(this,"startInputElement",null===(o=this.props.startInputProps)||void 0===o?void 0:o.inputRef),setRef(null===(u=this.props.startInputProps)||void 0===u?void 0:u.inputRef,this.startInputElement)),(null===(i=t.endInputProps)||void 0===i?void 0:i.inputRef)!==(null===(l=this.props.endInputProps)||void 0===l?void 0:l.inputRef)&&(setRef(null===(d=t.endInputProps)||void 0===d?void 0:d.inputRef,null),this.handleEndInputRef=refHandler(this,"endInputElement",null===(p=this.props.endInputProps)||void 0===p?void 0:p.inputRef),setRef(null===(c=this.props.endInputProps)||void 0===c?void 0:c.inputRef,this.endInputElement));var m=this.shouldFocusInputRef(I,this.startInputElement),R=this.shouldFocusInputRef(D,this.endInputElement);m?null===(g=this.startInputElement)||void 0===g||g.focus():R&&(null===(v=this.endInputElement)||void 0===v||v.focus()),I&&y?null===(h=this.startInputElement)||void 0===h||h.select():D&&y&&(null===(S=this.endInputElement)||void 0===S||S.select());var F={};if(this.props.value!==t.value){var E=this.getInitialRange(this.props),_=E[0],P=E[1];F=__assign(__assign({},F),{selectedStart:_,selectedEnd:P})}if(this.props.minDate!==t.minDate){var T=this.getFormattedMinMaxDateString(this.props,"minDate");F=__assign(__assign({},F),{formattedMinDateString:T})}if(this.props.maxDate!==t.maxDate){var B=this.getFormattedMinMaxDateString(this.props,"maxDate");F=__assign(__assign({},F),{formattedMaxDateString:B})}this.setState(F)},t.prototype.render=function(){var e=this.state.selectedShortcutIndex,t=this.props.popoverProps,n=void 0===t?{}:t,a=React.createElement(DateRangePicker,__assign({},this.props,{selectedShortcutIndex:e,boundaryToModify:this.state.boundaryToModify,onChange:this.handleDateRangePickerChange,onShortcutChange:this.handleShortcutChange,onHoverChange:this.handleDateRangePickerHoverChange,value:this.getSelectedRange()})),r=classNames(n.className,this.props.className);return React.createElement(Popover,__assign({isOpen:this.state.isOpen,position:Position.BOTTOM_LEFT},this.props.popoverProps,{autoFocus:!1,className:r,content:a,enforceFocus:!1,onClose:this.handlePopoverClose}),React.createElement("div",{className:Classes.CONTROL_GROUP},this.renderInputGroup(Boundary.START),this.renderInputGroup(Boundary.END)))},t.prototype.validateProps=function(e){if(null===e.value)throw new Error(Errors.DATERANGEINPUT_NULL_VALUE)},t.prototype.shouldFocusInputRef=function(e,t){return e&&void 0!==t&&document.activeElement!==t},t.prototype.isNextDateRangeValid=function(e,t){return this.isDateValidAndInRange(e)&&!this.doBoundaryDatesOverlap(e,t)},t.prototype.getFormattedMinMaxDateString=function(e,t){var a=e[t],r=n.defaultProps[t];return getFormattedDateString(void 0===a?r:a,this.props)},t.prototype.parseDate=function(e){if(e===this.props.outOfRangeMessage||e===this.props.invalidDateMessage)return null;var t=this.props,n=t.locale,a=(0,t.parseDate)(e,n);return!1===a?new Date(void 0):a},t.prototype.formatDate=function(e){if(!this.isDateValidAndInRange(e))return"";var t=this.props,n=t.locale;return(0,t.formatDate)(e,n)},t.defaultProps={allowSingleDayRange:!1,closeOnSelection:!0,contiguousCalendarMonths:!0,dayPickerProps:{},disabled:!1,endInputProps:{},invalidDateMessage:"Invalid date",maxDate:getDefaultMaxDate(),minDate:getDefaultMinDate(),outOfRangeMessage:"Out of range",overlappingDatesMessage:"Overlapping dates",popoverProps:{},selectAllOnFocus:!1,shortcuts:!0,singleMonthOnly:!1,startInputProps:{}},t.displayName=DISPLAYNAME_PREFIX+".DateRangeInput",n=__decorate([polyfill],t)}(AbstractPureComponent2);export{DateRangeInput};