/*! For license information please see wijmo.odata.js.LICENSE.txt */
var wijmo,__extends=this&&this.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},t(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();!function(t){var e;(e=t.odata||(t.odata={})).softGrid=function(){return t._getModule("wijmo.grid")},e.softFilter=function(){return t._getModule("wijmo.grid.filter")}}(wijmo||(wijmo={})),function(t){!function(e){"use strict";var r=function(r){function n(e,n,i){var o=r.call(this)||this;return o._count=0,o._sortOnServer=!0,o._pageOnServer=!0,o._filterOnServer=!0,o._deferCommits=!1,o._hasPendingChanges=!1,o._showDatesAsGmt=!1,o._inferDataTypes=!0,o._reviverBnd=o._reviver.bind(o),o.loading=new t.Event,o.loaded=new t.Event,o.error=new t.Event,o.hasPendingChangesChanged=new t.Event,o._url=t.asString(e,!1),o._tbl=t.asString(n),t.copy(o,i),o.sortDescriptions.collectionChanged.addHandler((function(){o.sortOnServer&&!o.hasPendingChanges&&o._getData()})),o.itemsEdited.collectionChanged.addHandler(o._updateHasChanges,o),o.itemsAdded.collectionChanged.addHandler(o._updateHasChanges,o),o.itemsRemoved.collectionChanged.addHandler(o._updateHasChanges,o),o._getData(),o}return __extends(n,r),Object.defineProperty(n.prototype,"tableName",{get:function(){return this._tbl},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"entityType",{get:function(){return this._entityType},set:function(e){this._entityType=t.asString(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fields",{get:function(){return this._fields},set:function(e){this._fields!=e&&(this._fields=t.asArray(e),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"requestHeaders",{get:function(){return this._requestHeaders},set:function(t){this._requestHeaders=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"keys",{get:function(){return this._keys},set:function(e){this._keys=t.asArray(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"expand",{get:function(){return this._expand},set:function(e){this._expand=t.asString(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"jsonReviver",{get:function(){return this._jsonReviver},set:function(e){this._jsonReviver=t.asFunction(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dataTypes",{get:function(){return this._dataTypes},set:function(t){this._dataTypes=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"inferDataTypes",{get:function(){return this._inferDataTypes},set:function(e){e!=this.inferDataTypes&&(this._inferDataTypes=t.asBoolean(e),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"showDatesAsGmt",{get:function(){return this._showDatesAsGmt},set:function(e){e!=this.showDatesAsGmt&&(this._showDatesAsGmt=t.asBoolean(e),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(e){e!=this._sortOnServer&&(this._sortOnServer=t.asBoolean(e),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(e){e!=this._pageOnServer&&(this._pageOnServer=t.asBoolean(e),this.pageSize&&this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(e){e!=this._filterOnServer&&(this._filterOnServer=t.asBoolean(e),this._getData())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"filterDefinition",{get:function(){return this._filterDef},set:function(e){e!=this._filterDef&&(this._filterDef=t.asString(e),this._getData())},enumerable:!0,configurable:!0}),n.prototype.updateFilterDefinition=function(t){this.filterOnServer&&e.softGrid()&&e.softFilter()&&t instanceof e.softFilter().FlexGridFilter&&(this.filterDefinition=this._asODataFilter(t))},Object.defineProperty(n.prototype,"oDataVersion",{get:function(){return this._odv},set:function(e){this._odv=t.asNumber(e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"deferCommits",{get:function(){return this._deferCommits},set:function(e){this._deferCommits=t.asBoolean(e),this.deferCommits&&(this.trackChanges=!0)},enumerable:!0,configurable:!0}),n.prototype.onLoading=function(t){this.loading.raise(this,t)},n.prototype.onLoaded=function(t){this.loaded.raise(this,t)},n.prototype.load=function(){this._getData()},n.prototype.onError=function(t){return this.error.raise(this,t),!t.cancel},n.prototype.onHasPendingChangesChanged=function(t){this.hasPendingChangesChanged.raise(this,t)},n.prototype.implementsInterface=function(t){return"IEditableCollectionView"==t?null!=this.keys&&this.keys.length>0:r.prototype.implementsInterface.call(this,t)},n.prototype.commitNew=function(){var e=this;if(!this.deferCommits){var n={Accept:"application/json"};if(this.requestHeaders)for(var i in this.requestHeaders)n[i]=this.requestHeaders[i];var o=this.currentAddItem;if(o){var a=this._getWriteUrl();t.httpRequest(a,{method:"POST",requestHeaders:n,data:this._convertToDbFormat(o),success:function(t){var r=JSON.parse(t.responseText,e._reviverBnd);e.keys.forEach((function(t){o[t]=r[t]})),e.refresh()},error:this._error.bind(this)})}}r.prototype.commitNew.call(this)},n.prototype.commitEdit=function(){if(!this.deferCommits){var e=this.currentEditItem;if(e&&!this.currentAddItem&&this._getChangedFields(e,this._edtClone)){var n=this._getWriteUrl(this._edtClone);t.httpRequest(n,{method:"PATCH",requestHeaders:this.requestHeaders,data:this._convertToDbFormat(e),error:this._error.bind(this)})}}r.prototype.commitEdit.call(this)},n.prototype.remove=function(e){if(!this.deferCommits&&e&&e!=this.currentAddItem&&this.items.indexOf(e)>-1){var n=this._getWriteUrl(e);t.httpRequest(n,{method:"DELETE",requestHeaders:this.requestHeaders,error:this._error.bind(this)})}r.prototype.remove.call(this,e)},n.prototype.commitChanges=function(e){var r=this;if(this.deferCommits){var n=[];if(this.itemsEdited.forEach((function(t){n.push({method:"PATCH",url:r._getWriteUrl(t),data:r._convertToDbFormat(t)})})),this.itemsAdded.forEach((function(t){n.push({method:"POST",url:r._getWriteUrl(),data:r._convertToDbFormat(t)})})),this.itemsRemoved.forEach((function(t){n.push({method:"DELETE",url:r._getWriteUrl(t)})})),n.length){var i=(new Date).getTime().toString();t.httpRequest(this._getServiceUrl()+"$batch",{method:"POST",requestHeaders:{"Content-Type":'multipart/mixed; boundary="'+i+'"'},data:this._encodeBatch(n,i),success:function(t){r.clearChanges(),r.load()},error:function(e){if(r.onError(new t.RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText},complete:function(r){t.isFunction(e)&&e(r)}})}}},n.prototype.cancelChanges=function(){this.deferCommits&&(this.clearChanges(),this.load())},Object.defineProperty(n.prototype,"hasPendingChanges",{get:function(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"totalItemCount",{get:function(){return this._count},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pageSize",{get:function(){return this._pgSz},set:function(e){e!=this._pgSz&&(this._pgSz=t.asInt(e),this.pageOnServer?(this._pgIdx=t.clamp(this._pgIdx,0,this.pageCount-1),this._getData()):this.refresh())},enumerable:!0,configurable:!0}),n.prototype.onPageChanging=function(t){return r.prototype.onPageChanging.call(this,t),!t.cancel&&this.pageOnServer&&this._getData(),!t.cancel},n.prototype._getPageView=function(){return this.pageOnServer?this._view:r.prototype._getPageView.call(this)},n.prototype._performRefresh=function(){var t=this._canFilter,e=this._canSort;this._canFilter=!this._filterOnServer,this._canSort=!this._sortOnServer,r.prototype._performRefresh.call(this),this._canFilter=t,this._canSort=e},n.prototype._updateHasChanges=function(){var t=this.hasPendingChanges;t!=this._hasPendingChanges&&(this._hasPendingChanges=t,this.onHasPendingChangesChanged())},n.prototype._storeItems=function(t,e){e?Array.prototype.push.apply(this.sourceCollection,t):this.sourceCollection=t},n.prototype._getReadUrl=function(t){var e=this._getServiceUrl();return t?e=0==t.indexOf("http")?t:e+t:this._tbl&&(e+=this._tbl),e},n.prototype._getReadParams=function(t){var e={};if((!t||t.indexOf("$format")<0&&t.indexOf("%24format")<0)&&(e.$format="json"),!t&&this._tbl){if(this._odv<4?e.$inlinecount="allpages":e.$count=!0,this.fields&&(e.$select=this.fields.join(",")),this.expand&&(e.$expand=this.expand),this.sortOnServer&&this.sortDescriptions.length){var r="";this.sortDescriptions.forEach((function(t){r&&(r+=","),r+=t.property,t.ascending||(r+=" desc")})),e.$orderby=r}this.pageOnServer&&this.pageSize>0&&(e.$skip=this.pageIndex*this.pageSize,e.$top=this.pageSize),this.filterDefinition&&(e.$filter=this.filterDefinition)}return e},n.prototype._getData=function(e,r){var n=this;this._toGetData&&clearTimeout(this._toGetData),this._toGetData=setTimeout((function(){if(null!=n._odv){n._loading=!0,n.onLoading();var i=t.httpRequest(n._getReadUrl(e),{requestHeaders:n.requestHeaders,data:n._getReadParams(e),success:function(t){var r=JSON.parse(t.responseText,n._reviverBnd),i=r.d?r.d.results:r.value,o=r.d?r.d.__count:r["odata.count"]||r["@odata.count"];if(null!=o&&(n._count=parseInt(o)),n.pageIndex>0&&n.pageIndex>=n.pageCount){var a=n.pageIndex;if(n.moveToLastPage(),n.pageIndex!=a)return}e||n.inferDataTypes&&!n._dataTypesInferred&&(n._dataTypesInferred=n._getInferredDataTypes(i));var s=n.dataTypes?n.dataTypes:n._dataTypesInferred;s&&i.forEach((function(t){n._convertItem(s,t)})),n._storeItems(i,null!=e),n.refresh(),(e=r.d?r.d.__next:r["odata.nextLink"]||r["@odata.nextLink"])?n._getData(e):(n._loading=!1,n.onLoaded())},error:function(e){if(n._loading=!1,n.onLoaded(),n.onError(new t.RequestErrorEventArgs(e)))throw"HttpRequest Error: "+e.status+" "+e.statusText}});t.isFunction(r)&&r(i)}else n._getSchema()}),100)},n.prototype._convertToDbFormat=function(e){var r={},n=this.calculatedFields;for(var i in e)if(!n||!(i in n)){var o=e[i];t.isDate(o)&&this._showDatesAsGmt?o=new Date(o.getTime()-6e4*o.getTimezoneOffset()):t.isNumber(o)&&this._odv<4&&(o=o.toString()),r[i]=o}return this.entityType&&(r["odata.type"]=this.entityType),r},n.prototype._reviver=function(e,r){return"string"==typeof r&&n._rxDate.test(r)&&(r=0==r.indexOf("/Date(")?new Date(parseInt(r.substr(6))):new Date(r),t.isDate(r)&&this._showDatesAsGmt&&(r=new Date(r.getTime()+6e4*r.getTimezoneOffset()))),this._jsonReviver?this._jsonReviver(e,r):r},n.prototype._convertItem=function(e,r){for(var n in e){var i=e[n],o=r[n];null!=o&&(o=i==t.DataType.Date&&t.isString(o)&&0==o.indexOf("/Date(")?new Date(parseInt(o.substr(6))):t.changeType(o,i,null),t.isDate(o)&&this._showDatesAsGmt&&(o=new Date(o.getTime()+6e4*o.getTimezoneOffset())),r[n]=o)}},n.prototype._getInferredDataTypes=function(e){var r=this,i=null;if(e.length>0){var o={};for(var a in e.forEach((function(t){r._extend(o,t)})),o){var s=o[a];t.isString(s)&&n._rxDate.test(s)&&(i||(i={}),i[a]=t.DataType.Date)}}return i},n.prototype._getServiceUrl=function(){var t=this._url;return"/"!=t[t.length-1]&&(t+="/"),t},n.prototype._getSchema=function(){var e=this,r=this._getServiceUrl()+"$metadata",i=n._odvCache;this._odv=i[r],this._odv?this._getData():t.httpRequest(r,{requestHeaders:this.requestHeaders,success:function(t){var n=t.responseText.match(/<.*Version\s*=\s*"([0-9.]+)"/),o=n?parseFloat(n[1]):4;i[r]=e._odv=o},error:function(t){i[r]=e._odv=4},complete:function(t){e._getData()}})},n.prototype._getWriteUrl=function(e){var r=this,n=this._getServiceUrl()+this._tbl;if(e){t.assert(this.keys&&this.keys.length>0,"write operations require keys.");var i=[];this.keys.forEach((function(n){var o=e[n];null==o&&(o=""),t.isString(o)&&(o="'"+o+"'"),i.push(1==r.keys.length?o:n+"="+o)})),i.length&&(n+="("+i.join(",")+")")}return n},n.prototype._asODataFilter=function(t){for(var e="",r=0;r<t.grid.columns.length;r++){var n=t.grid.columns[r],i=t.getColumnFilter(n,!1);i&&i.isActive&&(e&&(e+=" and "),i.conditionFilter&&i.conditionFilter.isActive?e+=this._asODataConditionFilter(i.conditionFilter):i.valueFilter&&i.valueFilter.isActive&&(e+=this._asODataValueFilter(i.valueFilter)))}return e},n.prototype._asODataValueFilter=function(e){var r=e.column,n=r.binding,i=r.dataMap,o="";for(var a in e.showValues){var s=t.changeType(a,r.dataType,r.format);i&&t.isString(s)&&(s=i.getKeyValue(s)),o&&(o+=" or "),o+=this._asEquals(n,s,r.dataType)}return o.length&&(o="("+o+")"),o},n.prototype._asEquals=function(e,r,n){var i="",o=t.DataType;return""===r||null==r?(i+=e+" eq null",n==o.String&&(i+=" or "+e+" eq ''")):n==o.Date?i+=e+" ge "+this._asODataValue(r,n)+" and "+e+" lt "+this._asODataValue(t.DateTime.addDays(r,1),n):i+=e+" eq "+this._asODataValue(r,n),"("+i+")"},n.prototype._asODataConditionFilter=function(t){var e=this._asODataCondition(t,t.condition1),r=this._asODataCondition(t,t.condition2);return e&&r?"("+e+(t.and?" and ":" or ")+r+")":e?"("+e+")":r?"("+r+")":null},n.prototype._asODataCondition=function(e,r){var n=e.column,i=n.binding,o=n.dataMap,a=r.value;switch(o&&t.isString(a)&&(a=o.getKeyValue(a)),a=this._asODataValue(a,e.column.dataType),r.operator){case 0:return i+" eq "+a;case 1:return i+" ne "+a;case 2:return i+" gt "+a;case 3:return i+" ge "+a;case 4:return i+" lt "+a;case 5:return i+" le "+a;case 6:return"startswith("+i+","+a+")";case 7:return"endswith("+i+","+a+")";case 8:return this._odv>=4?"contains("+i+","+a+")":"substringof("+a.toLowerCase()+", tolower("+i+"))";case 9:return this._odv>=4?"not contains("+i+","+a+")":"not substringof("+a.toLowerCase()+", tolower("+i+"))"}},n.prototype._asODataValue=function(e,r){return t.isDate(e)?(this._showDatesAsGmt&&(e=new Date(e.getTime()-6e4*e.getTimezoneOffset())),e=e.toJSON(),this._odv<4&&(e="datetime'"+e.substr(0,10)+"'"),e):t.isString(e)?"'"+e.replace(/'/g,"''")+"'":null!=e?e.toString():r==t.DataType.String?"''":null},n.prototype._error=function(e){if(this.onError(new t.RequestErrorEventArgs(e)))throw this._getData(),"HttpRequest Error: "+e.status+" "+e.statusText},n.prototype._encodeBatch=function(t,e){var r=[],n="changeset-"+e;return r.push("--"+e,"Content-Type: multipart/mixed; boundary="+n,""),t.forEach((function(t,e){r.push("--"+n,"Content-Type: application/http","Content-Transfer-Encoding: binary","Content-ID: "+e,"",t.method.toUpperCase()+" "+t.url+" HTTP/1.1","Host: "+location.host),t.data&&r.push("Content-Type: application/json","",JSON.stringify(t.data)),r.push("")})),r.push("--"+n+"--",""),r.push("--"+e+"--",""),r.join("\r\n")},n._odvCache={},n._rxDate=/^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)/,n}(t.collections.CollectionView);e.ODataCollectionView=r}(t.odata||(t.odata={}))}(wijmo||(wijmo={})),function(t){!function(e){"use strict";var r=function(e){function r(r,n,i){var o=e.call(this,r,n,{pageOnServer:!0,sortOnServer:!0,canGroup:!1})||this;return o._start=0,o._end=100,o._refresh=!1,t.copy(o,i),o._data=[],o.sourceCollection=o._data,o._firstLoad=!0,o.setWindow(0,100),o}return __extends(r,e),r.prototype.setWindow=function(t,e){var r=this;this._toSetWindow&&clearTimeout(this._toSetWindow),this._toSetWindow=setTimeout((function(){r._toSetWindow=null,r._performSetWindow(t,e)}),50)},Object.defineProperty(r.prototype,"requestCanceled",{get:function(){return this._requestCanceled||(this._requestCanceled=new t.Event),this._requestCanceled},enumerable:!0,configurable:!0}),r.prototype.onRequestCanceled=function(t){this.requestCanceled.raise(this,t)},Object.defineProperty(r.prototype,"pageOnServer",{get:function(){return!0},set:function(t){if(!t)throw"ODataVirtualCollectionView requires pageOnServer = true."},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"sortOnServer",{get:function(){return!0},set:function(e){if(!t.asBoolean(e))throw"ODataVirtualCollectionView requires sortOnServer = true."},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"filterOnServer",{get:function(){return!0},set:function(e){if(!t.asBoolean(e))throw"ODataVirtualCollectionView requires filterOnServer = true."},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"canGroup",{get:function(){return this._canGroup},set:function(e){if(t.asBoolean(e))throw"ODataVirtualCollectionView does not support grouping."},enumerable:!0,configurable:!0}),r.prototype._performRefresh=function(){this.isLoading||(this._refresh=!0),e.prototype._performRefresh.call(this)},r.prototype._getReadParams=function(t){var r=e.prototype._getReadParams.call(this,t);return t||(r.$skip=this._start||0,r.$top=Math.max(this._end-this._start+1,this.pageSize,100)),r},r.prototype._storeItems=function(t,e){var r=this;if(this._refresh||this._data.length!=this.totalItemCount){this._data.length=this.totalItemCount;for(var i=0;i<this._data.length;i++)this._data[i]=new n(i);this._refresh=!1}e||(this._loadOffset=0);var o=this._loadOffset+(this._start||0);for(i=0;i<t.length;i++)this._data[i+o]=t[i];this._loadOffset+=t.length,setTimeout((function(){r._firstLoad&&r.currentPosition<0&&t.length&&r.moveCurrentToFirst(),r._firstLoad=!1}))},r.prototype._performSetWindow=function(e,r){var i=this;this._pendingRequest&&(this._pendingRequest.abort(),this._pendingRequest=null,this.onRequestCanceled()),e=t.asInt(e),r=t.asInt(r),t.assert(e<=r,"start must be <= end.");var o=this._data;this._start=this._end=e;for(var a=e;a<=r&&a<o.length;a++)if(o[a]instanceof n){this._start=a;break}for(a=r;a>=this._start&&a<o.length;a--)if(o[a]instanceof n){this._end=a;break}(this._start!=this._end||o[this._start]instanceof n)&&this._getData(null,(function(t){i._pendingRequest=t}))},r}(e.ODataCollectionView);e.ODataVirtualCollectionView=r;var n=function(t){this._id=t}}(t.odata||(t.odata={}))}(wijmo||(wijmo={})),function(t){t.odata||(t.odata={}),t._registerModule("wijmo.odata",t.odata)}(wijmo||(wijmo={}));