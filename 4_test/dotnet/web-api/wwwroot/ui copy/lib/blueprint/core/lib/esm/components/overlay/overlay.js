import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{findDOMNode}from"react-dom";import{polyfill}from"react-lifecycles-compat";import{CSSTransition,TransitionGroup}from"react-transition-group";import{AbstractPureComponent2,Classes,Keys}from"../../common";import{DISPLAYNAME_PREFIX}from"../../common/props";import{isFunction}from"../../common/utils";import{Portal}from"../portal/portal";var Overlay=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n.isAutoFocusing=!1,n.state={hasEverOpened:n.props.isOpen},n.containerElement=null,n.startFocusTrapElement=null,n.endFocusTrapElement=null,n.refHandlers={container:function(e){return n.containerElement=findDOMNode(e)},endFocusTrap:function(e){return n.endFocusTrapElement=e},startFocusTrap:function(e){return n.startFocusTrapElement=e}},n.maybeRenderChild=function(e){if(isFunction(e)&&(e=e()),null==e)return null;var t="object"==typeof e?React.cloneElement(e,{className:classNames(e.props.className,Classes.OVERLAY_CONTENT)}):React.createElement("span",{className:Classes.OVERLAY_CONTENT},e),o=n.props,s=o.onOpening,a=o.onOpened,r=o.onClosing,i=o.transitionDuration,l=o.transitionName,c=CSSTransition;return React.createElement(c,{classNames:l,onEntering:s,onEntered:a,onExiting:r,onExited:n.handleTransitionExited,timeout:i,addEndListener:n.handleTransitionAddEnd},t)},n.handleStartFocusTrapElementFocus=function(e){var t;n.props.enforceFocus&&!n.isAutoFocusing&&null!=e.relatedTarget&&n.containerElement.contains(e.relatedTarget)&&e.relatedTarget!==n.endFocusTrapElement&&(null===(t=n.endFocusTrapElement)||void 0===t||t.focus({preventScroll:!0}))},n.handleStartFocusTrapElementKeyDown=function(e){var t;if(n.props.enforceFocus&&e.shiftKey&&e.which===Keys.TAB){var o=n.getKeyboardFocusableElements().pop();null!=o?o.focus():null===(t=n.endFocusTrapElement)||void 0===t||t.focus({preventScroll:!0})}},n.handleEndFocusTrapElementFocus=function(e){var t,o;if(null!=e.relatedTarget&&n.containerElement.contains(e.relatedTarget)&&e.relatedTarget!==n.startFocusTrapElement){var s=n.getKeyboardFocusableElements().shift();n.isAutoFocusing||null==s||s===e.relatedTarget?null===(t=n.startFocusTrapElement)||void 0===t||t.focus({preventScroll:!0}):s.focus()}else{var a=n.getKeyboardFocusableElements().pop();null!=a?a.focus():null===(o=n.startFocusTrapElement)||void 0===o||o.focus({preventScroll:!0})}},n.handleTransitionExited=function(e){var t,o;n.props.shouldReturnFocusOnClose&&n.lastActiveElementBeforeOpened instanceof HTMLElement&&n.lastActiveElementBeforeOpened.focus(),null===(o=(t=n.props).onClosed)||void 0===o||o.call(t,e)},n.handleBackdropMouseDown=function(e){var t,o=n.props,s=o.backdropProps,a=o.canOutsideClickClose,r=o.enforceFocus,i=o.onClose;a&&(null==i||i(e)),r&&n.bringFocusInsideOverlay(),null===(t=null==s?void 0:s.onMouseDown)||void 0===t||t.call(s,e)},n.handleDocumentClick=function(e){var o=n.props,s=o.canOutsideClickClose,a=o.isOpen,r=o.onClose,i=e.composed?e.composedPath()[0]:e.target,l=t.openStack.indexOf(n),c=t.openStack.slice(l).some((function(e){var n=e.containerElement;return n&&n.contains(i)&&!n.isSameNode(i)}));a&&!c&&s&&(null==r||r(e))},n.handleDocumentFocus=function(e){var t=e.composed?e.composedPath()[0]:e.target;n.props.enforceFocus&&null!=n.containerElement&&t instanceof Node&&!n.containerElement.contains(t)&&(e.preventDefault(),e.stopImmediatePropagation(),n.bringFocusInsideOverlay())},n.handleKeyDown=function(e){var t=n.props,o=t.canEscapeKeyClose,s=t.onClose;e.which===Keys.ESCAPE&&o&&(null==s||s(e),e.preventDefault())},n.handleTransitionAddEnd=function(){},n}var t;return __extends(n,e),t=n,n.getDerivedStateFromProps=function(e){var n=e.isOpen;return n?{hasEverOpened:n}:null},n.prototype.render=function(){var e,n;if(this.props.lazy&&!this.state.hasEverOpened)return null;var t=this.props,o=t.autoFocus,s=t.children,a=t.className,r=t.enforceFocus,i=t.usePortal,l=t.isOpen,c=l&&null!==(n=React.Children.map(s,this.maybeRenderChild))&&void 0!==n?n:[],u=this.maybeRenderBackdrop();null!==u&&c.unshift(u),l&&(o||r)&&c.length>0&&(c.unshift(this.renderDummyElement("__start",{className:Classes.OVERLAY_START_FOCUS_TRAP,onFocus:this.handleStartFocusTrapElementFocus,onKeyDown:this.handleStartFocusTrapElementKeyDown,ref:this.refHandlers.startFocusTrap})),r&&c.push(this.renderDummyElement("__end",{className:Classes.OVERLAY_END_FOCUS_TRAP,onFocus:this.handleEndFocusTrapElementFocus,ref:this.refHandlers.endFocusTrap})));var p=classNames(Classes.OVERLAY,((e={})[Classes.OVERLAY_OPEN]=l,e[Classes.OVERLAY_INLINE]=!i,e),a),d=React.createElement(TransitionGroup,{appear:!0,"aria-live":"polite",className:p,component:"div",onKeyDown:this.handleKeyDown,ref:this.refHandlers.container},c);return i?React.createElement(Portal,{className:this.props.portalClassName,container:this.props.portalContainer},d):d},n.prototype.componentDidMount=function(){this.props.isOpen&&this.overlayWillOpen()},n.prototype.componentDidUpdate=function(e){e.isOpen&&!this.props.isOpen?this.overlayWillClose():!e.isOpen&&this.props.isOpen&&this.overlayWillOpen()},n.prototype.componentWillUnmount=function(){this.overlayWillClose()},n.prototype.bringFocusInsideOverlay=function(){var e=this;return this.requestAnimationFrame((function(){var n;null!=e.containerElement&&null!=document.activeElement&&e.props.isOpen&&!e.containerElement.contains(document.activeElement)&&(null===(n=e.startFocusTrapElement)||void 0===n||n.focus({preventScroll:!0}),e.isAutoFocusing=!1)}))},n.prototype.maybeRenderBackdrop=function(){var e=this.props,n=e.backdropClassName,t=e.backdropProps,o=e.hasBackdrop,s=e.isOpen,a=e.transitionDuration,r=e.transitionName;return o&&s?React.createElement(CSSTransition,{classNames:r,key:"__backdrop",timeout:a,addEndListener:this.handleTransitionAddEnd},React.createElement("div",__assign({},t,{className:classNames(Classes.OVERLAY_BACKDROP,n,null==t?void 0:t.className),onMouseDown:this.handleBackdropMouseDown}))):null},n.prototype.renderDummyElement=function(e,n){var t=this.props,o=t.transitionDuration,s=t.transitionName;return React.createElement(CSSTransition,{classNames:s,key:e,addEndListener:this.handleTransitionAddEnd,timeout:o,unmountOnExit:!0},React.createElement("div",__assign({tabIndex:0},n)))},n.prototype.getKeyboardFocusableElements=function(){return(null!==this.containerElement?Array.from(this.containerElement.querySelectorAll(['a[href]:not([tabindex="-1"])','button:not([disabled]):not([tabindex="-1"])','details:not([tabindex="-1"])','input:not([disabled]):not([tabindex="-1"])','select:not([disabled]):not([tabindex="-1"])','textarea:not([disabled]):not([tabindex="-1"])','[tabindex]:not([tabindex="-1"])'].join(","))):[]).filter((function(e){return!e.classList.contains(Classes.OVERLAY_START_FOCUS_TRAP)&&!e.classList.contains(Classes.OVERLAY_END_FOCUS_TRAP)}))},n.prototype.overlayWillClose=function(){document.removeEventListener("focus",this.handleDocumentFocus,!0),document.removeEventListener("mousedown",this.handleDocumentClick);var e=t.openStack,n=e.indexOf(this);if(-1!==n){if(e.splice(n,1),e.length>0){var o=t.getLastOpened();o.props.autoFocus&&o.props.enforceFocus&&(o.bringFocusInsideOverlay(),document.addEventListener("focus",o.handleDocumentFocus,!0))}0===e.filter((function(e){return e.props.usePortal&&e.props.hasBackdrop})).length&&document.body.classList.remove(Classes.OVERLAY_OPEN)}},n.prototype.overlayWillOpen=function(){var e=t.getLastOpened,n=t.openStack;n.length>0&&document.removeEventListener("focus",e().handleDocumentFocus,!0),n.push(this),this.props.autoFocus&&(this.isAutoFocusing=!0,this.bringFocusInsideOverlay()),this.props.enforceFocus&&document.addEventListener("focus",this.handleDocumentFocus,!0),this.props.canOutsideClickClose&&!this.props.hasBackdrop&&document.addEventListener("mousedown",this.handleDocumentClick),this.props.hasBackdrop&&this.props.usePortal&&document.body.classList.add(Classes.OVERLAY_OPEN),this.lastActiveElementBeforeOpened=document.activeElement},n.displayName=DISPLAYNAME_PREFIX+".Overlay",n.defaultProps={autoFocus:!0,backdropProps:{},canEscapeKeyClose:!0,canOutsideClickClose:!0,enforceFocus:!0,hasBackdrop:!0,isOpen:!1,lazy:!0,shouldReturnFocusOnClose:!0,transitionDuration:300,transitionName:Classes.OVERLAY,usePortal:!0},n.openStack=[],n.getLastOpened=function(){return t.openStack[t.openStack.length-1]},t=__decorate([polyfill],n)}(AbstractPureComponent2);export{Overlay};