import{__assign,__decorate,__extends,__spreadArrays}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,Classes,Keys,refHandler,setRef,Utils}from"../../common";import{DISPLAYNAME_PREFIX}from"../../common/props";import{Icon,IconSize}from"../icon/icon";import{Tag}from"../tag/tag";var NONE=-1,TagInput=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={activeIndex:NONE,inputValue:t.props.inputValue||"",isInputFocused:!1},t.inputElement=null,t.handleRef=refHandler(t,"inputElement",t.props.inputRef),t.addTags=function(e,n){void 0===n&&(n="default");var a=t.props,s=a.inputValue,i=a.onAdd,o=a.onChange,l=a.values,r=t.getValues(e),p=!1!==(null==i?void 0:i(r,n))&&void 0===s;Utils.isFunction(o)&&(p=!1!==o(__spreadArrays(l,r))&&p),p&&t.setState({inputValue:""})},t.maybeRenderTag=function(e,n){if(!e)return null;var a=t.props,s=a.large,i=a.tagProps,o=Utils.isFunction(i)?i(e,n):i;return React.createElement(Tag,__assign({active:n===t.state.activeIndex,"data-tag-index":n,key:e+"__"+n,large:s,onRemove:t.props.disabled?void 0:t.handleRemoveTag},o),e)},t.handleContainerClick=function(){var e;null===(e=t.inputElement)||void 0===e||e.focus()},t.handleContainerBlur=function(e){var n=e.currentTarget;t.requestAnimationFrame((function(){n.contains(document.activeElement)||(t.props.addOnBlur&&void 0!==t.state.inputValue&&t.state.inputValue.length>0&&t.addTags(t.state.inputValue,"blur"),t.setState({activeIndex:NONE,isInputFocused:!1}))}))},t.handleInputFocus=function(e){var n,a;t.setState({isInputFocused:!0}),null===(a=null===(n=t.props.inputProps)||void 0===n?void 0:n.onFocus)||void 0===a||a.call(n,e)},t.handleInputChange=function(e){var n,a,s,i;t.setState({activeIndex:NONE,inputValue:e.currentTarget.value}),null===(a=(n=t.props).onInputChange)||void 0===a||a.call(n,e),null===(i=null===(s=t.props.inputProps)||void 0===s?void 0:s.onChange)||void 0===i||i.call(s,e)},t.handleInputKeyDown=function(e){var n=e.currentTarget,a=n.selectionEnd,s=n.value,i=t.state.activeIndex,o=i;if(e.which===Keys.ENTER&&s.length>0)t.addTags(s,"default");else if(0===a&&t.props.values.length>0)if(e.which===Keys.ARROW_LEFT||e.which===Keys.ARROW_RIGHT){var l=t.getNextActiveIndex(e.which===Keys.ARROW_RIGHT?1:-1);l!==i&&(e.stopPropagation(),o=l,t.setState({activeIndex:l}))}else e.which===Keys.BACKSPACE?t.handleBackspaceToRemove(e):e.which===Keys.DELETE&&t.handleDeleteToRemove(e);t.invokeKeyPressCallback("onKeyDown",e,o)},t.handleInputKeyUp=function(e){t.invokeKeyPressCallback("onKeyUp",e,t.state.activeIndex)},t.handleInputPaste=function(e){var n=t.props.separator,a=e.clipboardData.getData("text");t.props.addOnPaste&&0!==a.length&&!1!==n&&1!==a.split(n).length&&(e.preventDefault(),t.addTags(a,"paste"))},t.handleRemoveTag=function(e){var n=+e.currentTarget.parentElement.getAttribute("data-tag-index");t.removeIndexFromValues(n)},t}return __extends(t,e),t.getDerivedStateFromProps=function(e,t){return e.inputValue!==t.prevInputValueProp?{inputValue:e.inputValue,prevInputValueProp:e.inputValue}:null},t.prototype.render=function(){var e,t=this.props,n=t.className,a=t.disabled,s=t.fill,i=t.inputProps,o=t.intent,l=t.large,r=t.leftIcon,p=t.placeholder,u=t.values,c=classNames(Classes.INPUT,Classes.TAG_INPUT,((e={})[Classes.ACTIVE]=this.state.isInputFocused,e[Classes.DISABLED]=a,e[Classes.FILL]=s,e[Classes.LARGE]=l,e),Classes.intentClass(o),n),d=c.indexOf(Classes.LARGE)>NONE,h=u.some((function(e){return!!e})),v=null==p||h?null==i?void 0:i.placeholder:p;return React.createElement("div",{className:c,onBlur:this.handleContainerBlur,onClick:this.handleContainerClick},React.createElement(Icon,{className:Classes.TAG_INPUT_ICON,icon:r,size:d?IconSize.LARGE:IconSize.STANDARD}),React.createElement("div",{className:Classes.TAG_INPUT_VALUES},u.map(this.maybeRenderTag),this.props.children,React.createElement("input",__assign({value:this.state.inputValue},i,{onFocus:this.handleInputFocus,onChange:this.handleInputChange,onKeyDown:this.handleInputKeyDown,onKeyUp:this.handleInputKeyUp,onPaste:this.handleInputPaste,placeholder:v,ref:this.handleRef,className:classNames(Classes.INPUT_GHOST,null==i?void 0:i.className),disabled:a}))),this.props.rightElement)},t.prototype.componentDidUpdate=function(e){e.inputRef!==this.props.inputRef&&(setRef(e.inputRef,null),this.handleRef=refHandler(this,"inputElement",this.props.inputRef),setRef(this.props.inputRef,this.inputElement))},t.prototype.getNextActiveIndex=function(e){var t=this.state.activeIndex;return t===NONE?e<0?this.findNextIndex(this.props.values.length,-1):NONE:this.findNextIndex(t,e)},t.prototype.findNextIndex=function(e,t){for(var n=this.props.values,a=e+t;a>0&&a<n.length&&!n[a];)a+=t;return Utils.clamp(a,0,n.length)},t.prototype.getValues=function(e){var t=this.props.separator;return(!1===t?[e]:e.split(t)).map((function(e){return e.trim()})).filter((function(e){return e.length>0}))},t.prototype.handleBackspaceToRemove=function(e){var t=this.state.activeIndex;this.setState({activeIndex:this.getNextActiveIndex(-1)}),this.isValidIndex(t)&&(e.stopPropagation(),this.removeIndexFromValues(t))},t.prototype.handleDeleteToRemove=function(e){var t=this.state.activeIndex;this.isValidIndex(t)&&(e.stopPropagation(),this.removeIndexFromValues(t))},t.prototype.removeIndexFromValues=function(e){var t=this.props,n=t.onChange,a=t.onRemove,s=t.values;null==a||a(s[e],e),Utils.isFunction(n)&&n(s.filter((function(t,n){return n!==e})))},t.prototype.invokeKeyPressCallback=function(e,t,n){var a,s,i,o;null===(s=(a=this.props)[e])||void 0===s||s.call(a,t,n===NONE?void 0:n),null===(o=(i=this.props.inputProps)[e])||void 0===o||o.call(i,t)},t.prototype.isValidIndex=function(e){return e!==NONE&&e<this.props.values.length},t.displayName=DISPLAYNAME_PREFIX+".TagInput",t.defaultProps={addOnBlur:!1,addOnPaste:!0,inputProps:{},separator:/[,\n\r]/,tagProps:{}},__decorate([polyfill],t)}(AbstractPureComponent2);export{TagInput};