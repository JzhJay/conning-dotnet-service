"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NumericInput=void 0;var IncrementDirection,tslib_1=require("tslib"),classnames_1=tslib_1.__importDefault(require("classnames")),React=tslib_1.__importStar(require("react")),react_lifecycles_compat_1=require("react-lifecycles-compat"),common_1=require("../../common"),Errors=tslib_1.__importStar(require("../../common/errors")),buttonGroup_1=require("../button/buttonGroup"),buttons_1=require("../button/buttons"),controlGroup_1=require("./controlGroup"),inputGroup_1=require("./inputGroup"),numericInputUtils_1=require("./numericInputUtils");!function(e){e[e.DOWN=-1]="DOWN",e[e.UP=1]="UP"}(IncrementDirection||(IncrementDirection={}));var NON_HTML_PROPS=["allowNumericCharactersOnly","buttonPosition","clampValueOnBlur","className","defaultValue","majorStepSize","minorStepSize","onButtonClick","onValueChange","selectAllOnFocus","selectAllOnIncrement","stepSize"],NumericInput=function(e){function t(){var t,o=e.apply(this,arguments)||this;return o.state={currentImeInputInvalid:!1,shouldSelectAfterUpdate:!1,stepMaxPrecision:n.getStepMaxPrecision(o.props),value:numericInputUtils_1.getValueOrEmptyValue(null!==(t=o.props.value)&&void 0!==t?t:o.props.defaultValue)},o.didPasteEventJustOccur=!1,o.delta=0,o.inputElement=null,o.inputRef=common_1.refHandler(o,"inputElement",o.props.inputRef),o.incrementButtonHandlers=o.getButtonEventHandlers(IncrementDirection.UP),o.decrementButtonHandlers=o.getButtonEventHandlers(IncrementDirection.DOWN),o.handleButtonClick=function(e,t){var n,r,i=o.updateDelta(t,e),l=o.incrementValue(i);null===(r=(n=o.props).onButtonClick)||void 0===r||r.call(n,Number(numericInputUtils_1.parseStringToStringNumber(l,o.props.locale)),l)},o.stopContinuousChange=function(){o.delta=0,o.clearTimeouts(),clearInterval(o.intervalId),document.removeEventListener("mouseup",o.stopContinuousChange)},o.handleContinuousChange=function(){var e,t,n,r;if(void 0!==o.props.min||void 0!==o.props.max){var i=null!==(e=o.props.min)&&void 0!==e?e:-1/0,l=null!==(t=o.props.max)&&void 0!==t?t:1/0,s=Number(numericInputUtils_1.parseStringToStringNumber(o.state.value,o.props.locale));if(s<=i||s>=l)return void o.stopContinuousChange()}var a=o.incrementValue(o.delta);null===(r=(n=o.props).onButtonClick)||void 0===r||r.call(n,Number(numericInputUtils_1.parseStringToStringNumber(a,o.props.locale)),a)},o.handleInputFocus=function(e){var t,n;o.setState({shouldSelectAfterUpdate:o.props.selectAllOnFocus}),null===(n=(t=o.props).onFocus)||void 0===n||n.call(t,e)},o.handleInputBlur=function(e){var t,n;if(o.setState({shouldSelectAfterUpdate:!1}),o.props.clampValueOnBlur){var r=e.target.value;o.handleNextValue(o.roundAndClampValue(r))}null===(n=(t=o.props).onBlur)||void 0===n||n.call(t,e)},o.handleInputKeyDown=function(e){var t,n;if(!o.props.disabled&&!o.props.readOnly){var r,i=e.keyCode;if(i===common_1.Keys.ARROW_UP?r=IncrementDirection.UP:i===common_1.Keys.ARROW_DOWN&&(r=IncrementDirection.DOWN),void 0!==r){e.preventDefault();var l=o.updateDelta(r,e);o.incrementValue(l)}null===(n=(t=o.props).onKeyDown)||void 0===n||n.call(t,e)}},o.handleCompositionEnd=function(e){o.props.allowNumericCharactersOnly&&(o.handleNextValue(numericInputUtils_1.sanitizeNumericInput(e.data,o.props.locale)),o.setState({currentImeInputInvalid:!1}))},o.handleCompositionUpdate=function(e){if(o.props.allowNumericCharactersOnly){var t=e.data;0===numericInputUtils_1.sanitizeNumericInput(t,o.props.locale).length&&t.length>0?o.setState({currentImeInputInvalid:!0}):o.setState({currentImeInputInvalid:!1})}},o.handleInputKeyPress=function(e){var t,n;o.props.allowNumericCharactersOnly&&!numericInputUtils_1.isValidNumericKeyboardEvent(e,o.props.locale)&&e.preventDefault(),null===(n=(t=o.props).onKeyPress)||void 0===n||n.call(t,e)},o.handleInputPaste=function(e){var t,n;o.didPasteEventJustOccur=!0,null===(n=(t=o.props).onPaste)||void 0===n||n.call(t,e)},o.handleInputChange=function(e){var t=e.target.value,n=t;o.props.allowNumericCharactersOnly&&o.didPasteEventJustOccur&&(o.didPasteEventJustOccur=!1,n=numericInputUtils_1.sanitizeNumericInput(t,o.props.locale)),o.handleNextValue(n),o.setState({shouldSelectAfterUpdate:!1})},o}var n;return tslib_1.__extends(t,e),n=t,t.getDerivedStateFromProps=function(e,t){var o,r,i={prevMaxProp:e.max,prevMinProp:e.min},l=e.min!==t.prevMinProp,s=e.max!==t.prevMaxProp,a=l||s,u=null!==(r=null===(o=e.value)||void 0===o?void 0:o.toString())&&void 0!==r?r:t.value,p=n.getStepMaxPrecision(e),c=u!==n.VALUE_EMPTY?n.roundAndClampValue(u,p,e.min,e.max,0,e.locale):n.VALUE_EMPTY;return a&&c!==t.value?tslib_1.__assign(tslib_1.__assign({},i),{stepMaxPrecision:p,value:c}):tslib_1.__assign(tslib_1.__assign({},i),{stepMaxPrecision:p,value:u})},t.getStepMaxPrecision=function(e){return null!=e.minorStepSize?common_1.Utils.countDecimalPlaces(e.minorStepSize):common_1.Utils.countDecimalPlaces(e.stepSize)},t.roundAndClampValue=function(e,t,o,r,i,l){if(void 0===i&&(i=0),!numericInputUtils_1.isValueNumeric(e,l))return n.VALUE_EMPTY;var s=numericInputUtils_1.parseStringToStringNumber(e,l),a=numericInputUtils_1.toMaxPrecision(Number(s)+i,t),u=numericInputUtils_1.clampValue(a,o,r);return numericInputUtils_1.toLocaleString(u,l)},t.prototype.render=function(){var e,t=this.props,n=t.buttonPosition,o=t.className,r=t.fill,i=t.large,l=classnames_1.default(common_1.Classes.NUMERIC_INPUT,((e={})[common_1.Classes.LARGE]=i,e),o),s=this.renderButtons();return React.createElement(controlGroup_1.ControlGroup,{className:l,fill:r},n===common_1.Position.LEFT&&s,this.renderInput(),n===common_1.Position.RIGHT&&s)},t.prototype.componentDidUpdate=function(t,o){var r,i,l;e.prototype.componentDidUpdate.call(this,t,o),t.inputRef!==this.props.inputRef&&(common_1.setRef(t.inputRef,null),this.inputRef=common_1.refHandler(this,"inputElement",this.props.inputRef),common_1.setRef(this.props.inputRef,this.inputElement)),this.state.shouldSelectAfterUpdate&&(null===(r=this.inputElement)||void 0===r||r.setSelectionRange(0,this.state.value.length));var s=this.props.min!==t.min,a=this.props.max!==t.max,u=s||a,p=this.props.locale!==t.locale,c=this.state.value!==o.value;if(u&&c||p&&o.value!==n.VALUE_EMPTY){var m=p?o.value:this.state.value,d=numericInputUtils_1.parseStringToStringNumber(m,t.locale),_=numericInputUtils_1.toLocaleString(+d,this.props.locale);null===(l=(i=this.props).onValueChange)||void 0===l||l.call(i,+d,_,this.inputElement)}},t.prototype.validateProps=function(e){var t=e.majorStepSize,o=e.max,r=e.min,i=e.minorStepSize,l=e.stepSize,s=e.value;if(null!=r&&null!=o&&r>o&&console.error(Errors.NUMERIC_INPUT_MIN_MAX),l<=0&&console.error(Errors.NUMERIC_INPUT_STEP_SIZE_NON_POSITIVE),i&&i<=0&&console.error(Errors.NUMERIC_INPUT_MINOR_STEP_SIZE_NON_POSITIVE),t&&t<=0&&console.error(Errors.NUMERIC_INPUT_MAJOR_STEP_SIZE_NON_POSITIVE),i&&i>l&&console.error(Errors.NUMERIC_INPUT_MINOR_STEP_SIZE_BOUND),t&&t<l&&console.error(Errors.NUMERIC_INPUT_MAJOR_STEP_SIZE_BOUND),null!=s){var a=n.getStepMaxPrecision(e),u=n.roundAndClampValue(s.toString(),a,r,o,0,this.props.locale),p=u!==s.toString(),c=numericInputUtils_1.toLocaleString(Number(numericInputUtils_1.parseStringToStringNumber(s,this.props.locale)),this.props.locale);p&&u!==c&&console.warn(Errors.NUMERIC_INPUT_CONTROLLED_VALUE_INVALID)}},t.prototype.renderButtons=function(){var e=this.props,t=e.intent,n=e.max,o=e.min,r=e.locale,i=numericInputUtils_1.parseStringToStringNumber(this.state.value,r),l=this.props.disabled||this.props.readOnly,s=void 0!==n&&""!==i&&+i>=n,a=void 0!==o&&""!==i&&+i<=o;return React.createElement(buttonGroup_1.ButtonGroup,{className:common_1.Classes.FIXED,key:"button-group",vertical:!0},React.createElement(buttons_1.Button,tslib_1.__assign({"aria-label":"increment",disabled:l||s,icon:"chevron-up",intent:t},this.incrementButtonHandlers)),React.createElement(buttons_1.Button,tslib_1.__assign({"aria-label":"decrement",disabled:l||a,icon:"chevron-down",intent:t},this.decrementButtonHandlers)))},t.prototype.renderInput=function(){var e=common_1.removeNonHTMLProps(this.props,NON_HTML_PROPS,!0);return React.createElement(inputGroup_1.InputGroup,tslib_1.__assign({asyncControl:this.props.asyncControl,autoComplete:"off"},e,{intent:this.state.currentImeInputInvalid?common_1.Intent.DANGER:this.props.intent,inputRef:this.inputRef,large:this.props.large,leftIcon:this.props.leftIcon,onFocus:this.handleInputFocus,onBlur:this.handleInputBlur,onChange:this.handleInputChange,onCompositionEnd:this.handleCompositionEnd,onCompositionUpdate:this.handleCompositionUpdate,onKeyDown:this.handleInputKeyDown,onKeyPress:this.handleInputKeyPress,onPaste:this.handleInputPaste,rightElement:this.props.rightElement,value:this.state.value}))},t.prototype.getButtonEventHandlers=function(e){var t=this;return{onKeyDown:function(n){!t.props.disabled&&common_1.Keys.isKeyboardClick(n.keyCode)&&t.handleButtonClick(n,e)},onMouseDown:function(n){t.props.disabled||(t.handleButtonClick(n,e),t.startContinuousChange())}}},t.prototype.startContinuousChange=function(){var e=this;document.addEventListener("mouseup",this.stopContinuousChange),this.setTimeout((function(){e.intervalId=window.setInterval(e.handleContinuousChange,n.CONTINUOUS_CHANGE_INTERVAL)}),n.CONTINUOUS_CHANGE_DELAY)},t.prototype.handleNextValue=function(e){var t,n;null==this.props.value&&this.setState({value:e}),null===(n=(t=this.props).onValueChange)||void 0===n||n.call(t,Number(numericInputUtils_1.parseStringToStringNumber(e,this.props.locale)),e,this.inputElement)},t.prototype.incrementValue=function(e){var t=this.state.value===n.VALUE_EMPTY?n.VALUE_ZERO:this.state.value,o=this.roundAndClampValue(t,e);return o!==this.state.value&&(this.handleNextValue(o),this.setState({shouldSelectAfterUpdate:this.props.selectAllOnIncrement})),o},t.prototype.getIncrementDelta=function(e,t,n){var o=this.props,r=o.majorStepSize,i=o.minorStepSize,l=o.stepSize;return t&&null!=r?e*r:n&&null!=i?e*i:e*l},t.prototype.roundAndClampValue=function(e,t){return void 0===t&&(t=0),n.roundAndClampValue(e,this.state.stepMaxPrecision,this.props.min,this.props.max,t,this.props.locale)},t.prototype.updateDelta=function(e,t){return this.delta=this.getIncrementDelta(e,t.shiftKey,t.altKey),this.delta},t.displayName=common_1.DISPLAYNAME_PREFIX+".NumericInput",t.VALUE_EMPTY="",t.VALUE_ZERO="0",t.defaultProps={allowNumericCharactersOnly:!0,buttonPosition:common_1.Position.RIGHT,clampValueOnBlur:!1,defaultValue:n.VALUE_EMPTY,large:!1,majorStepSize:10,minorStepSize:.1,selectAllOnFocus:!1,selectAllOnIncrement:!1,stepSize:1},t.CONTINUOUS_CHANGE_DELAY=300,t.CONTINUOUS_CHANGE_INTERVAL=100,n=tslib_1.__decorate([react_lifecycles_compat_1.polyfill],t)}(common_1.AbstractPureComponent2);exports.NumericInput=NumericInput;