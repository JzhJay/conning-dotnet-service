import{__assign,__decorate,__extends}from"tslib";import classNames from"classnames";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractPureComponent2,Classes,Intent}from"../../common";import*as Errors from"../../common/errors";import{DISPLAYNAME_PREFIX}from"../../common/props";import*as Utils from"../../common/utils";import{Handle}from"./handle";import{HandleInteractionKind,HandleType}from"./handleProps";import{argMin,fillValues,formatPercentage}from"./sliderUtils";var MultiSliderHandle=function(){return null};MultiSliderHandle.displayName=DISPLAYNAME_PREFIX+".MultiSliderHandle";var MultiSlider=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={labelPrecision:getLabelPrecision(t.props),tickSize:0,tickSizeRatio:0},t.handleElements=[],t.trackElement=null,t.addHandleRef=function(e){null!=e&&t.handleElements.push(e)},t.maybeHandleTrackClick=function(e){if(t.canHandleTrackEvent(e)){var r=t.nearestHandleForValue(t.handleElements,(function(t){return t.mouseEventClientOffset(e)}));r&&r.beginHandleMovement(e)}},t.maybeHandleTrackTouch=function(e){if(t.canHandleTrackEvent(e)){var r=t.nearestHandleForValue(t.handleElements,(function(t){return t.touchEventClientOffset(e)}));r&&r.beginHandleTouchMovement(e)}},t.canHandleTrackEvent=function(e){var r=e.target;return!t.props.disabled&&null==r.closest("."+Classes.SLIDER_HANDLE)},t.getHandlerForIndex=function(e,r){return function(n){null==r||r(t.getNewHandleValues(n,e))}},t.handleChange=function(e){var r,n,a=getSortedInteractiveHandleProps(t.props),l=a.map((function(e){return e.value}));Utils.arraysEqual(e,l)||(null===(n=(r=t.props).onChange)||void 0===n||n.call(r,e),a.forEach((function(t,r){var n;l[r]!==e[r]&&(null===(n=t.onChange)||void 0===n||n.call(t,e[r]))})))},t.handleRelease=function(e){var r,n,a=getSortedInteractiveHandleProps(t.props);null===(n=(r=t.props).onRelease)||void 0===n||n.call(r,e),a.forEach((function(t,r){var n;null===(n=t.onRelease)||void 0===n||n.call(t,e[r])}))},t}var r;return __extends(t,e),r=t,t.getDerivedStateFromProps=function(e){return{labelPrecision:r.getLabelPrecision(e)}},t.getLabelPrecision=function(e){var t=e.labelPrecision,r=e.stepSize;return null==t?Utils.countDecimalPlaces(r):t},t.prototype.getSnapshotBeforeUpdate=function(e){var t=getSortedInteractiveHandleProps(e);return getSortedInteractiveHandleProps(this.props).length!==t.length&&(this.handleElements=[]),null},t.prototype.render=function(){var e,t=this,r=classNames(Classes.SLIDER,((e={})[Classes.DISABLED]=this.props.disabled,e[Classes.SLIDER+"-unlabeled"]=!1===this.props.labelRenderer,e[Classes.VERTICAL]=this.props.vertical,e),this.props.className);return React.createElement("div",{className:r,onMouseDown:this.maybeHandleTrackClick,onTouchStart:this.maybeHandleTrackTouch},React.createElement("div",{className:Classes.SLIDER_TRACK,ref:function(e){return t.trackElement=e}},this.renderTracks()),React.createElement("div",{className:Classes.SLIDER_AXIS},this.renderLabels()),this.renderHandles())},t.prototype.componentDidMount=function(){this.updateTickSize()},t.prototype.componentDidUpdate=function(t,r){e.prototype.componentDidUpdate.call(this,t,r),this.updateTickSize()},t.prototype.validateProps=function(e){if(e.stepSize<=0)throw new Error(Errors.SLIDER_ZERO_STEP);if(void 0!==e.labelStepSize&&void 0!==e.labelValues)throw new Error(Errors.MULTISLIDER_WARN_LABEL_STEP_SIZE_LABEL_VALUES_MUTEX);if(void 0!==e.labelStepSize&&e.labelStepSize<=0)throw new Error(Errors.SLIDER_ZERO_LABEL_STEP);var t=!1;if(React.Children.forEach(e.children,(function(e){e&&!Utils.isElementOfType(e,r.Handle)&&(t=!0)})),t)throw new Error(Errors.MULTISLIDER_INVALID_CHILD)},t.prototype.formatLabel=function(e,t){void 0===t&&(t=!1);var r=this.props.labelRenderer;return!1===r?void 0:Utils.isFunction(r)?r(e,{isHandleTooltip:t}):e.toFixed(this.state.labelPrecision)},t.prototype.renderLabels=function(){var e=this;if(!1===this.props.labelRenderer)return null;var t=this.getLabelValues(),r=this.props,n=r.max,a=r.min;return t.map((function(t,r){var l=formatPercentage((t-a)/(n-a)),i=e.props.vertical?{bottom:l}:{left:l};return React.createElement("div",{className:Classes.SLIDER_LABEL,key:r,style:i},e.formatLabel(t))}))},t.prototype.renderTracks=function(){var e=getSortedHandleProps(this.props);e.push({value:this.props.max});for(var t={value:this.props.min},r=[],n=0;n<e.length;n++){var a=e[n];r.push(this.renderTrackFill(n,t,a)),t=a}return r},t.prototype.renderTrackFill=function(e,t,r){var n=[this.getOffsetRatio(t.value),this.getOffsetRatio(r.value)].sort((function(e,t){return e-t})),a=n[0],l=n[1],i=formatPercentage(a),o=formatPercentage(1-l),s=this.props.vertical?{bottom:i,top:o,left:0}:{left:i,right:o,top:0},c=__assign(__assign({},s),t.trackStyleAfter||r.trackStyleBefore||{}),p=classNames(Classes.SLIDER_PROGRESS,Classes.intentClass(this.getTrackIntent(t,r)));return React.createElement("div",{key:"track-"+e,className:p,style:c})},t.prototype.renderHandles=function(){var e=this,t=this.props,r=t.disabled,n=t.max,a=t.min,l=t.stepSize,i=t.vertical,o=getSortedInteractiveHandleProps(this.props);return 0===o.length?null:o.map((function(t,s){var c,p=t.value,d=t.type,u=t.className;return React.createElement(Handle,{className:classNames((c={},c[Classes.START]=d===HandleType.START,c[Classes.END]=d===HandleType.END,c),u),disabled:r,key:s+"-"+o.length,label:e.formatLabel(p,!0),max:n,min:a,onChange:e.getHandlerForIndex(s,e.handleChange),onRelease:e.getHandlerForIndex(s,e.handleRelease),ref:e.addHandleRef,stepSize:l,tickSize:e.state.tickSize,tickSizeRatio:e.state.tickSizeRatio,value:p,vertical:i})}))},t.prototype.nearestHandleForValue=function(e,t){return argMin(e,(function(e){var r=t(e),n=e.clientToValue(r),a=e.props.value;return Math.abs(n-a)}))},t.prototype.getNewHandleValues=function(e,t){var r=getSortedInteractiveHandleProps(this.props).map((function(e){return e.value})),n=r.slice();n[t]=e,n.sort((function(e,t){return e-t}));var a=n.indexOf(e),l=this.findFirstLockedHandleIndex(t,a);if(-1!==l){var i=r[l];return fillValues(r,t,l,i),r}return fillValues(n,t,a,e),n},t.prototype.findFirstLockedHandleIndex=function(e,t){for(var r=e<t?1:-1,n=getSortedInteractiveHandleProps(this.props),a=e+r;a!==t+r;a+=r)if(n[a].interactionKind!==HandleInteractionKind.PUSH)return a;return-1},t.prototype.getLabelValues=function(){var e=this.props,t=e.labelStepSize,r=e.labelValues,n=e.min,a=e.max,l=[];if(void 0!==r)l=r;else for(var i=n;i<a||Utils.approxEqual(i,a);i+=null!=t?t:1)l.push(i);return l},t.prototype.getOffsetRatio=function(e){return Utils.clamp((e-this.props.min)*this.state.tickSizeRatio,0,1)},t.prototype.getTrackIntent=function(e,t){return this.props.showTrackFill?void 0!==e.intentAfter?e.intentAfter:void 0!==t&&void 0!==t.intentBefore?t.intentBefore:this.props.defaultTrackIntent:Intent.NONE},t.prototype.updateTickSize=function(){if(null!=this.trackElement){var e=this.props.vertical?this.trackElement.clientHeight:this.trackElement.clientWidth,t=1/(this.props.max-this.props.min),r=e*t;this.setState({tickSize:r,tickSizeRatio:t})}},t.defaultSliderProps={disabled:!1,max:10,min:0,showTrackFill:!0,stepSize:1,vertical:!1},t.defaultProps=__assign(__assign({},r.defaultSliderProps),{defaultTrackIntent:Intent.NONE}),t.displayName=DISPLAYNAME_PREFIX+".MultiSlider",t.Handle=MultiSliderHandle,r=__decorate([polyfill],t)}(AbstractPureComponent2);export{MultiSlider};function getLabelPrecision(e){var t=e.labelPrecision,r=e.stepSize,n=void 0===r?MultiSlider.defaultSliderProps.stepSize:r;return null==t?Utils.countDecimalPlaces(n):t}function getSortedInteractiveHandleProps(e){return getSortedHandleProps(e,(function(e){return e.interactionKind!==HandleInteractionKind.NONE}))}function getSortedHandleProps(e,t){var r=e.children;void 0===t&&(t=function(){return!0});var n=React.Children.map(r,(function(e){return Utils.isElementOfType(e,MultiSlider.Handle)&&t(e.props)?e.props:null})),a=null!=n?n:[];return(a=a.filter((function(e){return null!==e}))).sort((function(e,t){return e.value-t.value})),a}