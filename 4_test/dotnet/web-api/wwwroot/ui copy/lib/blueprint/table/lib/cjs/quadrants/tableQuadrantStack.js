"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TableQuadrantStack=void 0;var tslib_1=require("tslib"),React=tslib_1.__importStar(require("react")),react_lifecycles_compat_1=require("react-lifecycles-compat"),core_1=require("@blueprintjs/core"),Classes=tslib_1.__importStar(require("../common/classes")),ScrollUtils=tslib_1.__importStar(require("../common/internal/scrollUtils")),utils_1=require("../common/utils"),tableQuadrant_1=require("./tableQuadrant"),tableQuadrantStackCache_1=require("./tableQuadrantStackCache"),DEFAULT_COLUMN_HEADER_HEIGHT=30,DEFAULT_VIEW_SYNC_DELAY=500,QUADRANT_MIN_SIZE=1,SYNC_TRIGGER_PROP_KEYS=["enableRowHeader","loadingOptions","numFrozenColumns","numFrozenRows","numColumns","numRows","enableColumnInteractionBar"],TableQuadrantStack=function(e){function a(a,r){var t,n,l=e.call(this,a,r)||this;return l.quadrantRefs=((t={})[tableQuadrant_1.QuadrantType.MAIN]={},t[tableQuadrant_1.QuadrantType.TOP]={},t[tableQuadrant_1.QuadrantType.LEFT]={},t[tableQuadrant_1.QuadrantType.TOP_LEFT]={},t),l.quadrantRefHandlers=((n={})[tableQuadrant_1.QuadrantType.MAIN]=l.generateQuadrantRefHandlers(tableQuadrant_1.QuadrantType.MAIN),n[tableQuadrant_1.QuadrantType.TOP]=l.generateQuadrantRefHandlers(tableQuadrant_1.QuadrantType.TOP),n[tableQuadrant_1.QuadrantType.LEFT]=l.generateQuadrantRefHandlers(tableQuadrant_1.QuadrantType.LEFT),n[tableQuadrant_1.QuadrantType.TOP_LEFT]=l.generateQuadrantRefHandlers(tableQuadrant_1.QuadrantType.TOP_LEFT),n),l.wasMainQuadrantScrollTriggeredByWheelEvent=!1,l.renderMainQuadrantMenu=function(){var e,a;return null===(a=(e=l.props).menuRenderer)||void 0===a?void 0:a.call(e,l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.MAIN].menu)},l.renderTopQuadrantMenu=function(){var e,a;return null===(a=(e=l.props).menuRenderer)||void 0===a?void 0:a.call(e,l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP].menu)},l.renderLeftQuadrantMenu=function(){var e,a;return null===(a=(e=l.props).menuRenderer)||void 0===a?void 0:a.call(e,l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.LEFT].menu)},l.renderTopLeftQuadrantMenu=function(){var e,a;return null===(a=(e=l.props).menuRenderer)||void 0===a?void 0:a.call(e,l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP_LEFT].menu)},l.renderMainQuadrantColumnHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.MAIN].columnHeader,n=l.handleColumnResizeGuideMain,d=l.handleColumnsReordering;return null===(r=(a=l.props).columnHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderTopQuadrantColumnHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP].columnHeader,n=l.handleColumnResizeGuideTop,d=l.handleColumnsReordering;return null===(r=(a=l.props).columnHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderLeftQuadrantColumnHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.LEFT].columnHeader,n=l.handleColumnResizeGuideLeft,d=l.handleColumnsReordering;return null===(r=(a=l.props).columnHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderTopLeftQuadrantColumnHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP_LEFT].columnHeader,n=l.handleColumnResizeGuideTopLeft,d=l.handleColumnsReordering;return null===(r=(a=l.props).columnHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderMainQuadrantRowHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.MAIN].rowHeader,n=l.handleRowResizeGuideMain,d=l.handleRowsReordering;return null===(r=(a=l.props).rowHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderTopQuadrantRowHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP].rowHeader,n=l.handleRowResizeGuideTop,d=l.handleRowsReordering;return null===(r=(a=l.props).rowHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderLeftQuadrantRowHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.LEFT].rowHeader,n=l.handleRowResizeGuideLeft,d=l.handleRowsReordering;return null===(r=(a=l.props).rowHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.renderTopLeftQuadrantRowHeader=function(e){var a,r,t=l.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP_LEFT].rowHeader,n=l.handleRowResizeGuideTopLeft,d=l.handleRowsReordering;return null===(r=(a=l.props).rowHeaderCellRenderer)||void 0===r?void 0:r.call(a,t,n,d,e)},l.handleMainQuadrantScroll=function(e){var a,r;if(l.wasMainQuadrantScrollTriggeredByWheelEvent)l.wasMainQuadrantScrollTriggeredByWheelEvent=!1;else{null===(r=(a=l.props).onScroll)||void 0===r||r.call(a,e);var t=l.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer,n=t.scrollLeft,d=t.scrollTop;l.handleScrollOffsetChange("scrollLeft",n),l.handleScrollOffsetChange("scrollTop",d),l.syncQuadrantViewsDebounced()}},l.handleWheel=function(e){var a,r;null===(r=(a=l.props).onScroll)||void 0===r||r.call(a,e);var t=l.getNextScrollOffset("horizontal",e.deltaX),n=l.getNextScrollOffset("vertical",e.deltaY);null==t&&null==n||(l.wasMainQuadrantScrollTriggeredByWheelEvent=!0),l.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer.scrollLeft=t,l.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer.scrollTop=n,l.handleScrollOffsetChange("scrollLeft",t),l.handleScrollOffsetChange("scrollTop",n),l.syncQuadrantViewsDebounced()},l.getNextScrollOffset=function(e,a){var r=l.props,t=r.grid,n=r.isHorizontalScrollDisabled,d=r.isVerticalScrollDisabled,u="horizontal"===e,o=u?"scrollLeft":"scrollTop";if(!(u?n:d)){var i=u?l.cache.getScrollContainerClientWidth():l.cache.getScrollContainerClientHeight();null==i&&(i=l.updateScrollContainerClientSize(u));var s=u?l.cache.getScrollContainerClientWidth()-l.cache.getRowHeaderWidth():l.cache.getScrollContainerClientHeight()-l.cache.getColumnHeaderHeight(),c=u?t.getWidth():t.getHeight(),Q=Math.max(0,c-s),p=l.cache.getScrollOffset(o);return core_1.Utils.clamp(p+a,0,Q)}},l.handleColumnResizeGuideMain=function(e){l.invokeColumnResizeHandler(e,tableQuadrant_1.QuadrantType.MAIN)},l.handleColumnResizeGuideTop=function(e){l.invokeColumnResizeHandler(e,tableQuadrant_1.QuadrantType.TOP)},l.handleColumnResizeGuideLeft=function(e){l.invokeColumnResizeHandler(e,tableQuadrant_1.QuadrantType.LEFT)},l.handleColumnResizeGuideTopLeft=function(e){l.invokeColumnResizeHandler(e,tableQuadrant_1.QuadrantType.TOP_LEFT)},l.invokeColumnResizeHandler=function(e,a){var r,t,n=l.adjustVerticalGuides(e,a);null===(t=(r=l.props).handleColumnResizeGuide)||void 0===t||t.call(r,n)},l.handleRowResizeGuideMain=function(e){l.invokeRowResizeHandler(e,tableQuadrant_1.QuadrantType.MAIN)},l.handleRowResizeGuideTop=function(e){l.invokeRowResizeHandler(e,tableQuadrant_1.QuadrantType.TOP)},l.handleRowResizeGuideLeft=function(e){l.invokeRowResizeHandler(e,tableQuadrant_1.QuadrantType.LEFT)},l.handleRowResizeGuideTopLeft=function(e){l.invokeRowResizeHandler(e,tableQuadrant_1.QuadrantType.TOP_LEFT)},l.invokeRowResizeHandler=function(e,a){var r,t,n=l.adjustHorizontalGuides(e,a);null===(t=(r=l.props).handleRowResizeGuide)||void 0===t||t.call(r,n)},l.handleColumnsReordering=function(e,a,r){var t,n,d=utils_1.Utils.reorderedIndexToGuideIndex(e,a,r),u=l.props.grid.getCumulativeWidthBefore(d),o=d<=l.props.numFrozenColumns?tableQuadrant_1.QuadrantType.TOP_LEFT:tableQuadrant_1.QuadrantType.TOP,i=l.adjustVerticalGuides([u],o);null===(n=(t=l.props).handleColumnsReordering)||void 0===n||n.call(t,i)},l.handleRowsReordering=function(e,a,r){var t,n,d=utils_1.Utils.reorderedIndexToGuideIndex(e,a,r),u=l.props.grid.getCumulativeHeightBefore(d),o=d<=l.props.numFrozenRows?tableQuadrant_1.QuadrantType.TOP_LEFT:tableQuadrant_1.QuadrantType.LEFT,i=l.adjustHorizontalGuides([u],o);null===(n=(t=l.props).handleRowsReordering)||void 0===n||n.call(t,i)},l.syncQuadrantViewsDebounced=function(){var e=l.props.viewSyncDelay;e<0?l.syncQuadrantViews():(clearInterval(l.debouncedViewSyncInterval),l.debouncedViewSyncInterval=window.setTimeout(l.syncQuadrantViews,e))},l.syncQuadrantViews=function(){var e=l.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer,a=l.measureDesiredRowHeaderWidth(),r=l.measureDesiredColumnHeaderHeight(),t=a+l.getSecondaryQuadrantGridSize("width"),n=r+l.getSecondaryQuadrantGridSize("height"),d=ScrollUtils.measureScrollBarThickness(e,"vertical"),u=ScrollUtils.measureScrollBarThickness(e,"horizontal"),o=l.maybeIncreaseToDefaultColumnHeaderHeight(r),i=l.maybeIncreaseToDefaultColumnHeaderHeight(n);l.cache.setRowHeaderWidth(a),l.cache.setColumnHeaderHeight(r),l.cache.setScrollContainerClientWidth(void 0),l.cache.setScrollContainerClientHeight(void 0),l.maybesSetQuadrantRowHeaderSizes(a),l.maybeSetQuadrantMenuElementSizes(a,o),l.maybeSetQuadrantSizes(t,i),l.maybeSetQuadrantPositionOffset(tableQuadrant_1.QuadrantType.TOP,"right",d),l.maybeSetQuadrantPositionOffset(tableQuadrant_1.QuadrantType.LEFT,"bottom",u),l.maybeSetQuadrantScrollOffset(tableQuadrant_1.QuadrantType.LEFT,"scrollTop"),l.maybeSetQuadrantScrollOffset(tableQuadrant_1.QuadrantType.TOP,"scrollLeft")},l.maybeSetQuadrantSizes=function(e,a){l.maybesSetQuadrantSize(tableQuadrant_1.QuadrantType.LEFT,"width",e),l.maybesSetQuadrantSize(tableQuadrant_1.QuadrantType.TOP,"height",a),l.maybesSetQuadrantSize(tableQuadrant_1.QuadrantType.TOP_LEFT,"width",e),l.maybesSetQuadrantSize(tableQuadrant_1.QuadrantType.TOP_LEFT,"height",a)},l.maybesSetQuadrantSize=function(e,a,r){var t=l.quadrantRefs[e].quadrant;null!=t&&(t.style[a]=r+"px")},l.maybeSetQuadrantPositionOffset=function(e,a,r){var t=l.quadrantRefs[e].quadrant;null!=t&&(t.style[a]=r+"px")},l.maybesSetQuadrantRowHeaderSizes=function(e){l.maybeSetQuadrantRowHeaderSize(tableQuadrant_1.QuadrantType.MAIN,e),l.maybeSetQuadrantRowHeaderSize(tableQuadrant_1.QuadrantType.TOP,e),l.maybeSetQuadrantRowHeaderSize(tableQuadrant_1.QuadrantType.LEFT,e),l.maybeSetQuadrantRowHeaderSize(tableQuadrant_1.QuadrantType.TOP_LEFT,e)},l.maybeSetQuadrantRowHeaderSize=function(e,a){var r=l.quadrantRefs[e].rowHeader;null!=r&&(r.style.width=a+"px")},l.maybeSetQuadrantMenuElementSizes=function(e,a){l.maybeSetQuadrantMenuElementSize(tableQuadrant_1.QuadrantType.MAIN,e,a),l.maybeSetQuadrantMenuElementSize(tableQuadrant_1.QuadrantType.TOP,e,a),l.maybeSetQuadrantMenuElementSize(tableQuadrant_1.QuadrantType.LEFT,e,a),l.maybeSetQuadrantMenuElementSize(tableQuadrant_1.QuadrantType.TOP_LEFT,e,a)},l.maybeSetQuadrantMenuElementSize=function(e,a,r){var t=l.quadrantRefs[e].menu;null!=t&&(t.style.width=a+"px",t.style.height=r+"px")},l.maybeSetQuadrantScrollOffset=function(e,a,r){var t=l.quadrantRefs[e].scrollContainer,n=null!=r?r:l.cache.getScrollOffset(a);null!=t&&(t[a]=n)},l.handleScrollOffsetChange=function(e,a){l.cache.setScrollOffset(e,a);var r="scrollLeft"===e?tableQuadrant_1.QuadrantType.TOP:tableQuadrant_1.QuadrantType.LEFT;l.maybeSetQuadrantScrollOffset(r,e)},l.throttledHandleMainQuadrantScroll=core_1.Utils.throttleReactEventCallback(l.handleMainQuadrantScroll),l.throttledHandleWheel=core_1.Utils.throttleReactEventCallback(l.handleWheel),l.cache=new tableQuadrantStackCache_1.TableQuadrantStackCache,l}return tslib_1.__extends(a,e),a.prototype.scrollToPosition=function(e,a){var r=this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer;this.wasMainQuadrantScrollTriggeredByWheelEvent=!1,r.scrollLeft=e,r.scrollTop=a,this.syncQuadrantViews()},a.prototype.synchronizeQuadrantViews=function(){this.syncQuadrantViews()},a.prototype.componentDidMount=function(){this.emitRefs(),this.syncQuadrantViews()},a.prototype.componentDidUpdate=function(e){core_1.Utils.shallowCompareKeys(this.props,e,{include:SYNC_TRIGGER_PROP_KEYS})||(this.emitRefs(),this.syncQuadrantViews())},a.prototype.render=function(){var e=this.props,a=e.grid,r=e.enableRowHeader,t=e.bodyRenderer,n=e.throttleScrolling,l=n?this.throttledHandleMainQuadrantScroll:this.handleMainQuadrantScroll,d={bodyRenderer:t,enableRowHeader:r,grid:a,onWheel:n?this.throttledHandleWheel:this.handleWheel},u=this.shouldRenderLeftQuadrants(),o=u?React.createElement(tableQuadrant_1.TableQuadrant,tslib_1.__assign({},d,{quadrantRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.LEFT].quadrant,quadrantType:tableQuadrant_1.QuadrantType.LEFT,columnHeaderCellRenderer:this.renderLeftQuadrantColumnHeader,menuRenderer:this.renderLeftQuadrantMenu,rowHeaderCellRenderer:this.renderLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.LEFT].scrollContainer})):void 0,i=u?React.createElement(tableQuadrant_1.TableQuadrant,tslib_1.__assign({},d,{quadrantRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP_LEFT].quadrant,quadrantType:tableQuadrant_1.QuadrantType.TOP_LEFT,columnHeaderCellRenderer:this.renderTopLeftQuadrantColumnHeader,menuRenderer:this.renderTopLeftQuadrantMenu,rowHeaderCellRenderer:this.renderTopLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP_LEFT].scrollContainer})):void 0;return React.createElement("div",{className:Classes.TABLE_QUADRANT_STACK},React.createElement(tableQuadrant_1.TableQuadrant,tslib_1.__assign({},d,{bodyRef:this.props.bodyRef,onScroll:l,quadrantRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.MAIN].quadrant,quadrantType:tableQuadrant_1.QuadrantType.MAIN,columnHeaderCellRenderer:this.renderMainQuadrantColumnHeader,menuRenderer:this.renderMainQuadrantMenu,rowHeaderCellRenderer:this.renderMainQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.MAIN].scrollContainer})),React.createElement(tableQuadrant_1.TableQuadrant,tslib_1.__assign({},d,{quadrantRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP].quadrant,quadrantType:tableQuadrant_1.QuadrantType.TOP,columnHeaderCellRenderer:this.renderTopQuadrantColumnHeader,menuRenderer:this.renderTopQuadrantMenu,rowHeaderCellRenderer:this.renderTopQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[tableQuadrant_1.QuadrantType.TOP].scrollContainer})),o,i)},a.prototype.generateQuadrantRefHandlers=function(e){var a=this;return["columnHeader","menu","quadrant","rowHeader","scrollContainer"].reduce((function(r,t){return r[t]=function(r){return a.quadrantRefs[e][t]=r},r}),{})},a.prototype.emitRefs=function(){core_1.setRef(this.props.quadrantRef,this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].quadrant),core_1.setRef(this.props.rowHeaderRef,this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].rowHeader),core_1.setRef(this.props.columnHeaderRef,this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].columnHeader),core_1.setRef(this.props.scrollContainerRef,this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer)},a.prototype.updateScrollContainerClientSize=function(e){var a=this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].scrollContainer;return e?(this.cache.setScrollContainerClientWidth(a.clientWidth),this.cache.getScrollContainerClientWidth()):(this.cache.setScrollContainerClientHeight(a.clientHeight),this.cache.getScrollContainerClientHeight())},a.prototype.maybeIncreaseToDefaultColumnHeaderHeight=function(e){return e<=QUADRANT_MIN_SIZE?DEFAULT_COLUMN_HEADER_HEIGHT:e},a.prototype.getSecondaryQuadrantGridSize=function(e){var a=this.props,r=a.grid,t=a.numFrozenColumns,n=a.numFrozenRows,l="width"===e?t:n,d="width"===e?r.getCumulativeWidthAt:r.getCumulativeHeightAt;return l>0?d(l-1):QUADRANT_MIN_SIZE},a.prototype.measureDesiredRowHeaderWidth=function(){var e=this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].rowHeader;return null==e?0:(e.style.width="auto",e.clientWidth)},a.prototype.measureDesiredColumnHeaderHeight=function(){var e=this.quadrantRefs[tableQuadrant_1.QuadrantType.MAIN].columnHeader;return null==e?0:e.clientHeight},a.prototype.shouldRenderLeftQuadrants=function(e){void 0===e&&(e=this.props);var a=e.enableRowHeader,r=e.numFrozenColumns;return a||null!=r&&r>0},a.prototype.adjustVerticalGuides=function(e,a){var r=a===tableQuadrant_1.QuadrantType.LEFT||a===tableQuadrant_1.QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollLeft"),t=this.cache.getRowHeaderWidth();return null!=e?e.map((function(e){return e-r+t})):e},a.prototype.adjustHorizontalGuides=function(e,a){var r=a===tableQuadrant_1.QuadrantType.TOP||a===tableQuadrant_1.QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollTop"),t=this.cache.getColumnHeaderHeight();return null!=e?e.map((function(e){return e-r+t})):e},a.defaultProps={enableColumnInteractionBar:void 0,enableRowHeader:!0,isHorizontalScrollDisabled:!1,isVerticalScrollDisabled:!1,throttleScrolling:!0,viewSyncDelay:DEFAULT_VIEW_SYNC_DELAY},tslib_1.__decorate([react_lifecycles_compat_1.polyfill],a)}(core_1.AbstractComponent2);exports.TableQuadrantStack=TableQuadrantStack;