import{__decorate}from"tslib";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractComponent2,setRef,Utils as CoreUtils}from"@blueprintjs/core";import*as Classes from"../common/classes";import*as ScrollUtils from"../common/internal/scrollUtils";import{Utils}from"../common/utils";import{QuadrantType,TableQuadrant}from"./tableQuadrant";import{TableQuadrantStackCache}from"./tableQuadrantStackCache";const DEFAULT_COLUMN_HEADER_HEIGHT=30,DEFAULT_VIEW_SYNC_DELAY=500,QUADRANT_MIN_SIZE=1,SYNC_TRIGGER_PROP_KEYS=["enableRowHeader","loadingOptions","numFrozenColumns","numFrozenRows","numColumns","numRows","enableColumnInteractionBar"];let TableQuadrantStack=class extends AbstractComponent2{constructor(e,t){super(e,t),this.quadrantRefs={[QuadrantType.MAIN]:{},[QuadrantType.TOP]:{},[QuadrantType.LEFT]:{},[QuadrantType.TOP_LEFT]:{}},this.quadrantRefHandlers={[QuadrantType.MAIN]:this.generateQuadrantRefHandlers(QuadrantType.MAIN),[QuadrantType.TOP]:this.generateQuadrantRefHandlers(QuadrantType.TOP),[QuadrantType.LEFT]:this.generateQuadrantRefHandlers(QuadrantType.LEFT),[QuadrantType.TOP_LEFT]:this.generateQuadrantRefHandlers(QuadrantType.TOP_LEFT)},this.wasMainQuadrantScrollTriggeredByWheelEvent=!1,this.renderMainQuadrantMenu=()=>this.props.menuRenderer?.(this.quadrantRefHandlers[QuadrantType.MAIN].menu),this.renderTopQuadrantMenu=()=>this.props.menuRenderer?.(this.quadrantRefHandlers[QuadrantType.TOP].menu),this.renderLeftQuadrantMenu=()=>this.props.menuRenderer?.(this.quadrantRefHandlers[QuadrantType.LEFT].menu),this.renderTopLeftQuadrantMenu=()=>this.props.menuRenderer?.(this.quadrantRefHandlers[QuadrantType.TOP_LEFT].menu),this.renderMainQuadrantColumnHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.MAIN].columnHeader,a=this.handleColumnResizeGuideMain,r=this.handleColumnsReordering;return this.props.columnHeaderCellRenderer?.(t,a,r,e)},this.renderTopQuadrantColumnHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.TOP].columnHeader,a=this.handleColumnResizeGuideTop,r=this.handleColumnsReordering;return this.props.columnHeaderCellRenderer?.(t,a,r,e)},this.renderLeftQuadrantColumnHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.LEFT].columnHeader,a=this.handleColumnResizeGuideLeft,r=this.handleColumnsReordering;return this.props.columnHeaderCellRenderer?.(t,a,r,e)},this.renderTopLeftQuadrantColumnHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.TOP_LEFT].columnHeader,a=this.handleColumnResizeGuideTopLeft,r=this.handleColumnsReordering;return this.props.columnHeaderCellRenderer?.(t,a,r,e)},this.renderMainQuadrantRowHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.MAIN].rowHeader,a=this.handleRowResizeGuideMain,r=this.handleRowsReordering;return this.props.rowHeaderCellRenderer?.(t,a,r,e)},this.renderTopQuadrantRowHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.TOP].rowHeader,a=this.handleRowResizeGuideTop,r=this.handleRowsReordering;return this.props.rowHeaderCellRenderer?.(t,a,r,e)},this.renderLeftQuadrantRowHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.LEFT].rowHeader,a=this.handleRowResizeGuideLeft,r=this.handleRowsReordering;return this.props.rowHeaderCellRenderer?.(t,a,r,e)},this.renderTopLeftQuadrantRowHeader=e=>{const t=this.quadrantRefHandlers[QuadrantType.TOP_LEFT].rowHeader,a=this.handleRowResizeGuideTopLeft,r=this.handleRowsReordering;return this.props.rowHeaderCellRenderer?.(t,a,r,e)},this.handleMainQuadrantScroll=e=>{if(this.wasMainQuadrantScrollTriggeredByWheelEvent)return void(this.wasMainQuadrantScrollTriggeredByWheelEvent=!1);this.props.onScroll?.(e);const t=this.quadrantRefs[QuadrantType.MAIN].scrollContainer,a=t.scrollLeft,r=t.scrollTop;this.handleScrollOffsetChange("scrollLeft",a),this.handleScrollOffsetChange("scrollTop",r),this.syncQuadrantViewsDebounced()},this.handleWheel=e=>{this.props.onScroll?.(e);const t=this.getNextScrollOffset("horizontal",e.deltaX),a=this.getNextScrollOffset("vertical",e.deltaY);null==t&&null==a||(this.wasMainQuadrantScrollTriggeredByWheelEvent=!0),this.quadrantRefs[QuadrantType.MAIN].scrollContainer.scrollLeft=t,this.quadrantRefs[QuadrantType.MAIN].scrollContainer.scrollTop=a,this.handleScrollOffsetChange("scrollLeft",t),this.handleScrollOffsetChange("scrollTop",a),this.syncQuadrantViewsDebounced()},this.getNextScrollOffset=(e,t)=>{const{grid:a,isHorizontalScrollDisabled:r,isVerticalScrollDisabled:n}=this.props,s="horizontal"===e,d=s?"scrollLeft":"scrollTop";if(s?r:n)return;let i=s?this.cache.getScrollContainerClientWidth():this.cache.getScrollContainerClientHeight();null==i&&(i=this.updateScrollContainerClientSize(s));const l=s?this.cache.getScrollContainerClientWidth()-this.cache.getRowHeaderWidth():this.cache.getScrollContainerClientHeight()-this.cache.getColumnHeaderHeight(),o=s?a.getWidth():a.getHeight(),u=Math.max(0,o-l),h=this.cache.getScrollOffset(d);return CoreUtils.clamp(h+t,0,u)},this.handleColumnResizeGuideMain=e=>{this.invokeColumnResizeHandler(e,QuadrantType.MAIN)},this.handleColumnResizeGuideTop=e=>{this.invokeColumnResizeHandler(e,QuadrantType.TOP)},this.handleColumnResizeGuideLeft=e=>{this.invokeColumnResizeHandler(e,QuadrantType.LEFT)},this.handleColumnResizeGuideTopLeft=e=>{this.invokeColumnResizeHandler(e,QuadrantType.TOP_LEFT)},this.invokeColumnResizeHandler=(e,t)=>{const a=this.adjustVerticalGuides(e,t);this.props.handleColumnResizeGuide?.(a)},this.handleRowResizeGuideMain=e=>{this.invokeRowResizeHandler(e,QuadrantType.MAIN)},this.handleRowResizeGuideTop=e=>{this.invokeRowResizeHandler(e,QuadrantType.TOP)},this.handleRowResizeGuideLeft=e=>{this.invokeRowResizeHandler(e,QuadrantType.LEFT)},this.handleRowResizeGuideTopLeft=e=>{this.invokeRowResizeHandler(e,QuadrantType.TOP_LEFT)},this.invokeRowResizeHandler=(e,t)=>{const a=this.adjustHorizontalGuides(e,t);this.props.handleRowResizeGuide?.(a)},this.handleColumnsReordering=(e,t,a)=>{const r=Utils.reorderedIndexToGuideIndex(e,t,a),n=this.props.grid.getCumulativeWidthBefore(r),s=r<=this.props.numFrozenColumns?QuadrantType.TOP_LEFT:QuadrantType.TOP,d=this.adjustVerticalGuides([n],s);this.props.handleColumnsReordering?.(d)},this.handleRowsReordering=(e,t,a)=>{const r=Utils.reorderedIndexToGuideIndex(e,t,a),n=this.props.grid.getCumulativeHeightBefore(r),s=r<=this.props.numFrozenRows?QuadrantType.TOP_LEFT:QuadrantType.LEFT,d=this.adjustHorizontalGuides([n],s);this.props.handleRowsReordering?.(d)},this.syncQuadrantViewsDebounced=()=>{const{viewSyncDelay:e}=this.props;e<0?this.syncQuadrantViews():(clearInterval(this.debouncedViewSyncInterval),this.debouncedViewSyncInterval=window.setTimeout(this.syncQuadrantViews,e))},this.syncQuadrantViews=()=>{const e=this.quadrantRefs[QuadrantType.MAIN].scrollContainer,t=this.measureDesiredRowHeaderWidth(),a=this.measureDesiredColumnHeaderHeight(),r=t+this.getSecondaryQuadrantGridSize("width"),n=a+this.getSecondaryQuadrantGridSize("height"),s=ScrollUtils.measureScrollBarThickness(e,"vertical"),d=ScrollUtils.measureScrollBarThickness(e,"horizontal"),i=this.maybeIncreaseToDefaultColumnHeaderHeight(a),l=this.maybeIncreaseToDefaultColumnHeaderHeight(n);this.cache.setRowHeaderWidth(t),this.cache.setColumnHeaderHeight(a),this.cache.setScrollContainerClientWidth(void 0),this.cache.setScrollContainerClientHeight(void 0),this.maybesSetQuadrantRowHeaderSizes(t),this.maybeSetQuadrantMenuElementSizes(t,i),this.maybeSetQuadrantSizes(r,l),this.maybeSetQuadrantPositionOffset(QuadrantType.TOP,"right",s),this.maybeSetQuadrantPositionOffset(QuadrantType.LEFT,"bottom",d),this.maybeSetQuadrantScrollOffset(QuadrantType.LEFT,"scrollTop"),this.maybeSetQuadrantScrollOffset(QuadrantType.TOP,"scrollLeft")},this.maybeSetQuadrantSizes=(e,t)=>{this.maybesSetQuadrantSize(QuadrantType.LEFT,"width",e),this.maybesSetQuadrantSize(QuadrantType.TOP,"height",t),this.maybesSetQuadrantSize(QuadrantType.TOP_LEFT,"width",e),this.maybesSetQuadrantSize(QuadrantType.TOP_LEFT,"height",t)},this.maybesSetQuadrantSize=(e,t,a)=>{const{quadrant:r}=this.quadrantRefs[e];null!=r&&(r.style[t]=`${a}px`)},this.maybeSetQuadrantPositionOffset=(e,t,a)=>{const{quadrant:r}=this.quadrantRefs[e];null!=r&&(r.style[t]=`${a}px`)},this.maybesSetQuadrantRowHeaderSizes=e=>{this.maybeSetQuadrantRowHeaderSize(QuadrantType.MAIN,e),this.maybeSetQuadrantRowHeaderSize(QuadrantType.TOP,e),this.maybeSetQuadrantRowHeaderSize(QuadrantType.LEFT,e),this.maybeSetQuadrantRowHeaderSize(QuadrantType.TOP_LEFT,e)},this.maybeSetQuadrantRowHeaderSize=(e,t)=>{const{rowHeader:a}=this.quadrantRefs[e];null!=a&&(a.style.width=`${t}px`)},this.maybeSetQuadrantMenuElementSizes=(e,t)=>{this.maybeSetQuadrantMenuElementSize(QuadrantType.MAIN,e,t),this.maybeSetQuadrantMenuElementSize(QuadrantType.TOP,e,t),this.maybeSetQuadrantMenuElementSize(QuadrantType.LEFT,e,t),this.maybeSetQuadrantMenuElementSize(QuadrantType.TOP_LEFT,e,t)},this.maybeSetQuadrantMenuElementSize=(e,t,a)=>{const{menu:r}=this.quadrantRefs[e];null!=r&&(r.style.width=`${t}px`,r.style.height=`${a}px`)},this.maybeSetQuadrantScrollOffset=(e,t,a)=>{const{scrollContainer:r}=this.quadrantRefs[e],n=null!=a?a:this.cache.getScrollOffset(t);null!=r&&(r[t]=n)},this.handleScrollOffsetChange=(e,t)=>{this.cache.setScrollOffset(e,t);const a="scrollLeft"===e?QuadrantType.TOP:QuadrantType.LEFT;this.maybeSetQuadrantScrollOffset(a,e)},this.throttledHandleMainQuadrantScroll=CoreUtils.throttleReactEventCallback(this.handleMainQuadrantScroll),this.throttledHandleWheel=CoreUtils.throttleReactEventCallback(this.handleWheel),this.cache=new TableQuadrantStackCache}scrollToPosition(e,t){const{scrollContainer:a}=this.quadrantRefs[QuadrantType.MAIN];this.wasMainQuadrantScrollTriggeredByWheelEvent=!1,a.scrollLeft=e,a.scrollTop=t,this.syncQuadrantViews()}synchronizeQuadrantViews(){this.syncQuadrantViews()}componentDidMount(){this.emitRefs(),this.syncQuadrantViews()}componentDidUpdate(e){CoreUtils.shallowCompareKeys(this.props,e,{include:SYNC_TRIGGER_PROP_KEYS})||(this.emitRefs(),this.syncQuadrantViews())}render(){const{grid:e,enableRowHeader:t,bodyRenderer:a,throttleScrolling:r}=this.props,n=r?this.throttledHandleMainQuadrantScroll:this.handleMainQuadrantScroll,s={bodyRenderer:a,enableRowHeader:t,grid:e,onWheel:r?this.throttledHandleWheel:this.handleWheel},d=this.shouldRenderLeftQuadrants(),i=d?React.createElement(TableQuadrant,Object.assign({},s,{quadrantRef:this.quadrantRefHandlers[QuadrantType.LEFT].quadrant,quadrantType:QuadrantType.LEFT,columnHeaderCellRenderer:this.renderLeftQuadrantColumnHeader,menuRenderer:this.renderLeftQuadrantMenu,rowHeaderCellRenderer:this.renderLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.LEFT].scrollContainer})):void 0,l=d?React.createElement(TableQuadrant,Object.assign({},s,{quadrantRef:this.quadrantRefHandlers[QuadrantType.TOP_LEFT].quadrant,quadrantType:QuadrantType.TOP_LEFT,columnHeaderCellRenderer:this.renderTopLeftQuadrantColumnHeader,menuRenderer:this.renderTopLeftQuadrantMenu,rowHeaderCellRenderer:this.renderTopLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.TOP_LEFT].scrollContainer})):void 0;return React.createElement("div",{className:Classes.TABLE_QUADRANT_STACK},React.createElement(TableQuadrant,Object.assign({},s,{bodyRef:this.props.bodyRef,onScroll:n,quadrantRef:this.quadrantRefHandlers[QuadrantType.MAIN].quadrant,quadrantType:QuadrantType.MAIN,columnHeaderCellRenderer:this.renderMainQuadrantColumnHeader,menuRenderer:this.renderMainQuadrantMenu,rowHeaderCellRenderer:this.renderMainQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.MAIN].scrollContainer})),React.createElement(TableQuadrant,Object.assign({},s,{quadrantRef:this.quadrantRefHandlers[QuadrantType.TOP].quadrant,quadrantType:QuadrantType.TOP,columnHeaderCellRenderer:this.renderTopQuadrantColumnHeader,menuRenderer:this.renderTopQuadrantMenu,rowHeaderCellRenderer:this.renderTopQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.TOP].scrollContainer})),i,l)}generateQuadrantRefHandlers(e){return["columnHeader","menu","quadrant","rowHeader","scrollContainer"].reduce(((t,a)=>(t[a]=t=>this.quadrantRefs[e][a]=t,t)),{})}emitRefs(){setRef(this.props.quadrantRef,this.quadrantRefs[QuadrantType.MAIN].quadrant),setRef(this.props.rowHeaderRef,this.quadrantRefs[QuadrantType.MAIN].rowHeader),setRef(this.props.columnHeaderRef,this.quadrantRefs[QuadrantType.MAIN].columnHeader),setRef(this.props.scrollContainerRef,this.quadrantRefs[QuadrantType.MAIN].scrollContainer)}updateScrollContainerClientSize(e){const t=this.quadrantRefs[QuadrantType.MAIN].scrollContainer;return e?(this.cache.setScrollContainerClientWidth(t.clientWidth),this.cache.getScrollContainerClientWidth()):(this.cache.setScrollContainerClientHeight(t.clientHeight),this.cache.getScrollContainerClientHeight())}maybeIncreaseToDefaultColumnHeaderHeight(e){return e<=1?30:e}getSecondaryQuadrantGridSize(e){const{grid:t,numFrozenColumns:a,numFrozenRows:r}=this.props,n="width"===e?a:r,s="width"===e?t.getCumulativeWidthAt:t.getCumulativeHeightAt;return n>0?s(n-1):1}measureDesiredRowHeaderWidth(){const e=this.quadrantRefs[QuadrantType.MAIN].rowHeader;return null==e?0:(e.style.width="auto",e.clientWidth)}measureDesiredColumnHeaderHeight(){const e=this.quadrantRefs[QuadrantType.MAIN].columnHeader;return null==e?0:e.clientHeight}shouldRenderLeftQuadrants(e=this.props){const{enableRowHeader:t,numFrozenColumns:a}=e;return t||null!=a&&a>0}adjustVerticalGuides(e,t){const a=t===QuadrantType.LEFT||t===QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollLeft"),r=this.cache.getRowHeaderWidth();return null!=e?e.map((e=>e-a+r)):e}adjustHorizontalGuides(e,t){const a=t===QuadrantType.TOP||t===QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollTop"),r=this.cache.getColumnHeaderHeight();return null!=e?e.map((e=>e-a+r)):e}};TableQuadrantStack.defaultProps={enableColumnInteractionBar:void 0,enableRowHeader:!0,isHorizontalScrollDisabled:!1,isVerticalScrollDisabled:!1,throttleScrolling:!0,viewSyncDelay:500},TableQuadrantStack=__decorate([polyfill],TableQuadrantStack);export{TableQuadrantStack};