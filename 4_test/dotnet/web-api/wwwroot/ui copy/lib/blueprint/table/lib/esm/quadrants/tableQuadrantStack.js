import{__assign,__decorate,__extends}from"tslib";import*as React from"react";import{polyfill}from"react-lifecycles-compat";import{AbstractComponent2,setRef,Utils as CoreUtils}from"@blueprintjs/core";import*as Classes from"../common/classes";import*as ScrollUtils from"../common/internal/scrollUtils";import{Utils}from"../common/utils";import{QuadrantType,TableQuadrant}from"./tableQuadrant";import{TableQuadrantStackCache}from"./tableQuadrantStackCache";var DEFAULT_COLUMN_HEADER_HEIGHT=30,DEFAULT_VIEW_SYNC_DELAY=500,QUADRANT_MIN_SIZE=1,SYNC_TRIGGER_PROP_KEYS=["enableRowHeader","loadingOptions","numFrozenColumns","numFrozenRows","numColumns","numRows","enableColumnInteractionBar"],TableQuadrantStack=function(e){function a(a,n){var r,t,d=e.call(this,a,n)||this;return d.quadrantRefs=((r={})[QuadrantType.MAIN]={},r[QuadrantType.TOP]={},r[QuadrantType.LEFT]={},r[QuadrantType.TOP_LEFT]={},r),d.quadrantRefHandlers=((t={})[QuadrantType.MAIN]=d.generateQuadrantRefHandlers(QuadrantType.MAIN),t[QuadrantType.TOP]=d.generateQuadrantRefHandlers(QuadrantType.TOP),t[QuadrantType.LEFT]=d.generateQuadrantRefHandlers(QuadrantType.LEFT),t[QuadrantType.TOP_LEFT]=d.generateQuadrantRefHandlers(QuadrantType.TOP_LEFT),t),d.wasMainQuadrantScrollTriggeredByWheelEvent=!1,d.renderMainQuadrantMenu=function(){var e,a;return null===(a=(e=d.props).menuRenderer)||void 0===a?void 0:a.call(e,d.quadrantRefHandlers[QuadrantType.MAIN].menu)},d.renderTopQuadrantMenu=function(){var e,a;return null===(a=(e=d.props).menuRenderer)||void 0===a?void 0:a.call(e,d.quadrantRefHandlers[QuadrantType.TOP].menu)},d.renderLeftQuadrantMenu=function(){var e,a;return null===(a=(e=d.props).menuRenderer)||void 0===a?void 0:a.call(e,d.quadrantRefHandlers[QuadrantType.LEFT].menu)},d.renderTopLeftQuadrantMenu=function(){var e,a;return null===(a=(e=d.props).menuRenderer)||void 0===a?void 0:a.call(e,d.quadrantRefHandlers[QuadrantType.TOP_LEFT].menu)},d.renderMainQuadrantColumnHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.MAIN].columnHeader,t=d.handleColumnResizeGuideMain,l=d.handleColumnsReordering;return null===(n=(a=d.props).columnHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderTopQuadrantColumnHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.TOP].columnHeader,t=d.handleColumnResizeGuideTop,l=d.handleColumnsReordering;return null===(n=(a=d.props).columnHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderLeftQuadrantColumnHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.LEFT].columnHeader,t=d.handleColumnResizeGuideLeft,l=d.handleColumnsReordering;return null===(n=(a=d.props).columnHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderTopLeftQuadrantColumnHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.TOP_LEFT].columnHeader,t=d.handleColumnResizeGuideTopLeft,l=d.handleColumnsReordering;return null===(n=(a=d.props).columnHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderMainQuadrantRowHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.MAIN].rowHeader,t=d.handleRowResizeGuideMain,l=d.handleRowsReordering;return null===(n=(a=d.props).rowHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderTopQuadrantRowHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.TOP].rowHeader,t=d.handleRowResizeGuideTop,l=d.handleRowsReordering;return null===(n=(a=d.props).rowHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderLeftQuadrantRowHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.LEFT].rowHeader,t=d.handleRowResizeGuideLeft,l=d.handleRowsReordering;return null===(n=(a=d.props).rowHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.renderTopLeftQuadrantRowHeader=function(e){var a,n,r=d.quadrantRefHandlers[QuadrantType.TOP_LEFT].rowHeader,t=d.handleRowResizeGuideTopLeft,l=d.handleRowsReordering;return null===(n=(a=d.props).rowHeaderCellRenderer)||void 0===n?void 0:n.call(a,r,t,l,e)},d.handleMainQuadrantScroll=function(e){var a,n;if(d.wasMainQuadrantScrollTriggeredByWheelEvent)d.wasMainQuadrantScrollTriggeredByWheelEvent=!1;else{null===(n=(a=d.props).onScroll)||void 0===n||n.call(a,e);var r=d.quadrantRefs[QuadrantType.MAIN].scrollContainer,t=r.scrollLeft,l=r.scrollTop;d.handleScrollOffsetChange("scrollLeft",t),d.handleScrollOffsetChange("scrollTop",l),d.syncQuadrantViewsDebounced()}},d.handleWheel=function(e){var a,n;null===(n=(a=d.props).onScroll)||void 0===n||n.call(a,e);var r=d.getNextScrollOffset("horizontal",e.deltaX),t=d.getNextScrollOffset("vertical",e.deltaY);null==r&&null==t||(d.wasMainQuadrantScrollTriggeredByWheelEvent=!0),d.quadrantRefs[QuadrantType.MAIN].scrollContainer.scrollLeft=r,d.quadrantRefs[QuadrantType.MAIN].scrollContainer.scrollTop=t,d.handleScrollOffsetChange("scrollLeft",r),d.handleScrollOffsetChange("scrollTop",t),d.syncQuadrantViewsDebounced()},d.getNextScrollOffset=function(e,a){var n=d.props,r=n.grid,t=n.isHorizontalScrollDisabled,l=n.isVerticalScrollDisabled,o="horizontal"===e,u=o?"scrollLeft":"scrollTop";if(!(o?t:l)){var i=o?d.cache.getScrollContainerClientWidth():d.cache.getScrollContainerClientHeight();null==i&&(i=d.updateScrollContainerClientSize(o));var s=o?d.cache.getScrollContainerClientWidth()-d.cache.getRowHeaderWidth():d.cache.getScrollContainerClientHeight()-d.cache.getColumnHeaderHeight(),c=o?r.getWidth():r.getHeight(),p=Math.max(0,c-s),T=d.cache.getScrollOffset(u);return CoreUtils.clamp(T+a,0,p)}},d.handleColumnResizeGuideMain=function(e){d.invokeColumnResizeHandler(e,QuadrantType.MAIN)},d.handleColumnResizeGuideTop=function(e){d.invokeColumnResizeHandler(e,QuadrantType.TOP)},d.handleColumnResizeGuideLeft=function(e){d.invokeColumnResizeHandler(e,QuadrantType.LEFT)},d.handleColumnResizeGuideTopLeft=function(e){d.invokeColumnResizeHandler(e,QuadrantType.TOP_LEFT)},d.invokeColumnResizeHandler=function(e,a){var n,r,t=d.adjustVerticalGuides(e,a);null===(r=(n=d.props).handleColumnResizeGuide)||void 0===r||r.call(n,t)},d.handleRowResizeGuideMain=function(e){d.invokeRowResizeHandler(e,QuadrantType.MAIN)},d.handleRowResizeGuideTop=function(e){d.invokeRowResizeHandler(e,QuadrantType.TOP)},d.handleRowResizeGuideLeft=function(e){d.invokeRowResizeHandler(e,QuadrantType.LEFT)},d.handleRowResizeGuideTopLeft=function(e){d.invokeRowResizeHandler(e,QuadrantType.TOP_LEFT)},d.invokeRowResizeHandler=function(e,a){var n,r,t=d.adjustHorizontalGuides(e,a);null===(r=(n=d.props).handleRowResizeGuide)||void 0===r||r.call(n,t)},d.handleColumnsReordering=function(e,a,n){var r,t,l=Utils.reorderedIndexToGuideIndex(e,a,n),o=d.props.grid.getCumulativeWidthBefore(l),u=l<=d.props.numFrozenColumns?QuadrantType.TOP_LEFT:QuadrantType.TOP,i=d.adjustVerticalGuides([o],u);null===(t=(r=d.props).handleColumnsReordering)||void 0===t||t.call(r,i)},d.handleRowsReordering=function(e,a,n){var r,t,l=Utils.reorderedIndexToGuideIndex(e,a,n),o=d.props.grid.getCumulativeHeightBefore(l),u=l<=d.props.numFrozenRows?QuadrantType.TOP_LEFT:QuadrantType.LEFT,i=d.adjustHorizontalGuides([o],u);null===(t=(r=d.props).handleRowsReordering)||void 0===t||t.call(r,i)},d.syncQuadrantViewsDebounced=function(){var e=d.props.viewSyncDelay;e<0?d.syncQuadrantViews():(clearInterval(d.debouncedViewSyncInterval),d.debouncedViewSyncInterval=window.setTimeout(d.syncQuadrantViews,e))},d.syncQuadrantViews=function(){var e=d.quadrantRefs[QuadrantType.MAIN].scrollContainer,a=d.measureDesiredRowHeaderWidth(),n=d.measureDesiredColumnHeaderHeight(),r=a+d.getSecondaryQuadrantGridSize("width"),t=n+d.getSecondaryQuadrantGridSize("height"),l=ScrollUtils.measureScrollBarThickness(e,"vertical"),o=ScrollUtils.measureScrollBarThickness(e,"horizontal"),u=d.maybeIncreaseToDefaultColumnHeaderHeight(n),i=d.maybeIncreaseToDefaultColumnHeaderHeight(t);d.cache.setRowHeaderWidth(a),d.cache.setColumnHeaderHeight(n),d.cache.setScrollContainerClientWidth(void 0),d.cache.setScrollContainerClientHeight(void 0),d.maybesSetQuadrantRowHeaderSizes(a),d.maybeSetQuadrantMenuElementSizes(a,u),d.maybeSetQuadrantSizes(r,i),d.maybeSetQuadrantPositionOffset(QuadrantType.TOP,"right",l),d.maybeSetQuadrantPositionOffset(QuadrantType.LEFT,"bottom",o),d.maybeSetQuadrantScrollOffset(QuadrantType.LEFT,"scrollTop"),d.maybeSetQuadrantScrollOffset(QuadrantType.TOP,"scrollLeft")},d.maybeSetQuadrantSizes=function(e,a){d.maybesSetQuadrantSize(QuadrantType.LEFT,"width",e),d.maybesSetQuadrantSize(QuadrantType.TOP,"height",a),d.maybesSetQuadrantSize(QuadrantType.TOP_LEFT,"width",e),d.maybesSetQuadrantSize(QuadrantType.TOP_LEFT,"height",a)},d.maybesSetQuadrantSize=function(e,a,n){var r=d.quadrantRefs[e].quadrant;null!=r&&(r.style[a]=n+"px")},d.maybeSetQuadrantPositionOffset=function(e,a,n){var r=d.quadrantRefs[e].quadrant;null!=r&&(r.style[a]=n+"px")},d.maybesSetQuadrantRowHeaderSizes=function(e){d.maybeSetQuadrantRowHeaderSize(QuadrantType.MAIN,e),d.maybeSetQuadrantRowHeaderSize(QuadrantType.TOP,e),d.maybeSetQuadrantRowHeaderSize(QuadrantType.LEFT,e),d.maybeSetQuadrantRowHeaderSize(QuadrantType.TOP_LEFT,e)},d.maybeSetQuadrantRowHeaderSize=function(e,a){var n=d.quadrantRefs[e].rowHeader;null!=n&&(n.style.width=a+"px")},d.maybeSetQuadrantMenuElementSizes=function(e,a){d.maybeSetQuadrantMenuElementSize(QuadrantType.MAIN,e,a),d.maybeSetQuadrantMenuElementSize(QuadrantType.TOP,e,a),d.maybeSetQuadrantMenuElementSize(QuadrantType.LEFT,e,a),d.maybeSetQuadrantMenuElementSize(QuadrantType.TOP_LEFT,e,a)},d.maybeSetQuadrantMenuElementSize=function(e,a,n){var r=d.quadrantRefs[e].menu;null!=r&&(r.style.width=a+"px",r.style.height=n+"px")},d.maybeSetQuadrantScrollOffset=function(e,a,n){var r=d.quadrantRefs[e].scrollContainer,t=null!=n?n:d.cache.getScrollOffset(a);null!=r&&(r[a]=t)},d.handleScrollOffsetChange=function(e,a){d.cache.setScrollOffset(e,a);var n="scrollLeft"===e?QuadrantType.TOP:QuadrantType.LEFT;d.maybeSetQuadrantScrollOffset(n,e)},d.throttledHandleMainQuadrantScroll=CoreUtils.throttleReactEventCallback(d.handleMainQuadrantScroll),d.throttledHandleWheel=CoreUtils.throttleReactEventCallback(d.handleWheel),d.cache=new TableQuadrantStackCache,d}return __extends(a,e),a.prototype.scrollToPosition=function(e,a){var n=this.quadrantRefs[QuadrantType.MAIN].scrollContainer;this.wasMainQuadrantScrollTriggeredByWheelEvent=!1,n.scrollLeft=e,n.scrollTop=a,this.syncQuadrantViews()},a.prototype.synchronizeQuadrantViews=function(){this.syncQuadrantViews()},a.prototype.componentDidMount=function(){this.emitRefs(),this.syncQuadrantViews()},a.prototype.componentDidUpdate=function(e){CoreUtils.shallowCompareKeys(this.props,e,{include:SYNC_TRIGGER_PROP_KEYS})||(this.emitRefs(),this.syncQuadrantViews())},a.prototype.render=function(){var e=this.props,a=e.grid,n=e.enableRowHeader,r=e.bodyRenderer,t=e.throttleScrolling,d=t?this.throttledHandleMainQuadrantScroll:this.handleMainQuadrantScroll,l={bodyRenderer:r,enableRowHeader:n,grid:a,onWheel:t?this.throttledHandleWheel:this.handleWheel},o=this.shouldRenderLeftQuadrants(),u=o?React.createElement(TableQuadrant,__assign({},l,{quadrantRef:this.quadrantRefHandlers[QuadrantType.LEFT].quadrant,quadrantType:QuadrantType.LEFT,columnHeaderCellRenderer:this.renderLeftQuadrantColumnHeader,menuRenderer:this.renderLeftQuadrantMenu,rowHeaderCellRenderer:this.renderLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.LEFT].scrollContainer})):void 0,i=o?React.createElement(TableQuadrant,__assign({},l,{quadrantRef:this.quadrantRefHandlers[QuadrantType.TOP_LEFT].quadrant,quadrantType:QuadrantType.TOP_LEFT,columnHeaderCellRenderer:this.renderTopLeftQuadrantColumnHeader,menuRenderer:this.renderTopLeftQuadrantMenu,rowHeaderCellRenderer:this.renderTopLeftQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.TOP_LEFT].scrollContainer})):void 0;return React.createElement("div",{className:Classes.TABLE_QUADRANT_STACK},React.createElement(TableQuadrant,__assign({},l,{bodyRef:this.props.bodyRef,onScroll:d,quadrantRef:this.quadrantRefHandlers[QuadrantType.MAIN].quadrant,quadrantType:QuadrantType.MAIN,columnHeaderCellRenderer:this.renderMainQuadrantColumnHeader,menuRenderer:this.renderMainQuadrantMenu,rowHeaderCellRenderer:this.renderMainQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.MAIN].scrollContainer})),React.createElement(TableQuadrant,__assign({},l,{quadrantRef:this.quadrantRefHandlers[QuadrantType.TOP].quadrant,quadrantType:QuadrantType.TOP,columnHeaderCellRenderer:this.renderTopQuadrantColumnHeader,menuRenderer:this.renderTopQuadrantMenu,rowHeaderCellRenderer:this.renderTopQuadrantRowHeader,scrollContainerRef:this.quadrantRefHandlers[QuadrantType.TOP].scrollContainer})),u,i)},a.prototype.generateQuadrantRefHandlers=function(e){var a=this;return["columnHeader","menu","quadrant","rowHeader","scrollContainer"].reduce((function(n,r){return n[r]=function(n){return a.quadrantRefs[e][r]=n},n}),{})},a.prototype.emitRefs=function(){setRef(this.props.quadrantRef,this.quadrantRefs[QuadrantType.MAIN].quadrant),setRef(this.props.rowHeaderRef,this.quadrantRefs[QuadrantType.MAIN].rowHeader),setRef(this.props.columnHeaderRef,this.quadrantRefs[QuadrantType.MAIN].columnHeader),setRef(this.props.scrollContainerRef,this.quadrantRefs[QuadrantType.MAIN].scrollContainer)},a.prototype.updateScrollContainerClientSize=function(e){var a=this.quadrantRefs[QuadrantType.MAIN].scrollContainer;return e?(this.cache.setScrollContainerClientWidth(a.clientWidth),this.cache.getScrollContainerClientWidth()):(this.cache.setScrollContainerClientHeight(a.clientHeight),this.cache.getScrollContainerClientHeight())},a.prototype.maybeIncreaseToDefaultColumnHeaderHeight=function(e){return e<=QUADRANT_MIN_SIZE?DEFAULT_COLUMN_HEADER_HEIGHT:e},a.prototype.getSecondaryQuadrantGridSize=function(e){var a=this.props,n=a.grid,r=a.numFrozenColumns,t=a.numFrozenRows,d="width"===e?r:t,l="width"===e?n.getCumulativeWidthAt:n.getCumulativeHeightAt;return d>0?l(d-1):QUADRANT_MIN_SIZE},a.prototype.measureDesiredRowHeaderWidth=function(){var e=this.quadrantRefs[QuadrantType.MAIN].rowHeader;return null==e?0:(e.style.width="auto",e.clientWidth)},a.prototype.measureDesiredColumnHeaderHeight=function(){var e=this.quadrantRefs[QuadrantType.MAIN].columnHeader;return null==e?0:e.clientHeight},a.prototype.shouldRenderLeftQuadrants=function(e){void 0===e&&(e=this.props);var a=e.enableRowHeader,n=e.numFrozenColumns;return a||null!=n&&n>0},a.prototype.adjustVerticalGuides=function(e,a){var n=a===QuadrantType.LEFT||a===QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollLeft"),r=this.cache.getRowHeaderWidth();return null!=e?e.map((function(e){return e-n+r})):e},a.prototype.adjustHorizontalGuides=function(e,a){var n=a===QuadrantType.TOP||a===QuadrantType.TOP_LEFT?0:this.cache.getScrollOffset("scrollTop"),r=this.cache.getColumnHeaderHeight();return null!=e?e.map((function(e){return e-n+r})):e},a.defaultProps={enableColumnInteractionBar:void 0,enableRowHeader:!0,isHorizontalScrollDisabled:!1,isVerticalScrollDisabled:!1,throttleScrolling:!0,viewSyncDelay:DEFAULT_VIEW_SYNC_DELAY},__decorate([polyfill],a)}(AbstractComponent2);export{TableQuadrantStack};