import classNames from"classnames";import*as React from"react";import{AbstractPureComponent2,DISPLAYNAME_PREFIX,InputGroup,Keys,Popover,PopoverInteractionKind,Position,refHandler,setRef}from"@blueprintjs/core";import{Classes}from"../../common";import{QueryList}from"../query-list/queryList";export class Suggest extends AbstractPureComponent2{constructor(){super(...arguments),this.state={isOpen:null!=this.props.popoverProps&&this.props.popoverProps.isOpen||!1,selectedItem:this.getInitialSelectedItem()},this.TypedQueryList=QueryList.ofType(),this.inputElement=null,this.queryList=null,this.handleInputRef=refHandler(this,"inputElement",this.props.inputProps?.inputRef),this.handleQueryListRef=e=>this.queryList=e,this.renderQueryList=e=>{const{fill:t,inputProps:s={},popoverProps:i={}}=this.props,{isOpen:n,selectedItem:p}=this.state,{handleKeyDown:o,handleKeyUp:r}=e,{autoComplete:l="off",placeholder:h="Search..."}=s,a=p?this.props.inputValueRenderer(p):"",u=n&&a?a:h,c=n?e.query:a||(this.props.resetOnClose?"":e.query);return t&&(i.fill=!0,s.fill=!0),React.createElement(Popover,Object.assign({autoFocus:!1,enforceFocus:!1,isOpen:n,position:Position.BOTTOM_LEFT},i,{className:classNames(e.className,i.className),interactionKind:PopoverInteractionKind.CLICK,onInteraction:this.handlePopoverInteraction,popoverClassName:classNames(Classes.SELECT_POPOVER,i.popoverClassName),onOpening:this.handlePopoverOpening,onOpened:this.handlePopoverOpened}),React.createElement(InputGroup,Object.assign({autoComplete:l,disabled:this.props.disabled},s,{inputRef:this.handleInputRef,onChange:e.handleQueryChange,onFocus:this.handleInputFocus,onKeyDown:this.getTargetKeyDownHandler(o),onKeyUp:this.getTargetKeyUpHandler(r),placeholder:u,value:c})),React.createElement("div",{onKeyDown:o,onKeyUp:r},e.itemList))},this.selectText=()=>{this.requestAnimationFrame((()=>{this.inputElement?.setSelectionRange(0,this.inputElement.value.length)}))},this.handleInputFocus=e=>{this.selectText(),this.props.openOnKeyDown||this.setState({isOpen:!0}),this.props.inputProps?.onFocus?.(e)},this.handleItemSelect=(e,t)=>{let s;this.props.closeOnSelect?(this.inputElement?.blur(),s=!1):(this.inputElement?.focus(),this.selectText(),s=!0),void 0===this.props.selectedItem?this.setState({isOpen:s,selectedItem:e}):this.setState({isOpen:s}),this.props.onItemSelect?.(e,t)},this.handlePopoverInteraction=(e,t)=>this.requestAnimationFrame((()=>{const s=this.inputElement===document.activeElement;null==this.inputElement||s||this.setState({isOpen:!1}),this.props.popoverProps?.onInteraction?.(e,t)})),this.handlePopoverOpening=e=>{this.props.resetOnClose&&this.queryList&&this.queryList.setQuery("",!0),this.props.popoverProps?.onOpening?.(e)},this.handlePopoverOpened=e=>{null!=this.queryList&&this.queryList.scrollActiveItemIntoView(),this.props.popoverProps?.onOpened?.(e)},this.getTargetKeyDownHandler=e=>t=>{const{which:s}=t;s===Keys.ESCAPE||s===Keys.TAB?(this.inputElement?.blur(),this.setState({isOpen:!1})):this.props.openOnKeyDown&&s!==Keys.BACKSPACE&&s!==Keys.ARROW_LEFT&&s!==Keys.ARROW_RIGHT&&this.setState({isOpen:!0}),this.state.isOpen&&e?.(t),this.props.inputProps?.onKeyDown?.(t)},this.getTargetKeyUpHandler=e=>t=>{this.state.isOpen&&e?.(t),this.props.inputProps?.onKeyUp?.(t)}}static ofType(){return Suggest}render(){const{disabled:e,inputProps:t,popoverProps:s,...i}=this.props;return React.createElement(this.TypedQueryList,Object.assign({},i,{initialActiveItem:this.props.selectedItem??void 0,onItemSelect:this.handleItemSelect,ref:this.handleQueryListRef,renderer:this.renderQueryList}))}componentDidUpdate(e,t){if(e.inputProps?.inputRef!==this.props.inputProps?.inputRef&&(setRef(e.inputProps?.inputRef,null),this.handleInputRef=refHandler(this,"inputElement",this.props.inputProps?.inputRef),setRef(this.props.inputProps?.inputRef,this.inputElement)),void 0!==this.props.selectedItem&&this.props.selectedItem!==this.state.selectedItem&&this.setState({selectedItem:this.props.selectedItem}),!1===this.state.isOpen&&!0===t.isOpen){const e=this.props.popoverProps?.transitionDuration??Popover.defaultProps.transitionDuration;setTimeout((()=>this.maybeResetActiveItemToSelectedItem()),e)}this.state.isOpen&&!t.isOpen&&null!=this.queryList&&this.queryList.scrollActiveItemIntoView()}getInitialSelectedItem(){return void 0!==this.props.selectedItem?this.props.selectedItem:void 0!==this.props.defaultSelectedItem?this.props.defaultSelectedItem:null}maybeResetActiveItemToSelectedItem(){const e=void 0===this.props.activeItem&&null!==this.state.selectedItem&&!this.props.resetOnSelect;null!==this.queryList&&e&&this.queryList.setActiveItem(this.props.selectedItem??this.state.selectedItem)}}Suggest.displayName=`${DISPLAYNAME_PREFIX}.Suggest`,Suggest.defaultProps={closeOnSelect:!0,fill:!1,openOnKeyDown:!1,resetOnClose:!1};