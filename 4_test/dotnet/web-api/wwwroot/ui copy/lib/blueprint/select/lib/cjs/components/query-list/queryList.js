"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getFirstEnabledItem=exports.QueryList=void 0;var tslib_1=require("tslib"),React=tslib_1.__importStar(require("react")),core_1=require("@blueprintjs/core"),common_1=require("../../common"),QueryList=function(e){function t(t,i){var r,s,n=e.call(this,t,i)||this;n.refHandlers={itemsParent:function(e){return n.itemsParentRef=e}},n.shouldCheckActiveItemInViewport=!1,n.expectedNextActiveItem=null,n.isEnterKeyPressed=!1,n.renderItemList=function(e){var t=n.props,i=t.initialContent,r=t.noResults,s=e.renderCreateItem(),o=null!=s?null:r,a=common_1.renderFilteredItems(e,o,i);if(null==a&&null==s)return null;var l=n.isCreateItemFirst();return React.createElement(core_1.Menu,{ulRef:e.itemsParentRef},l&&s,a,!l&&s)},n.renderItem=function(e,t){if(!0!==n.props.disabled){var i=n.state,r=i.activeItem,s=i.query,o=n.state.filteredItems.indexOf(e)>=0,a={active:common_1.executeItemsEqual(n.props.itemsEqual,common_1.getActiveItem(r),e),disabled:isItemDisabled(e,t,n.props.itemDisabled),matchesPredicate:o};return n.props.itemRenderer(e,{handleClick:function(t){return n.handleItemSelect(e,t)},index:t,modifiers:a,query:s})}return null},n.renderCreateItemMenuItem=function(){if(n.isCreateItemRendered()){var e=n.state,t=e.activeItem,i=e.query.trim(),r=common_1.isCreateNewItem(t);return n.props.createNewItemRenderer(i,r,(function(e){n.handleItemCreate(i,e)}))}return null},n.handleItemCreate=function(e,t){var i,r,s,o,a=null===(r=(i=n.props).createNewItemFromQuery)||void 0===r?void 0:r.call(i,e);null!=a&&(null===(o=(s=n.props).onItemSelect)||void 0===o||o.call(s,a,t),n.maybeResetQuery())},n.handleItemSelect=function(e,t){var i,r;n.setActiveItem(e),null===(r=(i=n.props).onItemSelect)||void 0===r||r.call(i,e,t),n.maybeResetQuery()},n.handlePaste=function(e){for(var t,i=n.props,r=i.createNewItemFromQuery,s=i.onItemsPaste,o=[],a=[],l=0,m=e;l<m.length;l++){var c=m[l],u=getMatchingItem(c,n.props);if(void 0!==u)t=u,a.push(u);else if(n.canCreateItems()){var d=null==r?void 0:r(c);void 0!==d&&a.push(d)}else o.push(c)}n.setQuery(o.join(", "),!1),void 0!==t&&n.setActiveItem(t),null==s||s(a)},n.handleKeyDown=function(e){var t,i,r=e.keyCode;if(r===core_1.Keys.ARROW_UP||r===core_1.Keys.ARROW_DOWN){e.preventDefault();var s=n.getNextActiveItem(r===core_1.Keys.ARROW_UP?-1:1);null!=s&&n.setActiveItem(s)}else r===core_1.Keys.ENTER&&(n.isEnterKeyPressed=!0);null===(i=(t=n.props).onKeyDown)||void 0===i||i.call(t,e)},n.handleKeyUp=function(e){var t=n.props.onKeyUp,i=n.state.activeItem;e.keyCode===core_1.Keys.ENTER&&n.isEnterKeyPressed&&(e.preventDefault(),null==i||common_1.isCreateNewItem(i)?n.handleItemCreate(n.state.query,e):n.handleItemSelect(i,e),n.isEnterKeyPressed=!1),null==t||t(e)},n.handleInputQueryChange=function(e){var t,i,r=null==e?"":e.target.value;n.setQuery(r),null===(i=(t=n.props).onQueryChange)||void 0===i||i.call(t,r,e)};var o=t.query,a=void 0===o?"":o,l=null===(r=t.createNewItemFromQuery)||void 0===r?void 0:r.call(t,a),m=getFilteredItems(a,t);return n.state={activeItem:void 0!==t.activeItem?t.activeItem:null!==(s=t.initialActiveItem)&&void 0!==s?s:getFirstEnabledItem(m,t.itemDisabled),createNewItem:l,filteredItems:m,query:a},n}return tslib_1.__extends(t,e),t.ofType=function(){return t},t.prototype.render=function(){var e=this.props,t=e.className,i=e.items,r=e.renderer,s=e.itemListRenderer,n=void 0===s?this.renderItemList:s,o=this.state,a=(o.createNewItem,tslib_1.__rest(o,["createNewItem"]));return r(tslib_1.__assign(tslib_1.__assign({},a),{className:t,handleItemSelect:this.handleItemSelect,handleKeyDown:this.handleKeyDown,handleKeyUp:this.handleKeyUp,handlePaste:this.handlePaste,handleQueryChange:this.handleInputQueryChange,itemList:n(tslib_1.__assign(tslib_1.__assign({},a),{items:i,itemsParentRef:this.refHandlers.itemsParent,renderCreateItem:this.renderCreateItemMenuItem,renderItem:this.renderItem}))}))},t.prototype.componentDidUpdate=function(e){var t=this;void 0!==this.props.activeItem&&this.props.activeItem!==this.state.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:this.props.activeItem})),null!=this.props.query&&this.props.query!==e.query?this.setQuery(this.props.query,this.props.resetOnQuery,this.props):core_1.Utils.shallowCompareKeys(this.props,e,{include:["items","itemListPredicate","itemPredicate"]})||this.setQuery(this.state.query),this.shouldCheckActiveItemInViewport&&(this.requestAnimationFrame((function(){return t.scrollActiveItemIntoView()})),this.shouldCheckActiveItemInViewport=!1)},t.prototype.scrollActiveItemIntoView=function(){var e=!1!==this.props.scrollToActiveItem,t=!common_1.executeItemsEqual(this.props.itemsEqual,common_1.getActiveItem(this.expectedNextActiveItem),common_1.getActiveItem(this.props.activeItem));if(this.expectedNextActiveItem=null,e||!t){var i=this.getActiveElement();if(null!=this.itemsParentRef&&null!=i){var r=i.offsetTop,s=i.offsetHeight,n=this.itemsParentRef,o=n.offsetTop,a=n.scrollTop,l=n.clientHeight,m=this.getItemsParentPadding(),c=m.paddingTop,u=r+s+m.paddingBottom-o,d=r-c-o;u>=a+l?this.itemsParentRef.scrollTop=u+s-l:d<=a&&(this.itemsParentRef.scrollTop=d-s)}}},t.prototype.setQuery=function(e,t,i){var r;void 0===t&&(t=this.props.resetOnQuery),void 0===i&&(i=this.props);var s=i.createNewItemFromQuery;this.shouldCheckActiveItemInViewport=!0,e!==this.state.query&&(null===(r=i.onQueryChange)||void 0===r||r.call(i,e));var n=e.trim(),o=getFilteredItems(n,i),a=null!=s&&""!==n?s(n):void 0;this.setState({createNewItem:a,filteredItems:o,query:e});var l=this.getActiveIndex(o);(t||l<0||isItemDisabled(common_1.getActiveItem(this.state.activeItem),l,i.itemDisabled))&&(this.isCreateItemRendered()&&this.isCreateItemFirst()?this.setActiveItem(common_1.getCreateNewItem()):this.setActiveItem(getFirstEnabledItem(o,i.itemDisabled)))},t.prototype.setActiveItem=function(e){var t,i,r,s;this.expectedNextActiveItem=e,void 0===this.props.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:e})),common_1.isCreateNewItem(e)?null===(i=(t=this.props).onActiveItemChange)||void 0===i||i.call(t,null,!0):null===(s=(r=this.props).onActiveItemChange)||void 0===s||s.call(r,e,!1)},t.prototype.getActiveElement=function(){var e=this.state.activeItem;if(null!=this.itemsParentRef){if(common_1.isCreateNewItem(e)){var t=this.isCreateItemFirst()?0:this.state.filteredItems.length;return this.itemsParentRef.children.item(t)}var i=this.getActiveIndex();return this.itemsParentRef.children.item(i)}},t.prototype.getActiveIndex=function(e){void 0===e&&(e=this.state.filteredItems);var t=this.state.activeItem;if(null==t||common_1.isCreateNewItem(t))return-1;for(var i=0;i<e.length;++i)if(common_1.executeItemsEqual(this.props.itemsEqual,e[i],t))return i;return-1},t.prototype.getItemsParentPadding=function(){var e=getComputedStyle(this.itemsParentRef),t=e.paddingTop;return{paddingBottom:pxToNumber(e.paddingBottom),paddingTop:pxToNumber(t)}},t.prototype.getNextActiveItem=function(e,t){return void 0===t&&(t=this.getActiveIndex()),this.isCreateItemRendered()&&(0===t&&-1===e||t===this.state.filteredItems.length-1&&1===e)?common_1.getCreateNewItem():getFirstEnabledItem(this.state.filteredItems,this.props.itemDisabled,e,t)},t.prototype.isCreateItemRendered=function(){return this.canCreateItems()&&""!==this.state.query&&!this.wouldCreatedItemMatchSomeExistingItem()},t.prototype.isCreateItemFirst=function(){return"first"===this.props.createNewItemPosition},t.prototype.canCreateItems=function(){return null!=this.props.createNewItemFromQuery&&null!=this.props.createNewItemRenderer},t.prototype.wouldCreatedItemMatchSomeExistingItem=function(){var e=this;return this.state.filteredItems.some((function(t){return common_1.executeItemsEqual(e.props.itemsEqual,t,e.state.createNewItem)}))},t.prototype.maybeResetQuery=function(){this.props.resetOnSelect&&this.setQuery("",!0)},t.displayName=core_1.DISPLAYNAME_PREFIX+".QueryList",t.defaultProps={disabled:!1,resetOnQuery:!0},t}(core_1.AbstractComponent2);function pxToNumber(e){return null==e?0:parseInt(e.slice(0,-2),10)}function getMatchingItem(e,t){var i=t.items,r=t.itemPredicate;if(core_1.Utils.isFunction(r))for(var s=0;s<i.length;s++){var n=i[s];if(r(e,n,s,!0))return n}}function getFilteredItems(e,t){var i=t.items,r=t.itemPredicate,s=t.itemListPredicate;return core_1.Utils.isFunction(s)?s(e,i):core_1.Utils.isFunction(r)?i.filter((function(t,i){return r(e,t,i)})):i}function wrapNumber(e,t,i){return e<t?i:e>i?t:e}function isItemDisabled(e,t,i){return null!=i&&null!=e&&(core_1.Utils.isFunction(i)?i(e,t):!!e[i])}function getFirstEnabledItem(e,t,i,r){if(void 0===i&&(i=1),void 0===r&&(r=e.length-1),0===e.length)return null;var s=r,n=e.length-1;do{if(!isItemDisabled(e[s=wrapNumber(s+i,0,n)],s,t))return e[s]}while(s!==r&&-1!==r);return null}exports.QueryList=QueryList,exports.getFirstEnabledItem=getFirstEnabledItem;