import{__assign,__extends,__rest}from"tslib";import*as React from"react";import{AbstractComponent2,DISPLAYNAME_PREFIX,Keys,Menu,Utils}from"@blueprintjs/core";import{executeItemsEqual,getActiveItem,getCreateNewItem,isCreateNewItem,renderFilteredItems}from"../../common";var QueryList=function(e){function t(t,i){var r,s,n=e.call(this,t,i)||this;n.refHandlers={itemsParent:function(e){return n.itemsParentRef=e}},n.shouldCheckActiveItemInViewport=!1,n.expectedNextActiveItem=null,n.isEnterKeyPressed=!1,n.renderItemList=function(e){var t=n.props,i=t.initialContent,r=t.noResults,s=e.renderCreateItem(),a=renderFilteredItems(e,null!=s?null:r,i);if(null==a&&null==s)return null;var o=n.isCreateItemFirst();return React.createElement(Menu,{ulRef:e.itemsParentRef},o&&s,a,!o&&s)},n.renderItem=function(e,t){if(!0!==n.props.disabled){var i=n.state,r=i.activeItem,s=i.query,a=n.state.filteredItems.indexOf(e)>=0,o={active:executeItemsEqual(n.props.itemsEqual,getActiveItem(r),e),disabled:isItemDisabled(e,t,n.props.itemDisabled),matchesPredicate:a};return n.props.itemRenderer(e,{handleClick:function(t){return n.handleItemSelect(e,t)},index:t,modifiers:o,query:s})}return null},n.renderCreateItemMenuItem=function(){if(n.isCreateItemRendered()){var e=n.state,t=e.activeItem,i=e.query.trim(),r=isCreateNewItem(t);return n.props.createNewItemRenderer(i,r,(function(e){n.handleItemCreate(i,e)}))}return null},n.handleItemCreate=function(e,t){var i,r,s,a,o=null===(r=(i=n.props).createNewItemFromQuery)||void 0===r?void 0:r.call(i,e);null!=o&&(null===(a=(s=n.props).onItemSelect)||void 0===a||a.call(s,o,t),n.maybeResetQuery())},n.handleItemSelect=function(e,t){var i,r;n.setActiveItem(e),null===(r=(i=n.props).onItemSelect)||void 0===r||r.call(i,e,t),n.maybeResetQuery()},n.handlePaste=function(e){for(var t,i=n.props,r=i.createNewItemFromQuery,s=i.onItemsPaste,a=[],o=[],l=0,m=e;l<m.length;l++){var u=m[l],c=getMatchingItem(u,n.props);if(void 0!==c)t=c,o.push(c);else if(n.canCreateItems()){var d=null==r?void 0:r(u);void 0!==d&&o.push(d)}else a.push(u)}n.setQuery(a.join(", "),!1),void 0!==t&&n.setActiveItem(t),null==s||s(o)},n.handleKeyDown=function(e){var t,i,r=e.keyCode;if(r===Keys.ARROW_UP||r===Keys.ARROW_DOWN){e.preventDefault();var s=n.getNextActiveItem(r===Keys.ARROW_UP?-1:1);null!=s&&n.setActiveItem(s)}else r===Keys.ENTER&&(n.isEnterKeyPressed=!0);null===(i=(t=n.props).onKeyDown)||void 0===i||i.call(t,e)},n.handleKeyUp=function(e){var t=n.props.onKeyUp,i=n.state.activeItem;e.keyCode===Keys.ENTER&&n.isEnterKeyPressed&&(e.preventDefault(),null==i||isCreateNewItem(i)?n.handleItemCreate(n.state.query,e):n.handleItemSelect(i,e),n.isEnterKeyPressed=!1),null==t||t(e)},n.handleInputQueryChange=function(e){var t,i,r=null==e?"":e.target.value;n.setQuery(r),null===(i=(t=n.props).onQueryChange)||void 0===i||i.call(t,r,e)};var a=t.query,o=void 0===a?"":a,l=null===(r=t.createNewItemFromQuery)||void 0===r?void 0:r.call(t,o),m=getFilteredItems(o,t);return n.state={activeItem:void 0!==t.activeItem?t.activeItem:null!==(s=t.initialActiveItem)&&void 0!==s?s:getFirstEnabledItem(m,t.itemDisabled),createNewItem:l,filteredItems:m,query:o},n}return __extends(t,e),t.ofType=function(){return t},t.prototype.render=function(){var e=this.props,t=e.className,i=e.items,r=e.renderer,s=e.itemListRenderer,n=void 0===s?this.renderItemList:s,a=this.state,o=(a.createNewItem,__rest(a,["createNewItem"]));return r(__assign(__assign({},o),{className:t,handleItemSelect:this.handleItemSelect,handleKeyDown:this.handleKeyDown,handleKeyUp:this.handleKeyUp,handlePaste:this.handlePaste,handleQueryChange:this.handleInputQueryChange,itemList:n(__assign(__assign({},o),{items:i,itemsParentRef:this.refHandlers.itemsParent,renderCreateItem:this.renderCreateItemMenuItem,renderItem:this.renderItem}))}))},t.prototype.componentDidUpdate=function(e){var t=this;void 0!==this.props.activeItem&&this.props.activeItem!==this.state.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:this.props.activeItem})),null!=this.props.query&&this.props.query!==e.query?this.setQuery(this.props.query,this.props.resetOnQuery,this.props):Utils.shallowCompareKeys(this.props,e,{include:["items","itemListPredicate","itemPredicate"]})||this.setQuery(this.state.query),this.shouldCheckActiveItemInViewport&&(this.requestAnimationFrame((function(){return t.scrollActiveItemIntoView()})),this.shouldCheckActiveItemInViewport=!1)},t.prototype.scrollActiveItemIntoView=function(){var e=!1!==this.props.scrollToActiveItem,t=!executeItemsEqual(this.props.itemsEqual,getActiveItem(this.expectedNextActiveItem),getActiveItem(this.props.activeItem));if(this.expectedNextActiveItem=null,e||!t){var i=this.getActiveElement();if(null!=this.itemsParentRef&&null!=i){var r=i.offsetTop,s=i.offsetHeight,n=this.itemsParentRef,a=n.offsetTop,o=n.scrollTop,l=n.clientHeight,m=this.getItemsParentPadding(),u=m.paddingTop,c=r+s+m.paddingBottom-a,d=r-u-a;c>=o+l?this.itemsParentRef.scrollTop=c+s-l:d<=o&&(this.itemsParentRef.scrollTop=d-s)}}},t.prototype.setQuery=function(e,t,i){var r;void 0===t&&(t=this.props.resetOnQuery),void 0===i&&(i=this.props);var s=i.createNewItemFromQuery;this.shouldCheckActiveItemInViewport=!0,e!==this.state.query&&(null===(r=i.onQueryChange)||void 0===r||r.call(i,e));var n=e.trim(),a=getFilteredItems(n,i),o=null!=s&&""!==n?s(n):void 0;this.setState({createNewItem:o,filteredItems:a,query:e});var l=this.getActiveIndex(a);(t||l<0||isItemDisabled(getActiveItem(this.state.activeItem),l,i.itemDisabled))&&(this.isCreateItemRendered()&&this.isCreateItemFirst()?this.setActiveItem(getCreateNewItem()):this.setActiveItem(getFirstEnabledItem(a,i.itemDisabled)))},t.prototype.setActiveItem=function(e){var t,i,r,s;this.expectedNextActiveItem=e,void 0===this.props.activeItem&&(this.shouldCheckActiveItemInViewport=!0,this.setState({activeItem:e})),isCreateNewItem(e)?null===(i=(t=this.props).onActiveItemChange)||void 0===i||i.call(t,null,!0):null===(s=(r=this.props).onActiveItemChange)||void 0===s||s.call(r,e,!1)},t.prototype.getActiveElement=function(){var e=this.state.activeItem;if(null!=this.itemsParentRef){if(isCreateNewItem(e)){var t=this.isCreateItemFirst()?0:this.state.filteredItems.length;return this.itemsParentRef.children.item(t)}var i=this.getActiveIndex();return this.itemsParentRef.children.item(i)}},t.prototype.getActiveIndex=function(e){void 0===e&&(e=this.state.filteredItems);var t=this.state.activeItem;if(null==t||isCreateNewItem(t))return-1;for(var i=0;i<e.length;++i)if(executeItemsEqual(this.props.itemsEqual,e[i],t))return i;return-1},t.prototype.getItemsParentPadding=function(){var e=getComputedStyle(this.itemsParentRef),t=e.paddingTop;return{paddingBottom:pxToNumber(e.paddingBottom),paddingTop:pxToNumber(t)}},t.prototype.getNextActiveItem=function(e,t){return void 0===t&&(t=this.getActiveIndex()),this.isCreateItemRendered()&&(0===t&&-1===e||t===this.state.filteredItems.length-1&&1===e)?getCreateNewItem():getFirstEnabledItem(this.state.filteredItems,this.props.itemDisabled,e,t)},t.prototype.isCreateItemRendered=function(){return this.canCreateItems()&&""!==this.state.query&&!this.wouldCreatedItemMatchSomeExistingItem()},t.prototype.isCreateItemFirst=function(){return"first"===this.props.createNewItemPosition},t.prototype.canCreateItems=function(){return null!=this.props.createNewItemFromQuery&&null!=this.props.createNewItemRenderer},t.prototype.wouldCreatedItemMatchSomeExistingItem=function(){var e=this;return this.state.filteredItems.some((function(t){return executeItemsEqual(e.props.itemsEqual,t,e.state.createNewItem)}))},t.prototype.maybeResetQuery=function(){this.props.resetOnSelect&&this.setQuery("",!0)},t.displayName=DISPLAYNAME_PREFIX+".QueryList",t.defaultProps={disabled:!1,resetOnQuery:!0},t}(AbstractComponent2);export{QueryList};function pxToNumber(e){return null==e?0:parseInt(e.slice(0,-2),10)}function getMatchingItem(e,t){var i=t.items,r=t.itemPredicate;if(Utils.isFunction(r))for(var s=0;s<i.length;s++){var n=i[s];if(r(e,n,s,!0))return n}}function getFilteredItems(e,t){var i=t.items,r=t.itemPredicate,s=t.itemListPredicate;return Utils.isFunction(s)?s(e,i):Utils.isFunction(r)?i.filter((function(t,i){return r(e,t,i)})):i}function wrapNumber(e,t,i){return e<t?i:e>i?t:e}function isItemDisabled(e,t,i){return null!=i&&null!=e&&(Utils.isFunction(i)?i(e,t):!!e[i])}export function getFirstEnabledItem(e,t,i,r){if(void 0===i&&(i=1),void 0===r&&(r=e.length-1),0===e.length)return null;var s=r,n=e.length-1;do{if(!isItemDisabled(e[s=wrapNumber(s+i,0,n)],s,t))return e[s]}while(s!==r&&-1!==r);return null}