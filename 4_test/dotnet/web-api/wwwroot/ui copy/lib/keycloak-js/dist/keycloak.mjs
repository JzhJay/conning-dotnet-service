import e from"base64-js";import t from"js-sha256";if("undefined"==typeof Promise)throw Error("Keycloak requires an environment that supports Promises. Make sure that you include the appropriate polyfill.");var r=!1;function n(){r||(r=!0,console.warn("[KEYCLOAK] Usage of legacy style promise methods such as `.error()` and `.success()` has been deprecated and support will be removed in future versions. Use standard style promise methods such as `.then() and `.catch()` instead."))}function o(r){if(!(this instanceof o))return new o(r);for(var i,s,a=this,c=[],u={enable:!0,callbackList:[],interval:5},d=document.getElementsByTagName("script"),l=0;l<d.length;l++)-1===d[l].src.indexOf("keycloak.js")&&-1===d[l].src.indexOf("keycloak.min.js")||-1===d[l].src.indexOf("version=")||(a.iframeVersion=d[l].src.substring(d[l].src.indexOf("version=")+8).split("&")[0]);var f=!0,p=O(console.info),m=O(console.warn);function h(e,t){for(var r=function(e){var t=null,r=window.crypto||window.msCrypto;if(r&&r.getRandomValues&&window.Uint8Array)return t=new Uint8Array(e),r.getRandomValues(t),t;t=new Array(e);for(var n=0;n<t.length;n++)t[n]=Math.floor(256*Math.random());return t}(e),n=new Array(e),o=0;o<e;o++)n[o]=t.charCodeAt(r[o]%t.length);return String.fromCharCode.apply(null,n)}function k(){return void 0!==a.authServerUrl?"/"==a.authServerUrl.charAt(a.authServerUrl.length-1)?a.authServerUrl+"realms/"+encodeURIComponent(a.realm):a.authServerUrl+"/realms/"+encodeURIComponent(a.realm):void 0}function g(e,t){var r=e.code,n=e.error,o=e.prompt,i=(new Date).getTime();if(e.kc_action_status&&a.onActionUpdate&&a.onActionUpdate(e.kc_action_status),n)if("none"!=o){var s={error:n,error_description:e.error_description};a.onAuthError&&a.onAuthError(s),t&&t.setError(s)}else t&&t.setSuccess();else if("standard"!=a.flow&&(e.access_token||e.id_token)&&l(e.access_token,null,e.id_token,!0),"implicit"!=a.flow&&r){var c="code="+r+"&grant_type=authorization_code",u=a.endpoints.token(),d=new XMLHttpRequest;d.open("POST",u,!0),d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c+="&client_id="+encodeURIComponent(a.clientId),c+="&redirect_uri="+e.redirectUri,e.pkceCodeVerifier&&(c+="&code_verifier="+e.pkceCodeVerifier),d.withCredentials=!0,d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var e=JSON.parse(d.responseText);l(e.access_token,e.refresh_token,e.id_token,"standard"===a.flow),I()}else a.onAuthError&&a.onAuthError(),t&&t.setError()},d.send(c)}function l(r,n,o,s){w(r,n,o,i=(i+(new Date).getTime())/2),f&&(a.tokenParsed&&a.tokenParsed.nonce!=e.storedNonce||a.refreshTokenParsed&&a.refreshTokenParsed.nonce!=e.storedNonce||a.idTokenParsed&&a.idTokenParsed.nonce!=e.storedNonce)?(p("[KEYCLOAK] Invalid nonce, clearing token"),a.clearToken(),t&&t.setError()):s&&(a.onAuthSuccess&&a.onAuthSuccess(),t&&t.setSuccess())}}function v(e){return 0==e.status&&e.responseText&&e.responseURL.startsWith("file:")}function w(e,t,r,n){if(a.tokenTimeoutHandle&&(clearTimeout(a.tokenTimeoutHandle),a.tokenTimeoutHandle=null),t?(a.refreshToken=t,a.refreshTokenParsed=b(t)):(delete a.refreshToken,delete a.refreshTokenParsed),r?(a.idToken=r,a.idTokenParsed=b(r)):(delete a.idToken,delete a.idTokenParsed),e){if(a.token=e,a.tokenParsed=b(e),a.sessionId=a.tokenParsed.session_state,a.authenticated=!0,a.subject=a.tokenParsed.sub,a.realmAccess=a.tokenParsed.realm_access,a.resourceAccess=a.tokenParsed.resource_access,n&&(a.timeSkew=Math.floor(n/1e3)-a.tokenParsed.iat),null!=a.timeSkew&&(p("[KEYCLOAK] Estimated time difference between browser and server is "+a.timeSkew+" seconds"),a.onTokenExpired)){var o=1e3*(a.tokenParsed.exp-(new Date).getTime()/1e3+a.timeSkew);p("[KEYCLOAK] Token expires in "+Math.round(o/1e3)+" s"),o<=0?a.onTokenExpired():a.tokenTimeoutHandle=setTimeout(a.onTokenExpired,o)}}else delete a.token,delete a.tokenParsed,delete a.subject,delete a.realmAccess,delete a.resourceAccess,a.authenticated=!1}function b(e){switch((e=(e=(e=e.split(".")[1]).replace(/-/g,"+")).replace(/_/g,"/")).length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Invalid token"}return e=decodeURIComponent(escape(atob(e))),JSON.parse(e)}function y(){var e="0123456789abcdef",t=h(36,e).split("");return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}function S(e){var t=function(e){var t;switch(a.flow){case"standard":t=["code","state","session_state","kc_action_status"];break;case"implicit":t=["access_token","token_type","id_token","state","session_state","expires_in","kc_action_status"];break;case"hybrid":t=["access_token","token_type","id_token","code","state","session_state","expires_in","kc_action_status"]}t.push("error"),t.push("error_description"),t.push("error_uri");var r,n,o=e.indexOf("?"),i=e.indexOf("#");if("query"===a.responseMode&&-1!==o?(r=e.substring(0,o),""!==(n=U(e.substring(o+1,-1!==i?i:e.length),t)).paramsString&&(r+="?"+n.paramsString),-1!==i&&(r+=e.substring(i))):"fragment"===a.responseMode&&-1!==i&&(r=e.substring(0,i),""!==(n=U(e.substring(i+1),t)).paramsString&&(r+="#"+n.paramsString)),n&&n.oauthParams)if("standard"===a.flow||"hybrid"===a.flow){if((n.oauthParams.code||n.oauthParams.error)&&n.oauthParams.state)return n.oauthParams.newUrl=r,n.oauthParams}else if("implicit"===a.flow&&(n.oauthParams.access_token||n.oauthParams.error)&&n.oauthParams.state)return n.oauthParams.newUrl=r,n.oauthParams}(e);if(t){var r=s.get(t.state);return r&&(t.valid=!0,t.redirectUri=r.redirectUri,t.storedNonce=r.nonce,t.prompt=r.prompt,t.pkceCodeVerifier=r.pkceCodeVerifier),t}}function U(e,t){for(var r=e.split("&"),n={paramsString:"",oauthParams:{}},o=0;o<r.length;o++){var i=r[o].indexOf("="),s=r[o].slice(0,i);-1!==t.indexOf(s)?n.oauthParams[s]=r[o].slice(i+1):(""!==n.paramsString&&(n.paramsString+="&"),n.paramsString+=r[o])}return n}function _(){var e={setSuccess:function(t){e.resolve(t)},setError:function(t){e.reject(t)}};return e.promise=new Promise((function(t,r){e.resolve=t,e.reject=r})),e.promise.success=function(e){return n(),this.then((function(t){e(t)})),this},e.promise.error=function(e){return n(),this.catch((function(t){e(t)})),this},e}function T(){var e=_();if(!u.enable)return e.setSuccess(),e.promise;if(u.iframe)return e.setSuccess(),e.promise;var t=document.createElement("iframe");u.iframe=t,t.onload=function(){var t=a.endpoints.authorize();"/"===t.charAt(0)?u.iframeOrigin=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""):u.iframeOrigin=t.substring(0,t.indexOf("/",8)),e.setSuccess()};var r=a.endpoints.checkSessionIframe();return t.setAttribute("src",r),t.setAttribute("title","keycloak-session-iframe"),t.style.display="none",document.body.appendChild(t),window.addEventListener("message",(function(e){if(e.origin===u.iframeOrigin&&u.iframe.contentWindow===e.source&&("unchanged"==e.data||"changed"==e.data||"error"==e.data)){"unchanged"!=e.data&&a.clearToken();for(var t=u.callbackList.splice(0,u.callbackList.length),r=t.length-1;r>=0;--r){var n=t[r];"error"==e.data?n.setError():n.setSuccess("unchanged"==e.data)}}}),!1),e.promise}function I(){u.enable&&a.token&&setTimeout((function(){C().then((function(e){e&&I()}))}),1e3*u.interval)}function C(){var e=_();if(u.iframe&&u.iframeOrigin){var t=a.clientId+" "+(a.sessionId?a.sessionId:"");u.callbackList.push(e);var r=u.iframeOrigin;1==u.callbackList.length&&u.iframe.contentWindow.postMessage(t,r)}else e.setSuccess();return e.promise}function R(){var e=_();if(u.enable||a.silentCheckSsoRedirectUri){var t=document.createElement("iframe");t.setAttribute("src",a.endpoints.thirdPartyCookiesIframe()),t.setAttribute("title","keycloak-3p-check-iframe"),t.style.display="none",document.body.appendChild(t);var r=function(n){t.contentWindow===n.source&&("supported"!==n.data&&"unsupported"!==n.data||("unsupported"===n.data&&(u.enable=!1,a.silentCheckSsoFallback&&(a.silentCheckSsoRedirectUri=!1),m("[KEYCLOAK] 3rd party cookies aren't supported by this browser. checkLoginIframe and silent check-sso are not available.")),document.body.removeChild(t),window.removeEventListener("message",r),e.setSuccess()))};window.addEventListener("message",r,!1)}else e.setSuccess();return function(e,t,r){var n=null,o=new Promise((function(e,r){n=setTimeout((function(){r({error:"Timeout when waiting for 3rd party check iframe message."})}),t)}));return Promise.race([e,o]).finally((function(){clearTimeout(n)}))}(e.promise,a.messageReceiveTimeout)}function E(e){if(!e||"default"==e)return{login:function(e){return window.location.replace(a.createLoginUrl(e)),_().promise},logout:function(e){return window.location.replace(a.createLogoutUrl(e)),_().promise},register:function(e){return window.location.replace(a.createRegisterUrl(e)),_().promise},accountManagement:function(){var e=a.createAccountUrl();if(void 0===e)throw"Not supported by the OIDC server";return window.location.href=e,_().promise},redirectUri:function(e,t){return e&&e.redirectUri?e.redirectUri:a.redirectUri?a.redirectUri:location.href}};if("cordova"==e){u.enable=!1;var t=function(e,t,r){return window.cordova&&window.cordova.InAppBrowser?window.cordova.InAppBrowser.open(e,t,r):window.open(e,t,r)},r=function(e){var t=function(e){return e&&e.cordovaOptions?Object.keys(e.cordovaOptions).reduce((function(t,r){return t[r]=e.cordovaOptions[r],t}),{}):{}}(e);return t.location="no",e&&"none"==e.prompt&&(t.hidden="yes"),function(e){return Object.keys(e).reduce((function(t,r){return t.push(r+"="+e[r]),t}),[]).join(",")}(t)},n=a.redirectUri||"http://localhost";return{login:function(e){var o=_(),i=r(e),s=a.createLoginUrl(e),c=t(s,"_blank",i),u=!1,d=!1,l=function(){d=!0,c.close()};return c.addEventListener("loadstart",(function(e){0==e.url.indexOf(n)&&(g(S(e.url),o),l(),u=!0)})),c.addEventListener("loaderror",(function(e){u||(0==e.url.indexOf(n)?(g(S(e.url),o),l(),u=!0):(o.setError(),l()))})),c.addEventListener("exit",(function(e){d||o.setError({reason:"closed_by_user"})})),o.promise},logout:function(e){var r,o=_(),i=a.createLogoutUrl(e),s=t(i,"_blank","location=no,hidden=yes,clearcache=yes");return s.addEventListener("loadstart",(function(e){0==e.url.indexOf(n)&&s.close()})),s.addEventListener("loaderror",(function(e){0==e.url.indexOf(n)||(r=!0),s.close()})),s.addEventListener("exit",(function(e){r?o.setError():(a.clearToken(),o.setSuccess())})),o.promise},register:function(e){var o=_(),i=a.createRegisterUrl(),s=r(e),c=t(i,"_blank",s);return c.addEventListener("loadstart",(function(e){0==e.url.indexOf(n)&&(c.close(),g(S(e.url),o))})),o.promise},accountManagement:function(){var e=a.createAccountUrl();if(void 0===e)throw"Not supported by the OIDC server";var r=t(e,"_blank","location=no");r.addEventListener("loadstart",(function(e){0==e.url.indexOf(n)&&r.close()}))},redirectUri:function(e){return n}}}if("cordova-native"==e)return u.enable=!1,{login:function(e){var t=_(),r=a.createLoginUrl(e);return universalLinks.subscribe("keycloak",(function(e){universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close(),g(S(e.url),t)})),window.cordova.plugins.browsertab.openUrl(r),t.promise},logout:function(e){var t=_(),r=a.createLogoutUrl(e);return universalLinks.subscribe("keycloak",(function(e){universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close(),a.clearToken(),t.setSuccess()})),window.cordova.plugins.browsertab.openUrl(r),t.promise},register:function(e){var t=_(),r=a.createRegisterUrl(e);return universalLinks.subscribe("keycloak",(function(e){universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close(),g(S(e.url),t)})),window.cordova.plugins.browsertab.openUrl(r),t.promise},accountManagement:function(){var e=a.createAccountUrl();if(void 0===e)throw"Not supported by the OIDC server";window.cordova.plugins.browsertab.openUrl(e)},redirectUri:function(e){return e&&e.redirectUri?e.redirectUri:a.redirectUri?a.redirectUri:"http://localhost"}};throw"invalid adapter type: "+e}a.init=function(e){if(a.authenticated=!1,s=function(){try{return new L}catch(e){}return new A}(),i=e&&["default","cordova","cordova-native"].indexOf(e.adapter)>-1?E(e.adapter):e&&"object"==typeof e.adapter?e.adapter:window.Cordova||window.cordova?E("cordova"):E(),e){if(void 0!==e.useNonce&&(f=e.useNonce),void 0!==e.checkLoginIframe&&(u.enable=e.checkLoginIframe),e.checkLoginIframeInterval&&(u.interval=e.checkLoginIframeInterval),"login-required"===e.onLoad&&(a.loginRequired=!0),e.responseMode){if("query"!==e.responseMode&&"fragment"!==e.responseMode)throw"Invalid value for responseMode";a.responseMode=e.responseMode}if(e.flow){switch(e.flow){case"standard":a.responseType="code";break;case"implicit":a.responseType="id_token token";break;case"hybrid":a.responseType="code id_token token";break;default:throw"Invalid value for flow"}a.flow=e.flow}if(null!=e.timeSkew&&(a.timeSkew=e.timeSkew),e.redirectUri&&(a.redirectUri=e.redirectUri),e.silentCheckSsoRedirectUri&&(a.silentCheckSsoRedirectUri=e.silentCheckSsoRedirectUri),"boolean"==typeof e.silentCheckSsoFallback?a.silentCheckSsoFallback=e.silentCheckSsoFallback:a.silentCheckSsoFallback=!0,e.pkceMethod){if("S256"!==e.pkceMethod)throw"Invalid value for pkceMethod";a.pkceMethod=e.pkceMethod}"boolean"==typeof e.enableLogging?a.enableLogging=e.enableLogging:a.enableLogging=!1,"string"==typeof e.scope&&(a.scope=e.scope),"number"==typeof e.messageReceiveTimeout&&e.messageReceiveTimeout>0?a.messageReceiveTimeout=e.messageReceiveTimeout:a.messageReceiveTimeout=1e4}a.responseMode||(a.responseMode="fragment"),a.responseType||(a.responseType="code",a.flow="standard");var t=_(),n=_();n.promise.then((function(){a.onReady&&a.onReady(a.authenticated),t.setSuccess(a.authenticated)})).catch((function(e){t.setError(e)}));var o=function(e){var t,n=_();function o(e){a.endpoints=e?{authorize:function(){return e.authorization_endpoint},token:function(){return e.token_endpoint},logout:function(){if(!e.end_session_endpoint)throw"Not supported by the OIDC server";return e.end_session_endpoint},checkSessionIframe:function(){if(!e.check_session_iframe)throw"Not supported by the OIDC server";return e.check_session_iframe},register:function(){throw'Redirection to "Register user" page not supported in standard OIDC mode'},userinfo:function(){if(!e.userinfo_endpoint)throw"Not supported by the OIDC server";return e.userinfo_endpoint}}:{authorize:function(){return k()+"/protocol/openid-connect/auth"},token:function(){return k()+"/protocol/openid-connect/token"},logout:function(){return k()+"/protocol/openid-connect/logout"},checkSessionIframe:function(){var e=k()+"/protocol/openid-connect/login-status-iframe.html";return a.iframeVersion&&(e=e+"?version="+a.iframeVersion),e},thirdPartyCookiesIframe:function(){var e=k()+"/protocol/openid-connect/3p-cookies/step1.html";return a.iframeVersion&&(e=e+"?version="+a.iframeVersion),e},register:function(){return k()+"/protocol/openid-connect/registrations"},userinfo:function(){return k()+"/protocol/openid-connect/userinfo"}}}if(r?"string"==typeof r&&(t=r):t="keycloak.json",t)(c=new XMLHttpRequest).open("GET",t,!0),c.setRequestHeader("Accept","application/json"),c.onreadystatechange=function(){if(4==c.readyState)if(200==c.status||v(c)){var e=JSON.parse(c.responseText);a.authServerUrl=e["auth-server-url"],a.realm=e.realm,a.clientId=e.resource,o(null),n.setSuccess()}else n.setError()},c.send();else{if(!r.clientId)throw"clientId missing";a.clientId=r.clientId;var i=r.oidcProvider;if(i){var s,c;"string"==typeof i?(s="/"==i.charAt(i.length-1)?i+".well-known/openid-configuration":i+"/.well-known/openid-configuration",(c=new XMLHttpRequest).open("GET",s,!0),c.setRequestHeader("Accept","application/json"),c.onreadystatechange=function(){4==c.readyState&&(200==c.status||v(c)?(o(JSON.parse(c.responseText)),n.setSuccess()):n.setError())},c.send()):(o(i),n.setSuccess())}else{if(!r.url)for(var u=document.getElementsByTagName("script"),d=0;d<u.length;d++)if(u[d].src.match(/.*keycloak\.js/)){r.url=u[d].src.substr(0,u[d].src.indexOf("/js/keycloak.js"));break}if(!r.realm)throw"realm missing";a.authServerUrl=r.url,a.realm=r.realm,o(null),n.setSuccess()}}return n.promise}();function c(){var t=function(e){e||(o.prompt="none"),a.login(o).then((function(){n.setSuccess()})).catch((function(e){n.setError(e)}))},r=function(){var e=document.createElement("iframe"),t=a.createLoginUrl({prompt:"none",redirectUri:a.silentCheckSsoRedirectUri});e.setAttribute("src",t),e.setAttribute("title","keycloak-silent-check-sso"),e.style.display="none",document.body.appendChild(e);var r=function(t){t.origin===window.location.origin&&e.contentWindow===t.source&&(g(S(t.data),n),document.body.removeChild(e),window.removeEventListener("message",r))};window.addEventListener("message",r)},o={};switch(e.onLoad){case"check-sso":u.enable?T().then((function(){C().then((function(e){e?n.setSuccess():a.silentCheckSsoRedirectUri?r():t(!1)})).catch((function(e){n.setError(e)}))})):a.silentCheckSsoRedirectUri?r():t(!1);break;case"login-required":t(!0);break;default:throw"Invalid value for onLoad"}}function d(){var t=S(window.location.href);if(t&&window.history.replaceState(window.history.state,null,t.newUrl),t&&t.valid)return T().then((function(){g(t,n)})).catch((function(e){n.setError(e)}));e?e.token&&e.refreshToken?(w(e.token,e.refreshToken,e.idToken),u.enable?T().then((function(){C().then((function(e){e?(a.onAuthSuccess&&a.onAuthSuccess(),n.setSuccess(),I()):n.setSuccess()})).catch((function(e){n.setError(e)}))})):a.updateToken(-1).then((function(){a.onAuthSuccess&&a.onAuthSuccess(),n.setSuccess()})).catch((function(t){a.onAuthError&&a.onAuthError(),e.onLoad?c():n.setError(t)}))):e.onLoad?c():n.setSuccess():n.setSuccess()}return o.then((function(){(function(){var e=_(),t=function(){"interactive"!==document.readyState&&"complete"!==document.readyState||(document.removeEventListener("readystatechange",t),e.setSuccess())};return document.addEventListener("readystatechange",t),t(),e.promise})().then(R).then(d).catch((function(e){t.setError(e)}))})),o.catch((function(e){t.setError(e)})),t.promise},a.login=function(e){return i.login(e)},a.createLoginUrl=function(r){var n,o=y(),c=y(),u=i.redirectUri(r),d={state:o,nonce:c,redirectUri:encodeURIComponent(u)};r&&r.prompt&&(d.prompt=r.prompt),n=r&&"register"==r.action?a.endpoints.register():a.endpoints.authorize();var l=r&&r.scope||a.scope;l?-1===l.indexOf("openid")&&(l="openid "+l):l="openid";var p,m=n+"?client_id="+encodeURIComponent(a.clientId)+"&redirect_uri="+encodeURIComponent(u)+"&state="+encodeURIComponent(o)+"&response_mode="+encodeURIComponent(a.responseMode)+"&response_type="+encodeURIComponent(a.responseType)+"&scope="+encodeURIComponent(l);if(f&&(m=m+"&nonce="+encodeURIComponent(c)),r&&r.prompt&&(m+="&prompt="+encodeURIComponent(r.prompt)),r&&r.maxAge&&(m+="&max_age="+encodeURIComponent(r.maxAge)),r&&r.loginHint&&(m+="&login_hint="+encodeURIComponent(r.loginHint)),r&&r.idpHint&&(m+="&kc_idp_hint="+encodeURIComponent(r.idpHint)),r&&r.action&&"register"!=r.action&&(m+="&kc_action="+encodeURIComponent(r.action)),r&&r.locale&&(m+="&ui_locales="+encodeURIComponent(r.locale)),r&&r.acr){var k=(p={id_token:{acr:r.acr}},JSON.stringify(p));m+="&claims="+encodeURIComponent(k)}if(a.pkceMethod){var g=h(96,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");d.pkceCodeVerifier=g;var v=function(r,n){if("S256"===r){var o=new Uint8Array(t.arrayBuffer(n));return e.fromByteArray(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}throw"Invalid value for pkceMethod"}(a.pkceMethod,g);m+="&code_challenge="+v,m+="&code_challenge_method="+a.pkceMethod}return s.add(d),m},a.logout=function(e){return i.logout(e)},a.createLogoutUrl=function(e){var t=a.endpoints.logout()+"?client_id="+encodeURIComponent(a.clientId)+"&post_logout_redirect_uri="+encodeURIComponent(i.redirectUri(e,!1));return a.idToken&&(t+="&id_token_hint="+encodeURIComponent(a.idToken)),t},a.register=function(e){return i.register(e)},a.createRegisterUrl=function(e){return e||(e={}),e.action="register",a.createLoginUrl(e)},a.createAccountUrl=function(e){var t=k(),r=void 0;return void 0!==t&&(r=t+"/account?referrer="+encodeURIComponent(a.clientId)+"&referrer_uri="+encodeURIComponent(i.redirectUri(e))),r},a.accountManagement=function(){return i.accountManagement()},a.hasRealmRole=function(e){var t=a.realmAccess;return!!t&&t.roles.indexOf(e)>=0},a.hasResourceRole=function(e,t){if(!a.resourceAccess)return!1;var r=a.resourceAccess[t||a.clientId];return!!r&&r.roles.indexOf(e)>=0},a.loadUserProfile=function(){var e=k()+"/account",t=new XMLHttpRequest;t.open("GET",e,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Authorization","bearer "+a.token);var r=_();return t.onreadystatechange=function(){4==t.readyState&&(200==t.status?(a.profile=JSON.parse(t.responseText),r.setSuccess(a.profile)):r.setError())},t.send(),r.promise},a.loadUserInfo=function(){var e=a.endpoints.userinfo(),t=new XMLHttpRequest;t.open("GET",e,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Authorization","bearer "+a.token);var r=_();return t.onreadystatechange=function(){4==t.readyState&&(200==t.status?(a.userInfo=JSON.parse(t.responseText),r.setSuccess(a.userInfo)):r.setError())},t.send(),r.promise},a.isTokenExpired=function(e){if(!a.tokenParsed||!a.refreshToken&&"implicit"!=a.flow)throw"Not authenticated";if(null==a.timeSkew)return p("[KEYCLOAK] Unable to determine if token is expired as timeskew is not set"),!0;var t=a.tokenParsed.exp-Math.ceil((new Date).getTime()/1e3)+a.timeSkew;if(e){if(isNaN(e))throw"Invalid minValidity";t-=e}return t<0},a.updateToken=function(e){var t=_();if(!a.refreshToken)return t.setError(),t.promise;e=e||5;var r=function(){var r=!1;if(-1==e?(r=!0,p("[KEYCLOAK] Refreshing token: forced refresh")):a.tokenParsed&&!a.isTokenExpired(e)||(r=!0,p("[KEYCLOAK] Refreshing token: token expired")),r){var n="grant_type=refresh_token&refresh_token="+a.refreshToken,o=a.endpoints.token();if(c.push(t),1==c.length){var i=new XMLHttpRequest;i.open("POST",o,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.withCredentials=!0,n+="&client_id="+encodeURIComponent(a.clientId);var s=(new Date).getTime();i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){p("[KEYCLOAK] Token refreshed"),s=(s+(new Date).getTime())/2;var e=JSON.parse(i.responseText);w(e.access_token,e.refresh_token,e.id_token,s),a.onAuthRefreshSuccess&&a.onAuthRefreshSuccess();for(var t=c.pop();null!=t;t=c.pop())t.setSuccess(!0)}else for(m("[KEYCLOAK] Failed to refresh token"),400==i.status&&a.clearToken(),a.onAuthRefreshError&&a.onAuthRefreshError(),t=c.pop();null!=t;t=c.pop())t.setError(!0)},i.send(n)}}else t.setSuccess(!1)};return u.enable?C().then((function(){r()})).catch((function(e){t.setError(e)})):r(),t.promise},a.clearToken=function(){a.token&&(w(null,null,null),a.onAuthLogout&&a.onAuthLogout(),a.loginRequired&&a.login())};var L=function(){if(!(this instanceof L))return new L;function e(){for(var e=(new Date).getTime(),t=0;t<localStorage.length;t++){var r=localStorage.key(t);if(r&&0==r.indexOf("kc-callback-")){var n=localStorage.getItem(r);if(n)try{var o=JSON.parse(n).expires;(!o||o<e)&&localStorage.removeItem(r)}catch(e){localStorage.removeItem(r)}}}}localStorage.setItem("kc-test","test"),localStorage.removeItem("kc-test"),this.get=function(t){if(t){var r="kc-callback-"+t,n=localStorage.getItem(r);return n&&(localStorage.removeItem(r),n=JSON.parse(n)),e(),n}},this.add=function(t){e();var r="kc-callback-"+t.state;t.expires=(new Date).getTime()+36e5,localStorage.setItem(r,JSON.stringify(t))}},A=function(){if(!(this instanceof A))return new A;var e=this;e.get=function(e){if(e){var o=r("kc-callback-"+e);return n("kc-callback-"+e,"",t(-100)),o?JSON.parse(o):void 0}},e.add=function(e){n("kc-callback-"+e.state,JSON.stringify(e),t(60))},e.removeItem=function(e){n(e,"",t(-100))};var t=function(e){var t=new Date;return t.setTime(t.getTime()+60*e*1e3),t},r=function(e){for(var t=e+"=",r=document.cookie.split(";"),n=0;n<r.length;n++){for(var o=r[n];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return""},n=function(e,t,r){var n=e+"="+t+"; expires="+r.toUTCString()+"; ";document.cookie=n}};function O(e){return function(){a.enableLogging&&e.apply(console,Array.prototype.slice.call(arguments))}}}export{o as default};